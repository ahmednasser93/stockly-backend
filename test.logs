
> stockly-api@0.0.0 test
> vitest run


 RUN  v3.2.4 /home/sngvahmed/workspace/stockly/api

Using vars defined in .dev.vars
[vpw:info] Starting isolated runtimes for vitest.config.mts...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
stdout | test/logging/loki-shipper.spec.ts > Loki Shipper > sendLogsToLoki > should ship logs successfully
[Loki Shipper] Successfully shipped 2 log entries

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > getCachedState > should return cached state
[KV Cache] Queued state update for alert alert-1 (1 pending writes)

stdout | test/logging/loki-shipper.spec.ts > Loki Shipper > sendLogsToLoki > should format timestamps as nanoseconds
[Loki Shipper] Successfully shipped 2 log entries

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > get > should log HIT when value exists (text)
{"timestamp":"2025-12-14T19:16:19.251Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV get: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"HIT"}

stdout | test/logging/logger.spec.ts > Logger > debug > should create debug log entry
{"timestamp":"2025-12-14T19:16:19.246Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"Debug message","type":"general","extra":"data"}

stdout | test/logging/loki-shipper.spec.ts > Loki Shipper > sendLogsToLoki > should handle URL with trailing slash
[Loki Shipper] Successfully shipped 2 log entries

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > get > should log MISS when value is null (text)
{"timestamp":"2025-12-14T19:16:19.284Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV get: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":1,"cacheStatus":"MISS"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > updateStateInCache > should update state in cache
[KV Cache] Queued state update for alert alert-1 (1 pending writes)

stdout | test/logging/d1-wrapper.spec.ts > LoggedD1Database > exec > should log successful exec operation
{"timestamp":"2025-12-14T19:16:19.297Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"D1 exec: SELECT * FROM alerts","type":"data_operation","operation":"d1","query":"SELECT * FROM alerts","latencyMs":0,"cacheStatus":"N/A"}

stdout | test/logging/loki-shipper.spec.ts > Loki Shipper > sendLogsToLoki > should include Basic Auth when credentials provided
[Loki Shipper] Successfully shipped 2 log entries

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > User Symbol Collection > should collect unique symbols from all users
{"timestamp":"2025-12-14T19:16:19.325Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779325","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/logging/d1-wrapper.spec.ts > LoggedD1Database > exec > should log failed exec operation
{"timestamp":"2025-12-14T19:16:19.336Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"D1 exec failed: SELECT * FROM alerts","type":"data_operation","operation":"d1","query":"SELECT * FROM alerts","latencyMs":1,"cacheStatus":"N/A","error":"Database error"}

 ✓ test/cache.spec.ts (2 tests) 166ms
 ✓ test/util.spec.ts (2 tests) 161ms
stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > User Symbol Collection > should collect unique symbols from all users
{"timestamp":"2025-12-14T19:16:19.327Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779325","userId":null,"path":"/cron/news-alerts","message":"Checking news for 4 unique symbols: LXEO, AMZN, AAPL, BABA","type":"general"}
{"timestamp":"2025-12-14T19:16:19.327Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779325","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > updateStateInCache > should queue state for KV write
[KV Cache] Queued state update for alert alert-1 (1 pending writes)

stdout | test/logging/logger.spec.ts > Logger > info > should create info log entry
{"timestamp":"2025-12-14T19:16:19.343Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"Info message","type":"general","action":"test"}

 ✓ test/alerts-evaluate.spec.ts (3 tests) 199ms
stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > get > should log HIT when value exists (json)
{"timestamp":"2025-12-14T19:16:19.352Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV get: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"HIT"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > User Symbol Collection > should collect unique symbols from all users
{"timestamp":"2025-12-14T19:16:19.327Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779325","userId":null,"path":"/cron/news-alerts","message":"Fetched 0 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:16:19.327Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779325","userId":null,"path":"/cron/news-alerts","message":"Found news for 0 symbols: ","type":"general"}
{"timestamp":"2025-12-14T19:16:19.327Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779325","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stdout | test/logging/loki-shipper.spec.ts > Loki Shipper > sendLogsToLoki > should not include Auth when credentials not provided
[Loki Shipper] Successfully shipped 2 log entries

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > User Symbol Collection > should normalize symbols to uppercase
{"timestamp":"2025-12-14T19:16:19.359Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779359","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/alerts-storage.spec.ts > alerts storage queries > creates and returns an alert
Creating alert with username: testuser, symbol: AAPL

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > get > should log MISS when value is null (json)
{"timestamp":"2025-12-14T19:16:19.384Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV get: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"MISS"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > User Symbol Collection > should normalize symbols to uppercase
{"timestamp":"2025-12-14T19:16:19.359Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779359","userId":null,"path":"/cron/news-alerts","message":"Checking news for 2 unique symbols: LXEO, AMZN","type":"general"}
{"timestamp":"2025-12-14T19:16:19.359Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779359","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/alerts-storage.spec.ts > alerts storage queries > creates and returns an alert
Alert created successfully: id=generated-id, username=testuser, symbol=AAPL

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > User Symbol Collection > should normalize symbols to uppercase
{"timestamp":"2025-12-14T19:16:19.359Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779359","userId":null,"path":"/cron/news-alerts","message":"Fetched 0 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:16:19.359Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779359","userId":null,"path":"/cron/news-alerts","message":"Found news for 0 symbols: ","type":"general"}
{"timestamp":"2025-12-14T19:16:19.359Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779359","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stdout | test/logging/loki-shipper.spec.ts > Loki Shipper > sendLogsToLoki > should include custom labels
[Loki Shipper] Successfully shipped 2 log entries

stdout | test/get-stock-details.spec.ts > getStockDetails service > returns cached data when available and valid
Cache hit for stock details: AAPL

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > get > should handle arrayBuffer type
{"timestamp":"2025-12-14T19:16:19.418Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV get: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"HIT"}

stdout | test/logging/d1-wrapper.spec.ts > LoggedD1Database > batch > should log successful batch operation
{"timestamp":"2025-12-14T19:16:19.432Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"D1 batch: BATCH(2 statements)","type":"data_operation","operation":"d1","query":"BATCH(2 statements)","latencyMs":0,"cacheStatus":"N/A"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should load states from KV
[KV Cache] Loading 2 alert states from KV...

 ✓ test/alerts-validation.spec.ts (4 tests) 230ms
stdout | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should load states from KV
[KV Cache] Loaded 2 states from KV

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > User Symbol Collection > should skip users with no favorite symbols
{"timestamp":"2025-12-14T19:16:19.461Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779461","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/get-stock-details.spec.ts > getStockDetails service > fetches all data from FMP API when cache misses
Cache miss for stock details: AAPL, fetching...

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should cache loaded states in memory
[KV Cache] Loading 1 alert states from KV...

stdout | test/logging/d1-wrapper.spec.ts > LoggedD1Database > batch > should log failed batch operation
{"timestamp":"2025-12-14T19:16:19.473Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"D1 batch failed: BATCH(2 statements)","type":"data_operation","operation":"d1","query":"BATCH(2 statements)","latencyMs":0,"cacheStatus":"N/A","error":"Batch failed"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > User Symbol Collection > should skip users with no favorite symbols
{"timestamp":"2025-12-14T19:16:19.461Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779461","userId":null,"path":"/cron/news-alerts","message":"Checking news for 1 unique symbols: LXEO","type":"general"}
{"timestamp":"2025-12-14T19:16:19.461Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779461","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > get > should handle stream type
{"timestamp":"2025-12-14T19:16:19.491Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV get: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"HIT"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should cache loaded states in memory
[KV Cache] Loaded 1 states from KV

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > User Symbol Collection > should skip users with no favorite symbols
{"timestamp":"2025-12-14T19:16:19.462Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779461","userId":null,"path":"/cron/news-alerts","message":"Fetched 0 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:16:19.462Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779461","userId":null,"path":"/cron/news-alerts","message":"Found news for 0 symbols: ","type":"general"}
{"timestamp":"2025-12-14T19:16:19.462Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779461","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stdout | test/get-stock-details.spec.ts > getStockDetails service > handles partial data failures gracefully
Cache miss for stock details: AAPL, fetching...

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should return cached data if cache is fresh
[KV Cache] Loading 1 alert states from KV...

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > get > should log failed get operation
{"timestamp":"2025-12-14T19:16:19.559Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV get failed: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"N/A","error":"KV error"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should return cached data if cache is fresh
[KV Cache] Loaded 1 states from KV

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should handle missing states
[KV Cache] Loading 2 alert states from KV...

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should handle missing states
[KV Cache] Loaded 1 states from KV

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > get > should measure latency
{"timestamp":"2025-12-14T19:16:19.609Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV get: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":10,"cacheStatus":"HIT"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should fetch news for all symbols in one batch call
{"timestamp":"2025-12-14T19:16:19.630Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779630","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should fetch news for all symbols in one batch call
{"timestamp":"2025-12-14T19:16:19.631Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779630","userId":null,"path":"/cron/news-alerts","message":"Checking news for 3 unique symbols: LXEO, AMZN, AAPL","type":"general"}
{"timestamp":"2025-12-14T19:16:19.631Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779630","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should fetch news for all symbols in one batch call
{"timestamp":"2025-12-14T19:16:19.631Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779630","userId":null,"path":"/cron/news-alerts","message":"Fetched 2 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:16:19.631Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779630","userId":null,"path":"/cron/news-alerts","message":"Found news for 2 symbols: LXEO, AMZN","type":"general"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should handle invalid JSON
[KV Cache] Loading 1 alert states from KV...

stdout | test/alerts-storage.spec.ts > alerts state KV > reads and writes state snapshots
[KV Cache] Queued state update for alert 1 (1 pending writes)

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should fetch news for all symbols in one batch call
{"timestamp":"2025-12-14T19:16:19.631Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779630","userId":null,"path":"/cron/news-alerts","message":"New article found (published today)","type":"general","symbol":"LXEO","title":"LXEO News Today","publishedDate":"2025-12-14T10:00:00Z"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should fetch news for all symbols in one batch call
{"timestamp":"2025-12-14T19:16:19.631Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779630","userId":null,"path":"/cron/news-alerts","message":"Found 1 users with LXEO in favorites: user1","type":"general"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should handle invalid JSON
[KV Cache] Loaded 0 states from KV

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > put > should log successful put operation
{"timestamp":"2025-12-14T19:16:19.699Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV put: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"N/A"}

stdout | test/alerts-storage.spec.ts > alerts state KV > deletes state
[KV Cache] Queued state update for alert 1 (1 pending writes)

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should fetch news for all symbols in one batch call
{"timestamp":"2025-12-14T19:16:19.632Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779630","userId":null,"path":"/cron/news-alerts","message":"Sent 2 notifications for LXEO news to 1 users","type":"general"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should handle KV read errors
[KV Cache] Loading 1 alert states from KV...

stdout | test/logging/loki-shipper.spec.ts > Loki Shipper > sendLogsToLoki > should format logs correctly with all log types
[Loki Shipper] Successfully shipped 3 log entries

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should fetch news for all symbols in one batch call
{"timestamp":"2025-12-14T19:16:19.632Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779630","userId":null,"path":"/cron/news-alerts","message":"New article found (published today)","type":"general","symbol":"AMZN","title":"AMZN News Today","publishedDate":"2025-12-14T11:00:00Z"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should fetch news for all symbols in one batch call
{"timestamp":"2025-12-14T19:16:19.632Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779630","userId":null,"path":"/cron/news-alerts","message":"Found 1 users with AMZN in favorites: user1","type":"general"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should handle KV read errors
[KV Cache] Loaded 0 states from KV

stdout | test/logging/logger.spec.ts > Logger > logApiCall > should create API call log entry
{"timestamp":"2025-12-14T19:16:19.750Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"API call made","type":"api_call","apiProvider":"FMP","endpoint":"/quote","method":"GET","statusCode":200,"latencyMs":150}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should fetch news for all symbols in one batch call
{"timestamp":"2025-12-14T19:16:19.632Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779630","userId":null,"path":"/cron/news-alerts","message":"Sent 2 notifications for AMZN news to 1 users","type":"general"}
{"timestamp":"2025-12-14T19:16:19.632Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779630","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stdout | test/logging/d1-wrapper.spec.ts > LoggedD1Database > LoggedD1PreparedStatement > first > should log successful first operation
{"timestamp":"2025-12-14T19:16:19.758Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"D1 first: SELECT * FROM alerts WHERE id = ?","type":"data_operation","operation":"d1","query":"SELECT * FROM alerts WHERE id = ?","latencyMs":0,"cacheStatus":"N/A"}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > put > should log put with expiration options
{"timestamp":"2025-12-14T19:16:19.767Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV put: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"N/A"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should only process news published today
{"timestamp":"2025-12-14T19:16:19.667Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779667","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

 ✓ test/notifications/jwt-helper.spec.ts (10 tests) 643ms
stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should only process news published today
{"timestamp":"2025-12-14T19:16:19.667Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779667","userId":null,"path":"/cron/news-alerts","message":"Checking news for 1 unique symbols: LXEO","type":"general"}
{"timestamp":"2025-12-14T19:16:19.667Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779667","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should only process news published today
{"timestamp":"2025-12-14T19:16:19.667Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779667","userId":null,"path":"/cron/news-alerts","message":"Fetched 2 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:16:19.667Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779667","userId":null,"path":"/cron/news-alerts","message":"Found news for 1 symbols: LXEO","type":"general"}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > put > should log failed put operation
{"timestamp":"2025-12-14T19:16:19.801Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV put failed: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"N/A","error":"Put failed"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should skip cron if no active alerts found
{"timestamp":"2025-12-14T19:16:19.801Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739779801","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should only process news published today
{"timestamp":"2025-12-14T19:16:19.667Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779667","userId":null,"path":"/cron/news-alerts","message":"New article found (published today)","type":"general","symbol":"LXEO","title":"LXEO News Today","publishedDate":"2025-12-14T10:00:00Z"}

stdout | test/logging/logger.spec.ts > Logger > logApiCall > should create API call log entry with partial options
{"timestamp":"2025-12-14T19:16:19.816Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"API call","type":"api_call","apiProvider":"FMP","latencyMs":100}

stdout | test/logging/d1-wrapper.spec.ts > LoggedD1Database > LoggedD1PreparedStatement > first > should log failed first operation
{"timestamp":"2025-12-14T19:16:19.817Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"D1 first failed: SELECT * FROM alerts WHERE id = ?","type":"data_operation","operation":"d1","query":"SELECT * FROM alerts WHERE id = ?","latencyMs":0,"cacheStatus":"N/A","error":"Query failed"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should skip cron if no active alerts found
{"timestamp":"2025-12-14T19:16:19.802Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739779801","userId":null,"path":"/cron/alerts","message":"No active alerts found","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should only process news published today
{"timestamp":"2025-12-14T19:16:19.667Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779667","userId":null,"path":"/cron/news-alerts","message":"Found 1 users with LXEO in favorites: user1","type":"general"}

 ✓ test/alerts-storage.spec.ts (7 tests) 496ms
stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should only process news published today
{"timestamp":"2025-12-14T19:16:19.668Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779667","userId":null,"path":"/cron/news-alerts","message":"Sent 1 notifications for LXEO news to 1 users","type":"general"}
{"timestamp":"2025-12-14T19:16:19.668Z","service":"stockly-api","level":"DEBUG","traceId":"cron-news-1765739779667","userId":null,"path":"/cron/news-alerts","message":"Skipping article not published today: LXEO News Yesterday (2025-12-13T10:00:00Z)","type":"general"}
{"timestamp":"2025-12-14T19:16:19.668Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779667","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > put > should handle ArrayBuffer value
{"timestamp":"2025-12-14T19:16:19.834Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV put: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"N/A"}

 ✓ test/logging/loki-shipper.spec.ts (12 tests) 679ms
stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should write pending states to KV
[KV Cache] Queued state update for alert alert-1 (1 pending writes)
[KV Cache] Flushing 1 pending writes to KV...

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should process alerts and send notifications
{"timestamp":"2025-12-14T19:16:19.861Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739779861","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should write pending states to KV
[KV Cache] Flushed 1/1 writes to KV

stdout | test/logging/logger.spec.ts > Logger > logDataOperation > should create D1 operation log entry
{"timestamp":"2025-12-14T19:16:19.874Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"D1 query executed","type":"data_operation","operation":"d1","query":"SELECT * FROM alerts","latencyMs":25,"cacheStatus":"N/A"}

stdout | test/logging/d1-wrapper.spec.ts > LoggedD1Database > LoggedD1PreparedStatement > all > should log successful all operation
{"timestamp":"2025-12-14T19:16:19.875Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"D1 all: SELECT * FROM alerts WHERE id = ?","type":"data_operation","operation":"d1","query":"SELECT * FROM alerts WHERE id = ?","latencyMs":0,"cacheStatus":"N/A"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should process alerts and send notifications
{"timestamp":"2025-12-14T19:16:19.861Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739779861","userId":null,"path":"/cron/alerts","message":"Processing 1 active alerts","type":"general"}
{"timestamp":"2025-12-14T19:16:19.861Z","service":"stockly-api","level":"DEBUG","traceId":"cron-1765739779861","userId":null,"path":"/cron/alerts","message":"Fetching prices for 1 unique symbols","type":"general","symbols":["AAPL"]}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should batch multiple writes
[KV Cache] Queued state update for alert alert-1 (1 pending writes)
[KV Cache] Queued state update for alert alert-2 (2 pending writes)
[KV Cache] Flushing 2 pending writes to KV...

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should process alerts and send notifications
{"timestamp":"2025-12-14T19:16:19.861Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739779861","userId":null,"path":"/cron/alerts","message":"Successfully fetched prices for 1 symbols","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should handle empty news response
{"timestamp":"2025-12-14T19:16:19.882Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779882","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should batch multiple writes
[KV Cache] Flushed 2/2 writes to KV

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should process alerts and send notifications
{"timestamp":"2025-12-14T19:16:19.862Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739779861","userId":null,"path":"/cron/alerts","message":"Evaluated 1 alerts, 1 triggered","type":"general"}
{"timestamp":"2025-12-14T19:16:19.862Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739779861","userId":null,"path":"/cron/alerts","message":"Alert triggered","type":"general","alertId":"alert-1","symbol":"AAPL","price":205,"direction":"above","threshold":200,"channel":"notification"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should handle empty news response
{"timestamp":"2025-12-14T19:16:19.883Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779882","userId":null,"path":"/cron/news-alerts","message":"Checking news for 1 unique symbols: LXEO","type":"general"}
{"timestamp":"2025-12-14T19:16:19.883Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779882","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > delete > should log successful delete operation
{"timestamp":"2025-12-14T19:16:19.917Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV delete: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"N/A"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should process alerts and send notifications
{"timestamp":"2025-12-14T19:16:19.862Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739779861","userId":null,"path":"/cron/alerts","message":"FCM notification sent successfully","type":"general","alertId":"alert-1","symbol":"AAPL","pushToken":"fcm-token-123"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should not write if interval has not passed
[KV Cache] Queued state update for alert alert-1 (1 pending writes)
[KV Cache] Flushing 1 pending writes to KV...

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should handle empty news response
{"timestamp":"2025-12-14T19:16:19.883Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779882","userId":null,"path":"/cron/news-alerts","message":"Fetched 0 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:16:19.883Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779882","userId":null,"path":"/cron/news-alerts","message":"Found news for 0 symbols: ","type":"general"}
{"timestamp":"2025-12-14T19:16:19.883Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779882","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stdout | test/logging/d1-wrapper.spec.ts > LoggedD1Database > LoggedD1PreparedStatement > all > should log failed all operation
{"timestamp":"2025-12-14T19:16:19.928Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"D1 all failed: SELECT * FROM alerts WHERE id = ?","type":"data_operation","operation":"d1","query":"SELECT * FROM alerts WHERE id = ?","latencyMs":0,"cacheStatus":"N/A","error":"Query failed"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should process alerts and send notifications
{"timestamp":"2025-12-14T19:16:19.862Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739779861","userId":null,"path":"/cron/alerts","message":"Alert notification sent to all user devices","type":"general","alertId":"alert-1","symbol":"AAPL","username":"testuser","devicesCount":1,"successCount":1,"failCount":0}
{"timestamp":"2025-12-14T19:16:19.862Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739779861","userId":null,"path":"/cron/alerts","message":"Alert cron job completed successfully","type":"general","alertsProcessed":1,"notificationsSent":1}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should not write if interval has not passed
[KV Cache] Flushed 1/1 writes to KV

stdout | test/logging/logger.spec.ts > Logger > logDataOperation > should create KV operation log entry with HIT
{"timestamp":"2025-12-14T19:16:19.935Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"KV get","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":5,"cacheStatus":"HIT"}

 ✓ test/integration/alerts-flow.spec.ts (2 tests) 223ms
stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle fetch price failures gracefully
{"timestamp":"2025-12-14T19:16:19.896Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739779896","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should not write if interval has not passed
[KV Cache] Queued state update for alert alert-2 (1 pending writes)
[KV Cache] Skipping KV write - only 0s since last write (interval: 3600s)

 ✓ test/integration/auth-flow.spec.ts (2 tests) 223ms
stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle fetch price failures gracefully
{"timestamp":"2025-12-14T19:16:19.897Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739779896","userId":null,"path":"/cron/alerts","message":"Processing 1 active alerts","type":"general"}
{"timestamp":"2025-12-14T19:16:19.897Z","service":"stockly-api","level":"DEBUG","traceId":"cron-1765739779896","userId":null,"path":"/cron/alerts","message":"Fetching prices for 1 unique symbols","type":"general","symbols":["AAPL"]}

stdout | test/logging/logger.spec.ts > Logger > logDataOperation > should create KV operation log entry with MISS
{"timestamp":"2025-12-14T19:16:19.970Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"KV get","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":5,"cacheStatus":"MISS"}

 ✓ test/config.spec.ts (10 tests) 717ms
stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > delete > should log failed delete operation
{"timestamp":"2025-12-14T19:16:19.981Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV delete failed: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"N/A","error":"Delete failed"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should not send duplicate notifications for the same article
{"timestamp":"2025-12-14T19:16:19.980Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779980","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should not send duplicate notifications for the same article
{"timestamp":"2025-12-14T19:16:19.980Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779980","userId":null,"path":"/cron/news-alerts","message":"Checking news for 1 unique symbols: LXEO","type":"general"}
{"timestamp":"2025-12-14T19:16:19.980Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779980","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should write if interval has passed
[KV Cache] Queued state update for alert alert-1 (1 pending writes)
[KV Cache] Flushing 1 pending writes to KV...

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should not send duplicate notifications for the same article
{"timestamp":"2025-12-14T19:16:19.980Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779980","userId":null,"path":"/cron/news-alerts","message":"Fetched 1 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:16:19.981Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779980","userId":null,"path":"/cron/news-alerts","message":"Found news for 1 symbols: LXEO","type":"general"}

stdout | test/logging/d1-wrapper.spec.ts > LoggedD1Database > LoggedD1PreparedStatement > run > should log successful run operation
{"timestamp":"2025-12-14T19:16:19.995Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"D1 run: SELECT * FROM alerts WHERE id = ?","type":"data_operation","operation":"d1","query":"SELECT * FROM alerts WHERE id = ?","latencyMs":0,"cacheStatus":"N/A"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should write if interval has passed
[KV Cache] Flushed 1/1 writes to KV

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should not send duplicate notifications for the same article
{"timestamp":"2025-12-14T19:16:19.981Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779980","userId":null,"path":"/cron/news-alerts","message":"New article found (published today)","type":"general","symbol":"LXEO","title":"LXEO News Today","publishedDate":"2025-12-14T10:00:00Z"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should write if interval has passed
[KV Cache] Queued state update for alert alert-2 (1 pending writes)
[KV Cache] Flushing 1 pending writes to KV...

stdout | test/api/push-token.spec.ts > Push Token API > registerPushToken > should register new push token
✅ FCM token validation passed: length=30, format valid

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > validates days parameter - must be between 1 and 30
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-12-13 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-13 to 2025-12-14

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should not send duplicate notifications for the same article
{"timestamp":"2025-12-14T19:16:19.981Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779980","userId":null,"path":"/cron/news-alerts","message":"Found 1 users with LXEO in favorites: user1","type":"general"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should write if interval has passed
[KV Cache] Flushed 1/1 writes to KV

stdout | test/logging/logger.spec.ts > Logger > logDataOperation > should create data operation log entry with error
{"timestamp":"2025-12-14T19:16:20.035Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"D1 query failed","type":"data_operation","operation":"d1","query":"SELECT * FROM alerts","latencyMs":25,"cacheStatus":"N/A","error":"Database connection failed"}

stdout | test/api/push-token.spec.ts > Push Token API > registerPushToken > should register new push token
{"timestamp":"2025-12-14T19:16:20.020Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Registering new push token","type":"general","username":"testuser","deviceType":"android","tokenPreview":"fcm-token-1234567890..."}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should skip alert with old Expo token
{"timestamp":"2025-12-14T19:16:20.035Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780035","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should not send duplicate notifications for the same article
{"timestamp":"2025-12-14T19:16:19.981Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779980","userId":null,"path":"/cron/news-alerts","message":"Sent 1 notifications for LXEO news to 1 users","type":"general"}
{"timestamp":"2025-12-14T19:16:19.981Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779980","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should skip alert with old Expo token
{"timestamp":"2025-12-14T19:16:20.035Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780035","userId":null,"path":"/cron/alerts","message":"Processing 1 active alerts","type":"general"}
{"timestamp":"2025-12-14T19:16:20.036Z","service":"stockly-api","level":"DEBUG","traceId":"cron-1765739780035","userId":null,"path":"/cron/alerts","message":"Fetching prices for 1 unique symbols","type":"general","symbols":["AAPL"]}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should not send duplicate notifications for the same article
{"timestamp":"2025-12-14T19:16:19.981Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779981","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > list > should log successful list operation without options
{"timestamp":"2025-12-14T19:16:20.054Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV list: prefix=all","type":"data_operation","operation":"kv","key":"*","latencyMs":0,"cacheStatus":"N/A"}

stdout | test/api/favorite-stocks.spec.ts > Favorite Stocks API > getFavoriteStocks > should return favorite stocks for authenticated user
{"timestamp":"2025-12-14T19:16:20.056Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Fetched favorite stocks","type":"general","username":"testuser","count":2}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should skip alert with old Expo token
{"timestamp":"2025-12-14T19:16:20.036Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780035","userId":null,"path":"/cron/alerts","message":"Successfully fetched prices for 1 symbols","type":"general"}

stdout | test/logging/d1-wrapper.spec.ts > LoggedD1Database > LoggedD1PreparedStatement > run > should log failed run operation
{"timestamp":"2025-12-14T19:16:20.061Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"D1 run failed: SELECT * FROM alerts WHERE id = ?","type":"data_operation","operation":"d1","query":"SELECT * FROM alerts WHERE id = ?","latencyMs":1,"cacheStatus":"N/A","error":"Update failed"}

stdout | test/api/news-archive.spec.ts > News Archive API > getArchivedNews > should return archived news for authenticated user
{"timestamp":"2025-12-14T19:16:20.066Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Fetching archived news","type":"general","username":"testuser","page":1,"limit":10}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should skip alert with old Expo token
{"timestamp":"2025-12-14T19:16:20.036Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780035","userId":null,"path":"/cron/alerts","message":"Evaluated 1 alerts, 1 triggered","type":"general"}
{"timestamp":"2025-12-14T19:16:20.036Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780035","userId":null,"path":"/cron/alerts","message":"Alert triggered","type":"general","alertId":"alert-1","symbol":"AAPL","price":205,"direction":"above","threshold":200,"channel":"notification"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should handle KV write errors gracefully
[KV Cache] Queued state update for alert alert-1 (1 pending writes)
[KV Cache] Flushing 1 pending writes to KV...

stdout | test/api/get-news.spec.ts > Get News API > getNews > should return news articles
News cache miss for AAPL, fetching from API...

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should not send duplicate notifications for the same article
{"timestamp":"2025-12-14T19:16:19.982Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739779981","userId":null,"path":"/cron/news-alerts","message":"No favorite symbols found to check for news","type":"general"}

stdout | test/api/news-archive.spec.ts > News Archive API > getArchivedNews > should return archived news for authenticated user
{"timestamp":"2025-12-14T19:16:20.067Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Archived news fetched successfully","type":"general","username":"testuser","page":1,"limit":10,"total":10,"returned":1,"hasMore":false}

stdout | test/api/push-token.spec.ts > Push Token API > registerPushToken > should update existing push token
✅ FCM token validation passed: length=30, format valid

stdout | test/api/push-token.spec.ts > Push Token API > registerPushToken > should update existing push token
{"timestamp":"2025-12-14T19:16:20.069Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Updating existing push token","type":"general","username":"testuser","deviceType":"android"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should skip alert with old Expo token
{"timestamp":"2025-12-14T19:16:20.036Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780035","userId":null,"path":"/cron/alerts","message":"Alert notification sent to all user devices","type":"general","alertId":"alert-1","symbol":"AAPL","username":"testuser","devicesCount":1,"successCount":0,"failCount":1}
{"timestamp":"2025-12-14T19:16:20.036Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780035","userId":null,"path":"/cron/alerts","message":"Alert cron job completed successfully","type":"general","alertsProcessed":1,"notificationsSent":1}

stdout | test/get-stock-news.spec.ts > getStockNews handler > returns cached data without calling the upstream API
Cache hit for news AAPL: age=0s < interval=30s

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should handle KV write errors gracefully
[KV Cache] Flushed 0/1 writes to KV

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should log failed FCM notifications
{"timestamp":"2025-12-14T19:16:20.098Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780098","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > list > should log successful list operation with prefix
{"timestamp":"2025-12-14T19:16:20.121Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV list: prefix=cache:","type":"data_operation","operation":"kv","key":"cache:","latencyMs":0,"cacheStatus":"N/A"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should log failed FCM notifications
{"timestamp":"2025-12-14T19:16:20.098Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780098","userId":null,"path":"/cron/alerts","message":"Processing 1 active alerts","type":"general"}
{"timestamp":"2025-12-14T19:16:20.098Z","service":"stockly-api","level":"DEBUG","traceId":"cron-1765739780098","userId":null,"path":"/cron/alerts","message":"Fetching prices for 1 unique symbols","type":"general","symbols":["AAPL"]}

stdout | test/api/news-archive.spec.ts > News Archive API > getArchivedNews > should handle pagination correctly
{"timestamp":"2025-12-14T19:16:20.120Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Fetching archived news","type":"general","username":"testuser","page":2,"limit":10}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should log failed FCM notifications
{"timestamp":"2025-12-14T19:16:20.098Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780098","userId":null,"path":"/cron/alerts","message":"Successfully fetched prices for 1 symbols","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should mark articles as seen in KV after sending notification
{"timestamp":"2025-12-14T19:16:20.147Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780147","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/api/push-token.spec.ts > Push Token API > registerPushToken > should reassign token to new user if different user
✅ FCM token validation passed: length=30, format valid

stdout | test/api/news-archive.spec.ts > News Archive API > getArchivedNews > should handle pagination correctly
{"timestamp":"2025-12-14T19:16:20.120Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Archived news fetched successfully","type":"general","username":"testuser","page":2,"limit":10,"total":25,"returned":0,"hasMore":true}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should log failed FCM notifications
{"timestamp":"2025-12-14T19:16:20.099Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780098","userId":null,"path":"/cron/alerts","message":"Evaluated 1 alerts, 1 triggered","type":"general"}
{"timestamp":"2025-12-14T19:16:20.099Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780098","userId":null,"path":"/cron/alerts","message":"Alert triggered","type":"general","alertId":"alert-1","symbol":"AAPL","price":205,"direction":"above","threshold":200,"channel":"notification"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should mark articles as seen in KV after sending notification
{"timestamp":"2025-12-14T19:16:20.148Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780147","userId":null,"path":"/cron/news-alerts","message":"Checking news for 1 unique symbols: LXEO","type":"general"}
{"timestamp":"2025-12-14T19:16:20.148Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780147","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/api/push-token.spec.ts > Push Token API > registerPushToken > should reassign token to new user if different user
{"timestamp":"2025-12-14T19:16:20.148Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Reassigning push token to different user","type":"general","username":"testuser","previousUserId":"user-456","deviceType":"android"}

stdout | test/api/get-news.spec.ts > Get News API > getNews > should handle pagination correctly
News cache miss for AAPL, fetching from API...

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should mark articles as seen in KV after sending notification
{"timestamp":"2025-12-14T19:16:20.148Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780147","userId":null,"path":"/cron/news-alerts","message":"Fetched 1 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:16:20.148Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780147","userId":null,"path":"/cron/news-alerts","message":"Found news for 1 symbols: LXEO","type":"general"}

stdout | test/get-historical.spec.ts > getHistorical handler > Parameter validation > accepts symbol parameter
[get-historical] Query result for AAPL (2025-06-17 to 2025-12-14): 0 records found in database
{"timestamp":"2025-12-14T19:16:20.175Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No historical data in database for AAPL","type":"general","dateRange":"2025-06-17 to 2025-12-14","action":"fetching from FMP API"}

stdout | test/alerts-handler.spec.ts > alerts handler > lists alerts
{"timestamp":"2025-12-14T19:16:20.178Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Alerts request authenticated","type":"general","username":"testuser","isAdmin":false,"requestUsername":"testuser","method":"GET"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should log failed FCM notifications
{"timestamp":"2025-12-14T19:16:20.101Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780098","userId":null,"path":"/cron/alerts","message":"Alert notification sent to all user devices","type":"general","alertId":"alert-1","symbol":"AAPL","username":"testuser","devicesCount":1,"successCount":0,"failCount":1}
{"timestamp":"2025-12-14T19:16:20.101Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780098","userId":null,"path":"/cron/alerts","message":"Alert cron job completed successfully","type":"general","alertsProcessed":1,"notificationsSent":1}

stdout | test/get-stock-news.spec.ts > getStockNews handler > fetches news from FMP API when cache misses
No cache for news AAPL, fetching fresh data

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should mark articles as seen in KV after sending notification
{"timestamp":"2025-12-14T19:16:20.148Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780147","userId":null,"path":"/cron/news-alerts","message":"New article found (published today)","type":"general","symbol":"LXEO","title":"LXEO News Today","publishedDate":"2025-12-14T10:00:00Z"}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > list > should log successful list operation with limit
{"timestamp":"2025-12-14T19:16:20.192Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV list: prefix=all","type":"data_operation","operation":"kv","key":"*","latencyMs":0,"cacheStatus":"N/A"}

stdout | test/alerts-handler.spec.ts > alerts handler > lists alerts
{"timestamp":"2025-12-14T19:16:20.179Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Fetched alerts from D1","type":"general","username":"testuser","alertCount":1,"alertIds":["1"]}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should mark articles as seen in KV after sending notification
{"timestamp":"2025-12-14T19:16:20.148Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780147","userId":null,"path":"/cron/news-alerts","message":"Found 1 users with LXEO in favorites: user1","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should mark articles as seen in KV after sending notification
{"timestamp":"2025-12-14T19:16:20.148Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780147","userId":null,"path":"/cron/news-alerts","message":"Sent 1 notifications for LXEO news to 1 users","type":"general"}
{"timestamp":"2025-12-14T19:16:20.148Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780147","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stdout | test/logging/d1-wrapper.spec.ts > LoggedD1Database > LoggedD1PreparedStatement > latency measurement > should measure latency accurately
{"timestamp":"2025-12-14T19:16:20.203Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"D1 first: SELECT * FROM alerts WHERE id = ?","type":"data_operation","operation":"d1","query":"SELECT * FROM alerts WHERE id = ?","latencyMs":10,"cacheStatus":"N/A"}

stdout | test/api/get-news.spec.ts > Get News API > getNews > should handle external API errors gracefully
News cache miss for AAPL, fetching from API...

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > invalidateState > should remove state from cache and pending writes
[KV Cache] Queued state update for alert alert-1 (1 pending writes)

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle FCM notification errors
{"timestamp":"2025-12-14T19:16:20.225Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780225","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stdout | test/get-stock-news.spec.ts > getStockNews handler > returns empty array when FMP API returns empty array
No cache for news XYZ, fetching fresh data

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle FCM notification errors
{"timestamp":"2025-12-14T19:16:20.225Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780225","userId":null,"path":"/cron/alerts","message":"Processing 1 active alerts","type":"general"}
{"timestamp":"2025-12-14T19:16:20.225Z","service":"stockly-api","level":"DEBUG","traceId":"cron-1765739780225","userId":null,"path":"/cron/alerts","message":"Fetching prices for 1 unique symbols","type":"general","symbols":["AAPL"]}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > list > should log successful list operation with cursor
{"timestamp":"2025-12-14T19:16:20.237Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV list: prefix=all","type":"data_operation","operation":"kv","key":"*","latencyMs":0,"cacheStatus":"N/A"}

stdout | test/get-stock.spec.ts > getStock handler > returns cached data without calling the upstream API
{"timestamp":"2025-12-14T19:16:20.229Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for MSFT","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}

stdout | test/alerts-handler.spec.ts > alerts handler > creates an alert when payload is valid
{"timestamp":"2025-12-14T19:16:20.231Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Alerts request authenticated","type":"general","username":"testuser","isAdmin":false,"requestUsername":"testuser","method":"POST"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle FCM notification errors
{"timestamp":"2025-12-14T19:16:20.225Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780225","userId":null,"path":"/cron/alerts","message":"Successfully fetched prices for 1 symbols","type":"general"}

stdout | test/alerts-handler.spec.ts > alerts handler > creates an alert when payload is valid
{"timestamp":"2025-12-14T19:16:20.231Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Creating alert","type":"general","username":"testuser","symbol":"AAPL","direction":"above","threshold":200}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle FCM notification errors
{"timestamp":"2025-12-14T19:16:20.225Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780225","userId":null,"path":"/cron/alerts","message":"Evaluated 1 alerts, 1 triggered","type":"general"}
{"timestamp":"2025-12-14T19:16:20.225Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780225","userId":null,"path":"/cron/alerts","message":"Alert triggered","type":"general","alertId":"alert-1","symbol":"AAPL","price":205,"direction":"above","threshold":200,"channel":"notification"}

stdout | test/api/favorite-stocks.spec.ts > Favorite Stocks API > updateFavoriteStocks > should update favorite stocks for authenticated user
{"timestamp":"2025-12-14T19:16:20.255Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Received favorite stocks update request","type":"general","bodyType":"object","bodyStringified":"{\"symbols\":[\"AAPL\",\"GOOGL\"]}","hasSymbols":true,"bodyKeys":["symbols"]}
{"timestamp":"2025-12-14T19:16:20.256Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Processing symbols array","type":"general","symbolsArrayLength":2,"symbolsArray":"[\"AAPL\",\"GOOGL\"]","symbolsArrayTypes":["string","string"]}
{"timestamp":"2025-12-14T19:16:20.256Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Normalized symbols","type":"general","originalCount":2,"normalizedCount":2,"uniqueCount":2,"uniqueSymbols":["AAPL","GOOGL"]}

stdout | test/alerts-handler.spec.ts > alerts handler > creates an alert when payload is valid
{"timestamp":"2025-12-14T19:16:20.231Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Created alert successfully","type":"general","alertId":"2","username":"testuser","alertUsername":"testuser","isAdmin":false}

stdout | test/api/favorite-stocks.spec.ts > Favorite Stocks API > updateFavoriteStocks > should update favorite stocks for authenticated user
{"timestamp":"2025-12-14T19:16:20.256Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Updated favorite stocks","type":"general","username":"testuser","count":2,"symbols":["AAPL","GOOGL"]}

stdout | test/api/news-archive.spec.ts > News Archive API > toggleArchivedNews > should save article to archive
{"timestamp":"2025-12-14T19:16:20.272Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Article saved successfully","type":"general","username":"testuser","articleId":"article-123","symbol":"AAPL"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send notifications to all users who have the symbol in favorites
{"timestamp":"2025-12-14T19:16:20.272Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780272","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/logging/logger.spec.ts > Logger > getLogs > should return copy of log buffer
{"timestamp":"2025-12-14T19:16:20.276Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"Message 1","type":"general"}
{"timestamp":"2025-12-14T19:16:20.276Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"Message 2","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle FCM notification errors
{"timestamp":"2025-12-14T19:16:20.226Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780225","userId":null,"path":"/cron/alerts","message":"Alert notification sent to all user devices","type":"general","alertId":"alert-1","symbol":"AAPL","username":"testuser","devicesCount":1,"successCount":0,"failCount":1}
{"timestamp":"2025-12-14T19:16:20.226Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780225","userId":null,"path":"/cron/alerts","message":"Alert cron job completed successfully","type":"general","alertsProcessed":1,"notificationsSent":1}

stdout | test/get-stock.spec.ts > getStock handler > fetches the quote and caches the parsed response
{"timestamp":"2025-12-14T19:16:20.277Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for AAPL","type":"general","cacheStatus":"MISS"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send notifications to all users who have the symbol in favorites
{"timestamp":"2025-12-14T19:16:20.272Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780272","userId":null,"path":"/cron/news-alerts","message":"Checking news for 4 unique symbols: LXEO, AMZN, AAPL, BABA","type":"general"}
{"timestamp":"2025-12-14T19:16:20.272Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780272","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/get-stock.spec.ts > getStock handler > fetches the quote and caches the parsed response
{"timestamp":"2025-12-14T19:16:20.277Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /quote","type":"api_call","apiProvider":"FMP","endpoint":"/quote","method":"GET","latencyMs":0}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send notifications to all users who have the symbol in favorites
{"timestamp":"2025-12-14T19:16:20.272Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780272","userId":null,"path":"/cron/news-alerts","message":"Fetched 1 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:16:20.272Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780272","userId":null,"path":"/cron/news-alerts","message":"Found news for 1 symbols: LXEO","type":"general"}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > list > should log failed list operation
{"timestamp":"2025-12-14T19:16:20.297Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV list failed: prefix=all","type":"data_operation","operation":"kv","key":"*","latencyMs":0,"cacheStatus":"N/A","error":"List failed"}

stdout | test/get-stock-news.spec.ts > getStockNews handler > handles API errors gracefully
No cache for news AAPL, fetching fresh data

stdout | test/get-stock.spec.ts > getStock handler > fetches the quote and caches the parsed response
{"timestamp":"2025-12-14T19:16:20.278Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","latencyMs":0}

stdout | test/alerts-handler.spec.ts > alerts handler > returns 404 when an alert is missing
{"timestamp":"2025-12-14T19:16:20.303Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Alerts request authenticated","type":"general","username":"testuser","isAdmin":false,"requestUsername":"testuser","method":"GET"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send notifications to all users who have the symbol in favorites
{"timestamp":"2025-12-14T19:16:20.272Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780272","userId":null,"path":"/cron/news-alerts","message":"New article found (published today)","type":"general","symbol":"LXEO","title":"LXEO News Today","publishedDate":"2025-12-14T10:00:00Z"}

stdout | test/get-stock.spec.ts > getStock handler > fetches the quote and caches the parsed response
{"timestamp":"2025-12-14T19:16:20.278Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API response","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile?symbol=AAPL&apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","responseType":"array","responseLength":0}
{"timestamp":"2025-12-14T19:16:20.278Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API returned empty array","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile?symbol=AAPL&apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send notifications to all users who have the symbol in favorites
{"timestamp":"2025-12-14T19:16:20.272Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780272","userId":null,"path":"/cron/news-alerts","message":"Found 2 users with LXEO in favorites: user1, user3","type":"general"}

stdout | test/api/news-archive.spec.ts > News Archive API > toggleArchivedNews > should remove article from archive if already saved
{"timestamp":"2025-12-14T19:16:20.323Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Article unsaved successfully","type":"general","username":"testuser","articleId":"article-123"}

stdout | test/get-stock.spec.ts > getStock handler > fetches the quote and caches the parsed response
{"timestamp":"2025-12-14T19:16:20.278Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","latencyMs":0}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle multiple alerts
{"timestamp":"2025-12-14T19:16:20.322Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780322","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send notifications to all users who have the symbol in favorites
{"timestamp":"2025-12-14T19:16:20.273Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780272","userId":null,"path":"/cron/news-alerts","message":"Sent 2 notifications for LXEO news to 2 users","type":"general"}
{"timestamp":"2025-12-14T19:16:20.273Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780272","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

 ✓ test/api/user-preferences.spec.ts (3 tests) 290ms
stdout | test/get-stock.spec.ts > getStock handler > fetches the quote and caches the parsed response
{"timestamp":"2025-12-14T19:16:20.278Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API response","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","responseType":"array","responseLength":0}
{"timestamp":"2025-12-14T19:16:20.278Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API returned empty array","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle multiple alerts
{"timestamp":"2025-12-14T19:16:20.322Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780322","userId":null,"path":"/cron/alerts","message":"Processing 2 active alerts","type":"general"}
{"timestamp":"2025-12-14T19:16:20.322Z","service":"stockly-api","level":"DEBUG","traceId":"cron-1765739780322","userId":null,"path":"/cron/alerts","message":"Fetching prices for 2 unique symbols","type":"general","symbols":["AAPL","MSFT"]}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send separate notifications for different symbols
{"timestamp":"2025-12-14T19:16:20.325Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780325","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > clearCache > should clear all cached states
[KV Cache] Queued state update for alert alert-1 (1 pending writes)
[KV Cache] Queued state update for alert alert-2 (2 pending writes)

stdout | test/api/get-news.spec.ts > Get News API > getFavoriteNews > should return favorite news for authenticated user
{"timestamp":"2025-12-14T19:16:20.334Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Fetching favorite news","type":"general","username":"testuser"}

stdout | test/logging/d1-wrapper.spec.ts > LoggedD1Database > LoggedD1PreparedStatement > error propagation > should re-throw errors after logging
{"timestamp":"2025-12-14T19:16:20.346Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"D1 first failed: SELECT * FROM alerts WHERE id = ?","type":"data_operation","operation":"d1","query":"SELECT * FROM alerts WHERE id = ?","latencyMs":0,"cacheStatus":"N/A","error":"Database error"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle multiple alerts
{"timestamp":"2025-12-14T19:16:20.323Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780322","userId":null,"path":"/cron/alerts","message":"Successfully fetched prices for 2 symbols","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send separate notifications for different symbols
{"timestamp":"2025-12-14T19:16:20.325Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780325","userId":null,"path":"/cron/news-alerts","message":"Checking news for 2 unique symbols: LXEO, AMZN","type":"general"}
{"timestamp":"2025-12-14T19:16:20.325Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780325","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/get-stock.spec.ts > getStock handler > fetches the quote and caches the parsed response
{"timestamp":"2025-12-14T19:16:20.278Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","latencyMs":0}

stdout | test/get-stock-news.spec.ts > getStockNews handler > handles network errors gracefully
No cache for news AAPL, fetching fresh data

stdout | test/api/get-news.spec.ts > Get News API > getFavoriteNews > should return favorite news for authenticated user
{"timestamp":"2025-12-14T19:16:20.334Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No favorite symbols selected","type":"general","username":"testuser"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle multiple alerts
{"timestamp":"2025-12-14T19:16:20.323Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780322","userId":null,"path":"/cron/alerts","message":"Evaluated 2 alerts, 2 triggered","type":"general"}
{"timestamp":"2025-12-14T19:16:20.323Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780322","userId":null,"path":"/cron/alerts","message":"Alert triggered","type":"general","alertId":"alert-1","symbol":"AAPL","price":205,"direction":"above","threshold":200,"channel":"notification"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send separate notifications for different symbols
{"timestamp":"2025-12-14T19:16:20.325Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780325","userId":null,"path":"/cron/news-alerts","message":"Fetched 2 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:16:20.325Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780325","userId":null,"path":"/cron/news-alerts","message":"Found news for 2 symbols: LXEO, AMZN","type":"general"}

stdout | test/get-stock.spec.ts > getStock handler > fetches the quote and caches the parsed response
{"timestamp":"2025-12-14T19:16:20.279Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API response","type":"general","endpoint":"https://financialmodelingprep.com/stable/company/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","responseType":"array","responseLength":0}
{"timestamp":"2025-12-14T19:16:20.279Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API returned empty array","type":"general","endpoint":"https://financialmodelingprep.com/stable/company/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM"}

stdout | test/alerts-handler.spec.ts > alerts handler > updates alerts via PUT
{"timestamp":"2025-12-14T19:16:20.369Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Alerts request authenticated","type":"general","username":"testuser","isAdmin":false,"requestUsername":"testuser","method":"PUT"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle multiple alerts
{"timestamp":"2025-12-14T19:16:20.323Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780322","userId":null,"path":"/cron/alerts","message":"FCM notification sent successfully","type":"general","alertId":"alert-1","symbol":"AAPL","pushToken":"fcm-token-123"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send separate notifications for different symbols
{"timestamp":"2025-12-14T19:16:20.325Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780325","userId":null,"path":"/cron/news-alerts","message":"New article found (published today)","type":"general","symbol":"LXEO","title":"LXEO News Today","publishedDate":"2025-12-14T10:00:00Z"}

stdout | test/get-stock.spec.ts > getStock handler > fetches the quote and caches the parsed response
{"timestamp":"2025-12-14T19:16:20.279Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","latencyMs":0}

stdout | test/alerts-handler.spec.ts > alerts handler > updates alerts via PUT
{"timestamp":"2025-12-14T19:16:20.370Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Updated alert","type":"general","alertId":"3","username":"testuser"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle multiple alerts
{"timestamp":"2025-12-14T19:16:20.323Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780322","userId":null,"path":"/cron/alerts","message":"Alert notification sent to all user devices","type":"general","alertId":"alert-1","symbol":"AAPL","username":"testuser","devicesCount":1,"successCount":1,"failCount":0}
{"timestamp":"2025-12-14T19:16:20.323Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780322","userId":null,"path":"/cron/alerts","message":"Alert triggered","type":"general","alertId":"alert-2","symbol":"MSFT","price":310,"direction":"above","threshold":300,"channel":"notification"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send separate notifications for different symbols
{"timestamp":"2025-12-14T19:16:20.326Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780325","userId":null,"path":"/cron/news-alerts","message":"Found 1 users with LXEO in favorites: user1","type":"general"}

stdout | test/logging/logger.spec.ts > Logger > clearLogs > should clear log buffer
{"timestamp":"2025-12-14T19:16:20.392Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"Message 1","type":"general"}
{"timestamp":"2025-12-14T19:16:20.392Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"Message 2","type":"general"}

stdout | test/get-stock.spec.ts > getStock handler > fetches the quote and caches the parsed response
{"timestamp":"2025-12-14T19:16:20.279Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API response","type":"general","endpoint":"https://financialmodelingprep.com/api/v3/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","responseType":"array","responseLength":0}
{"timestamp":"2025-12-14T19:16:20.279Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API returned empty array","type":"general","endpoint":"https://financialmodelingprep.com/api/v3/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM"}

 ✓ test/search-stock.spec.ts (6 tests) 420ms
stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle multiple alerts
{"timestamp":"2025-12-14T19:16:20.323Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780322","userId":null,"path":"/cron/alerts","message":"FCM notification sent successfully","type":"general","alertId":"alert-2","symbol":"MSFT","pushToken":"fcm-token-123"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send separate notifications for different symbols
{"timestamp":"2025-12-14T19:16:20.326Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780325","userId":null,"path":"/cron/news-alerts","message":"Sent 2 notifications for LXEO news to 1 users","type":"general"}

stdout | test/get-stock.spec.ts > getStock handler > fetches the quote and caches the parsed response
{"timestamp":"2025-12-14T19:16:20.279Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Final description resolved","type":"general","hasDescription":false,"descriptionLength":0,"source":"none"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle multiple alerts
{"timestamp":"2025-12-14T19:16:20.323Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780322","userId":null,"path":"/cron/alerts","message":"Alert notification sent to all user devices","type":"general","alertId":"alert-2","symbol":"MSFT","username":"testuser","devicesCount":1,"successCount":1,"failCount":0}
{"timestamp":"2025-12-14T19:16:20.323Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780322","userId":null,"path":"/cron/alerts","message":"Alert cron job completed successfully","type":"general","alertsProcessed":2,"notificationsSent":2}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send separate notifications for different symbols
{"timestamp":"2025-12-14T19:16:20.326Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780325","userId":null,"path":"/cron/news-alerts","message":"New article found (published today)","type":"general","symbol":"AMZN","title":"AMZN News Today","publishedDate":"2025-12-14T11:00:00Z"}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > error propagation > should re-throw errors after logging
{"timestamp":"2025-12-14T19:16:20.408Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV get failed: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"N/A","error":"KV error"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send separate notifications for different symbols
{"timestamp":"2025-12-14T19:16:20.326Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780325","userId":null,"path":"/cron/news-alerts","message":"Found 2 users with AMZN in favorites: user1, user2","type":"general"}

stdout | test/alerts-handler.spec.ts > alerts handler > deletes alerts and clears KV state
{"timestamp":"2025-12-14T19:16:20.415Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Alerts request authenticated","type":"general","username":"testuser","isAdmin":false,"requestUsername":"testuser","method":"DELETE"}

stdout | test/get-stock-news.spec.ts > getStockNews handler > handles simulation mode
No cache for news AAPL, fetching fresh data

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send separate notifications for different symbols
{"timestamp":"2025-12-14T19:16:20.326Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780325","userId":null,"path":"/cron/news-alerts","message":"Sent 2 notifications for AMZN news to 2 users","type":"general"}
{"timestamp":"2025-12-14T19:16:20.326Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780325","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stdout | test/alerts-handler.spec.ts > alerts handler > deletes alerts and clears KV state
{"timestamp":"2025-12-14T19:16:20.416Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Deleted alert","type":"general","alertId":"123","username":"testuser"}

stdout | test/api/favorite-stocks.spec.ts > Favorite Stocks API > deleteFavoriteStock > should delete favorite stock for authenticated user
{"timestamp":"2025-12-14T19:16:20.434Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Deleted favorite stock","type":"general","username":"testuser","symbol":"AAPL"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should skip when no prices available
{"timestamp":"2025-12-14T19:16:20.441Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780441","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should skip when no prices available
{"timestamp":"2025-12-14T19:16:20.441Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780441","userId":null,"path":"/cron/alerts","message":"Processing 1 active alerts","type":"general"}
{"timestamp":"2025-12-14T19:16:20.441Z","service":"stockly-api","level":"DEBUG","traceId":"cron-1765739780441","userId":null,"path":"/cron/alerts","message":"Fetching prices for 1 unique symbols","type":"general","symbols":["AAPL"]}

stdout | test/get-stock.spec.ts > getStock handler > returns an error when the upstream API fails
{"timestamp":"2025-12-14T19:16:20.439Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for TSLA","type":"general","cacheStatus":"MISS"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > getCacheStats > should return cache statistics
[KV Cache] Queued state update for alert alert-1 (1 pending writes)
[KV Cache] Queued state update for alert alert-2 (2 pending writes)

 ✓ test/api/news-archive.spec.ts (4 tests) 448ms
 ✓ test/contract/openapi-validation.spec.ts (6 tests) 559ms
 ❯ test/api/get-news.spec.ts (4 tests | 3 failed) 445ms
   × Get News API > getNews > should return news articles 24ms
     → expected false to be true // Object.is equality
   ✓ Get News API > getNews > should handle pagination correctly 80ms
   × Get News API > getNews > should handle external API errors gracefully 13ms
     → expected 200 to be greater than or equal to 500
   × Get News API > getFavoriteNews > should return favorite news for authenticated user 13ms
     → expected false to be true // Object.is equality
stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should not send notifications if user has no push token
{"timestamp":"2025-12-14T19:16:20.461Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780461","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/get-stock-news.spec.ts > getStockNews handler > normalizes news data correctly
No cache for news AAPL, fetching fresh data

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should not send notifications if user has no push token
{"timestamp":"2025-12-14T19:16:20.462Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780461","userId":null,"path":"/cron/news-alerts","message":"Checking news for 1 unique symbols: LXEO","type":"general"}
{"timestamp":"2025-12-14T19:16:20.462Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780461","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should not send notifications if user has no push token
{"timestamp":"2025-12-14T19:16:20.462Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780461","userId":null,"path":"/cron/news-alerts","message":"Fetched 1 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:16:20.462Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780461","userId":null,"path":"/cron/news-alerts","message":"Found news for 1 symbols: LXEO","type":"general"}

 ✓ test/api/settings.spec.ts (4 tests) 440ms
 ✓ test/api/throttle-cache.spec.ts (21 tests) 1398ms
stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should flush pending KV writes
{"timestamp":"2025-12-14T19:16:20.508Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780508","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should not send notifications if user has no push token
{"timestamp":"2025-12-14T19:16:20.462Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780461","userId":null,"path":"/cron/news-alerts","message":"New article found (published today)","type":"general","symbol":"LXEO","title":"LXEO News Today","publishedDate":"2025-12-14T10:00:00Z"}

stdout | test/get-stock.spec.ts > getStock handler > returns stale data from DB when simulation mode is enabled
{"timestamp":"2025-12-14T19:16:20.518Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for AAPL","type":"general","cacheStatus":"MISS"}

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Invalid Input Handling > should handle invalid symbol format
{"timestamp":"2025-12-14T19:16:20.501Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for !!!","type":"general","cacheStatus":"MISS"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should flush pending KV writes
{"timestamp":"2025-12-14T19:16:20.508Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780508","userId":null,"path":"/cron/alerts","message":"Processing 1 active alerts","type":"general"}
{"timestamp":"2025-12-14T19:16:20.508Z","service":"stockly-api","level":"DEBUG","traceId":"cron-1765739780508","userId":null,"path":"/cron/alerts","message":"Fetching prices for 1 unique symbols","type":"general","symbols":["AAPL"]}

 ✓ test/logging/d1-wrapper.spec.ts (15 tests) 1384ms
stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should not send notifications if user has no push token
{"timestamp":"2025-12-14T19:16:20.462Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780461","userId":null,"path":"/cron/news-alerts","message":"Found 1 users with LXEO in favorites: user1","type":"general"}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > cache status detection > should detect HIT for non-null text value
{"timestamp":"2025-12-14T19:16:20.533Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV get: key","type":"data_operation","operation":"kv","key":"key","latencyMs":0,"cacheStatus":"HIT"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should flush pending KV writes
{"timestamp":"2025-12-14T19:16:20.508Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780508","userId":null,"path":"/cron/alerts","message":"Successfully fetched prices for 1 symbols","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should not send notifications if user has no push token
{"timestamp":"2025-12-14T19:16:20.462Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780461","userId":null,"path":"/cron/news-alerts","message":"Sent 0 notifications for LXEO news to 1 users","type":"general"}
{"timestamp":"2025-12-14T19:16:20.462Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780461","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

 ❯ test/api/push-token.spec.ts (5 tests | 3 failed) 510ms
   × Push Token API > registerPushToken > should register new push token 18ms
     → expected 500 to be 201 // Object.is equality
   × Push Token API > registerPushToken > should update existing push token 13ms
     → expected 500 to be 200 // Object.is equality
   × Push Token API > registerPushToken > should reassign token to new user if different user 12ms
     → expected 500 to be 200 // Object.is equality
   ✓ Push Token API > registerPushToken > should validate token format 71ms
   ✓ Push Token API > getPushToken > should return push tokens for authenticated user 54ms
stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should flush pending KV writes
{"timestamp":"2025-12-14T19:16:20.508Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780508","userId":null,"path":"/cron/alerts","message":"Evaluated 1 alerts, 0 triggered","type":"general"}
{"timestamp":"2025-12-14T19:16:20.508Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780508","userId":null,"path":"/cron/alerts","message":"Alert cron job completed successfully","type":"general","alertsProcessed":1,"notificationsSent":0}

 ✓ test/alerts-handler.spec.ts (5 tests) 390ms
 ✓ test/api/favorite-stocks.spec.ts (5 tests) 557ms
stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should send logs to Loki if configured
{"timestamp":"2025-12-14T19:16:20.557Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780557","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should send logs to Loki if configured
{"timestamp":"2025-12-14T19:16:20.557Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780557","userId":null,"path":"/cron/alerts","message":"Processing 1 active alerts","type":"general"}
{"timestamp":"2025-12-14T19:16:20.557Z","service":"stockly-api","level":"DEBUG","traceId":"cron-1765739780557","userId":null,"path":"/cron/alerts","message":"Fetching prices for 1 unique symbols","type":"general","symbols":["AAPL"]}

stdout | test/get-stock.spec.ts > getStock handler > returns no_price_available when simulation is enabled but no DB data exists
{"timestamp":"2025-12-14T19:16:20.563Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for AAPL","type":"general","cacheStatus":"MISS"}

 ❯ test/api/preferences.spec.ts (5 tests | 1 failed) 517ms
   ✓ Preferences API > getPreferences > should return preferences for authenticated user 47ms
   ✓ Preferences API > getPreferences > should return default preferences if none exist 84ms
   ✓ Preferences API > updatePreferences > should update preferences for authenticated user 69ms
   ✓ Preferences API > updatePreferences > should create preferences if they don't exist 51ms
   × Preferences API > updatePreferences > should validate quiet hours format 45ms
     → expected [ 200, 400 ] to include 500
stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should send logs to Loki if configured
{"timestamp":"2025-12-14T19:16:20.558Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780557","userId":null,"path":"/cron/alerts","message":"Successfully fetched prices for 1 symbols","type":"general"}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > cache status detection > should detect HIT for non-null json value
{"timestamp":"2025-12-14T19:16:20.570Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV get: key","type":"data_operation","operation":"kv","key":"key","latencyMs":0,"cacheStatus":"HIT"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should send logs to Loki if configured
{"timestamp":"2025-12-14T19:16:20.558Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780557","userId":null,"path":"/cron/alerts","message":"Evaluated 1 alerts, 0 triggered","type":"general"}
{"timestamp":"2025-12-14T19:16:20.558Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780557","userId":null,"path":"/cron/alerts","message":"Alert cron job completed successfully","type":"general","alertsProcessed":1,"notificationsSent":0}

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > validates interval format
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-12-11 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-11 to 2025-12-14

 ✓ test/alerts/state-cache.spec.ts (19 tests) 1483ms
stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Error Handling > should handle API fetch errors gracefully
{"timestamp":"2025-12-14T19:16:20.595Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780595","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/logging/logger.spec.ts > Logger > updateContext > should use updated context in new logs
{"timestamp":"2025-12-14T19:16:20.597Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-123","userId":"updated-user","path":"/v1/api/test","message":"New message","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Error Handling > should handle API fetch errors gracefully
{"timestamp":"2025-12-14T19:16:20.595Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780595","userId":null,"path":"/cron/news-alerts","message":"Checking news for 1 unique symbols: LXEO","type":"general"}
{"timestamp":"2025-12-14T19:16:20.595Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780595","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

 ✓ test/get-stock-news.spec.ts (8 tests) 554ms
stdout | test/get-stock.spec.ts > getStock handler > calls provider normally when simulation is disabled
{"timestamp":"2025-12-14T19:16:20.601Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for AAPL","type":"general","cacheStatus":"MISS"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should not send logs to Loki if not configured
{"timestamp":"2025-12-14T19:16:20.602Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780602","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stdout | test/integration/stock-flow.spec.ts > Stock Data Flow Integration > Stock Search to Details Flow > should complete flow: search -> get stock -> get details
{"timestamp":"2025-12-14T19:16:20.599Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for AAPL","type":"general","cacheStatus":"MISS"}

stdout | test/get-stock.spec.ts > getStock handler > calls provider normally when simulation is disabled
{"timestamp":"2025-12-14T19:16:20.601Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /quote","type":"api_call","apiProvider":"FMP","endpoint":"/quote","method":"GET","latencyMs":0}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should not send logs to Loki if not configured
{"timestamp":"2025-12-14T19:16:20.602Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780602","userId":null,"path":"/cron/alerts","message":"Processing 1 active alerts","type":"general"}
{"timestamp":"2025-12-14T19:16:20.602Z","service":"stockly-api","level":"DEBUG","traceId":"cron-1765739780602","userId":null,"path":"/cron/alerts","message":"Fetching prices for 1 unique symbols","type":"general","symbols":["AAPL"]}

stdout | test/integration/stock-flow.spec.ts > Stock Data Flow Integration > Stock Search to Details Flow > should complete flow: search -> get stock -> get details
{"timestamp":"2025-12-14T19:16:20.600Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /quote","type":"api_call","apiProvider":"FMP","endpoint":"/quote","method":"GET","latencyMs":0}

stdout | test/get-stock.spec.ts > getStock handler > calls provider normally when simulation is disabled
{"timestamp":"2025-12-14T19:16:20.601Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","latencyMs":0}

stdout | test/integration/stock-flow.spec.ts > Stock Data Flow Integration > Stock Search to Details Flow > should complete flow: search -> get stock -> get details
{"timestamp":"2025-12-14T19:16:20.600Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","latencyMs":0}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > cache status detection > should detect MISS for null value
{"timestamp":"2025-12-14T19:16:20.615Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV get: key","type":"data_operation","operation":"kv","key":"key","latencyMs":0,"cacheStatus":"MISS"}

stdout | test/get-stock.spec.ts > getStock handler > calls provider normally when simulation is disabled
{"timestamp":"2025-12-14T19:16:20.601Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API response","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile?symbol=AAPL&apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","responseType":"array","responseLength":0}
{"timestamp":"2025-12-14T19:16:20.601Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API returned empty array","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile?symbol=AAPL&apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM"}

stdout | test/integration/stock-flow.spec.ts > Stock Data Flow Integration > Stock Search to Details Flow > should complete flow: search -> get stock -> get details
{"timestamp":"2025-12-14T19:16:20.601Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API response","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile?symbol=AAPL&apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","responseType":"object","responseLength":"N/A"}
{"timestamp":"2025-12-14T19:16:20.601Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile fetched but no description field","type":"general","profileKeys":["price","symbol"]}

stdout | test/get-stock.spec.ts > getStock handler > calls provider normally when simulation is disabled
{"timestamp":"2025-12-14T19:16:20.601Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","latencyMs":0}

stdout | test/integration/stock-flow.spec.ts > Stock Data Flow Integration > Stock Search to Details Flow > should complete flow: search -> get stock -> get details
{"timestamp":"2025-12-14T19:16:20.601Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Final description resolved","type":"general","hasDescription":false,"descriptionLength":0,"source":"none"}

stdout | test/get-stock.spec.ts > getStock handler > calls provider normally when simulation is disabled
{"timestamp":"2025-12-14T19:16:20.602Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API response","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","responseType":"array","responseLength":0}
{"timestamp":"2025-12-14T19:16:20.602Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API returned empty array","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Error Handling > should handle network errors gracefully
{"timestamp":"2025-12-14T19:16:20.624Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780624","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/integration/stock-flow.spec.ts > Stock Data Flow Integration > Stock Search to Details Flow > should complete flow: search -> get stock -> get details
[fetchAndSaveHistoricalPrice] Starting fetch for AAPL from FMP API
[fetchAndSaveHistoricalPrice] Fetching from: https://financialmodelingprep.com/stable/historical-chart/30min?symbol=AAPL&apikey=***

stdout | test/get-stock.spec.ts > getStock handler > calls provider normally when simulation is disabled
{"timestamp":"2025-12-14T19:16:20.602Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","latencyMs":0}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle fatal errors and re-throw
{"timestamp":"2025-12-14T19:16:20.629Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780629","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Error Handling > should handle network errors gracefully
{"timestamp":"2025-12-14T19:16:20.624Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780624","userId":null,"path":"/cron/news-alerts","message":"Checking news for 1 unique symbols: LXEO","type":"general"}
{"timestamp":"2025-12-14T19:16:20.624Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780624","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/get-stock.spec.ts > getStock handler > calls provider normally when simulation is disabled
{"timestamp":"2025-12-14T19:16:20.602Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API response","type":"general","endpoint":"https://financialmodelingprep.com/stable/company/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","responseType":"array","responseLength":0}
{"timestamp":"2025-12-14T19:16:20.602Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API returned empty array","type":"general","endpoint":"https://financialmodelingprep.com/stable/company/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM"}

stdout | test/integration/stock-flow.spec.ts > Stock Data Flow Integration > Stock Search to Details Flow > should complete flow: search -> get stock -> get details
[fetchAndSaveHistoricalPrice] Received single record from FMP API
[fetchAndSaveHistoricalPrice] FMP API returned 1 records for AAPL
[fetchAndSaveHistoricalPrice] Sample record structure: {
  date: undefined,
  hasOpen: false,
  hasHigh: false,
  hasLow: false,
  hasClose: false,
  hasPrice: true,
  keys: [ 'price', 'symbol' ]
}
Saved 0 daily candles (aggregated from 1 1-hour records) for AAPL with OHLC data

stdout | test/get-stock.spec.ts > getStock handler > calls provider normally when simulation is disabled
{"timestamp":"2025-12-14T19:16:20.602Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","latencyMs":0}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Error Handling > should handle network errors gracefully
{"timestamp":"2025-12-14T19:16:20.627Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780624","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stdout | test/integration/stock-flow.spec.ts > Stock Data Flow Integration > Stock Search to Details Flow > should complete flow: search -> get stock -> get details
Cache miss for stock details: AAPL, fetching...

stdout | test/get-stock.spec.ts > getStock handler > calls provider normally when simulation is disabled
{"timestamp":"2025-12-14T19:16:20.602Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API response","type":"general","endpoint":"https://financialmodelingprep.com/api/v3/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","responseType":"array","responseLength":0}
{"timestamp":"2025-12-14T19:16:20.602Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API returned empty array","type":"general","endpoint":"https://financialmodelingprep.com/api/v3/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM"}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > cache status detection > should use N/A for put operations
{"timestamp":"2025-12-14T19:16:20.645Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV put: key","type":"data_operation","operation":"kv","key":"key","latencyMs":0,"cacheStatus":"N/A"}

stdout | test/get-news.spec.ts > News API > getGeneralNews > should return general news from FMP API
[News Cache] Queued news update for news:general (1 pending writes)
[News Cache] Flushing 1 pending writes to KV...

stdout | test/get-stock.spec.ts > getStock handler > calls provider normally when simulation is disabled
{"timestamp":"2025-12-14T19:16:20.602Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Final description resolved","type":"general","hasDescription":false,"descriptionLength":0,"source":"none"}

stdout | test/get-news.spec.ts > News API > getGeneralNews > should return general news from FMP API
[News Cache] Flushed 1/1 writes to KV

stdout | test/get-stock.spec.ts > getStock handler > falls back to DB and returns stale data when provider API fails
{"timestamp":"2025-12-14T19:16:20.629Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for AAPL","type":"general","cacheStatus":"MISS"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Error Handling > should skip users with invalid favorite symbols JSON
{"timestamp":"2025-12-14T19:16:20.654Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780654","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/get-stock.spec.ts > getStock handler > falls back to DB and returns stale data when provider API fails
{"timestamp":"2025-12-14T19:16:20.629Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /quote","type":"api_call","apiProvider":"FMP","endpoint":"/quote","method":"GET","statusCode":500,"latencyMs":0}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should use default KV write interval if not in config
{"timestamp":"2025-12-14T19:16:20.657Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780657","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should use default KV write interval if not in config
{"timestamp":"2025-12-14T19:16:20.658Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780657","userId":null,"path":"/cron/alerts","message":"Processing 1 active alerts","type":"general"}
{"timestamp":"2025-12-14T19:16:20.658Z","service":"stockly-api","level":"DEBUG","traceId":"cron-1765739780657","userId":null,"path":"/cron/alerts","message":"Fetching prices for 1 unique symbols","type":"general","symbols":["AAPL"]}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Error Handling > should skip users with invalid favorite symbols JSON
{"timestamp":"2025-12-14T19:16:20.655Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780654","userId":null,"path":"/cron/news-alerts","message":"Checking news for 1 unique symbols: LXEO","type":"general"}
{"timestamp":"2025-12-14T19:16:20.655Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780654","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should use default KV write interval if not in config
{"timestamp":"2025-12-14T19:16:20.658Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780657","userId":null,"path":"/cron/alerts","message":"Successfully fetched prices for 1 symbols","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Error Handling > should skip users with invalid favorite symbols JSON
{"timestamp":"2025-12-14T19:16:20.655Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780654","userId":null,"path":"/cron/news-alerts","message":"Fetched 0 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:16:20.655Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780654","userId":null,"path":"/cron/news-alerts","message":"Found news for 0 symbols: ","type":"general"}
{"timestamp":"2025-12-14T19:16:20.655Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780654","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should use default KV write interval if not in config
{"timestamp":"2025-12-14T19:16:20.658Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780657","userId":null,"path":"/cron/alerts","message":"Evaluated 1 alerts, 0 triggered","type":"general"}
{"timestamp":"2025-12-14T19:16:20.658Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780657","userId":null,"path":"/cron/alerts","message":"Alert cron job completed successfully","type":"general","alertsProcessed":1,"notificationsSent":0}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > cache status detection > should use N/A for delete operations
{"timestamp":"2025-12-14T19:16:20.670Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV delete: key","type":"data_operation","operation":"kv","key":"key","latencyMs":0,"cacheStatus":"N/A"}

stdout | test/get-news.spec.ts > News API > getGeneralNews > should handle API errors gracefully
{"timestamp":"2025-12-14T19:16:20.675Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"General news cache hit","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}

stdout | test/get-historical.spec.ts > getHistorical handler > Parameter validation > accepts symbol parameter
{"timestamp":"2025-12-14T19:16:20.676Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-06-17 to 2025-12-14","recordCount":0}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle array response from quote API
{"timestamp":"2025-12-14T19:16:20.693Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780693","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle array response from quote API
{"timestamp":"2025-12-14T19:16:20.693Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780693","userId":null,"path":"/cron/alerts","message":"Processing 1 active alerts","type":"general"}
{"timestamp":"2025-12-14T19:16:20.694Z","service":"stockly-api","level":"DEBUG","traceId":"cron-1765739780693","userId":null,"path":"/cron/alerts","message":"Fetching prices for 1 unique symbols","type":"general","symbols":["AAPL"]}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > cache status detection > should use N/A for list operations
{"timestamp":"2025-12-14T19:16:20.698Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV list: prefix=all","type":"data_operation","operation":"kv","key":"*","latencyMs":0,"cacheStatus":"N/A"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle array response from quote API
{"timestamp":"2025-12-14T19:16:20.694Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780693","userId":null,"path":"/cron/alerts","message":"Successfully fetched prices for 1 symbols","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle array response from quote API
{"timestamp":"2025-12-14T19:16:20.694Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780693","userId":null,"path":"/cron/alerts","message":"Evaluated 1 alerts, 0 triggered","type":"general"}
{"timestamp":"2025-12-14T19:16:20.694Z","service":"stockly-api","level":"INFO","traceId":"cron-1765739780693","userId":null,"path":"/cron/alerts","message":"Alert cron job completed successfully","type":"general","alertsProcessed":1,"notificationsSent":0}

 ✓ test/notifications/fcm-sender.spec.ts (13 tests) 949ms
stdout | test/get-stock.spec.ts > getStock handler > falls back to DB when provider returns invalid data
{"timestamp":"2025-12-14T19:16:20.712Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for TSLA","type":"general","cacheStatus":"MISS"}

stdout | test/logging/logger.spec.ts > Logger > log entry structure > should include all required fields
{"timestamp":"2025-12-14T19:16:20.712Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"Test message","type":"general"}

stdout | test/get-historical.spec.ts > getHistorical handler > Parameter validation > normalizes symbol to uppercase
[get-historical] Query result for AAPL (2025-06-17 to 2025-12-14): 0 records found in database
{"timestamp":"2025-12-14T19:16:20.713Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No historical data in database for AAPL","type":"general","dateRange":"2025-06-17 to 2025-12-14","action":"fetching from FMP API"}

stdout | test/get-stock.spec.ts > getStock handler > falls back to DB when provider returns invalid data
{"timestamp":"2025-12-14T19:16:20.712Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /quote","type":"api_call","apiProvider":"FMP","endpoint":"/quote","method":"GET","latencyMs":0}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Edge Cases > should handle no users with favorite symbols
{"timestamp":"2025-12-14T19:16:20.716Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780716","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Edge Cases > should handle no users with favorite symbols
{"timestamp":"2025-12-14T19:16:20.716Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780716","userId":null,"path":"/cron/news-alerts","message":"No favorite symbols found to check for news","type":"general"}

stdout | test/integration/stock-flow.spec.ts > Stock Data Flow Integration > Caching Flow > should cache stock data and serve from cache on subsequent requests
{"timestamp":"2025-12-14T19:16:20.723Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > uses default interval (4h) when not provided
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-12-11 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-11 to 2025-12-14

 ❯ test/devices.spec.ts (9 tests | 7 failed) 640ms
   × Devices API > getAllDevices > should return list of devices 23ms
     → expected "spy" to be called with arguments: [ StringContaining{…} ]

Received: 

  1st spy call:

  [
-   StringContaining "SELECT user_id, push_token, device_info",
+   "SELECT 
+                upt.user_id, 
+                upt.push_token, 
+                upt.device_info,
+                upt.device_type,
+                upt.created_at, 
+                upt.updated_at,
+                u.username
+              FROM user_push_tokens upt
+              LEFT JOIN users u ON upt.user_id = u.id
+              ORDER BY upt.updated_at DESC",
  ]

  2nd spy call:

  [
-   StringContaining "SELECT user_id, push_token, device_info",
+   "SELECT COUNT(*) as count FROM alerts WHERE target = ?",
  ]

  3rd spy call:

  [
-   StringContaining "SELECT user_id, push_token, device_info",
+   "SELECT COUNT(*) as count FROM alerts WHERE target = ?",
  ]

  4th spy call:

  [
-   StringContaining "SELECT user_id, push_token, device_info",
+   "SELECT COUNT(*) as count FROM alerts WHERE target = ? AND status = 'active'",
  ]

  5th spy call:

  [
-   StringContaining "SELECT user_id, push_token, device_info",
+   "SELECT COUNT(*) as count FROM alerts WHERE target = ? AND status = 'active'",
  ]


Number of calls: 5

   ✓ Devices API > getAllDevices > should return empty array when no devices 71ms
   ✓ Devices API > getAllDevices > should handle database errors 52ms
   × Devices API > sendTestNotification > should send test notification successfully 13ms
     → Cannot read properties of undefined (reading 'get')
   × Devices API > sendTestNotification > should use default message when no custom message provided 36ms
     → Cannot read properties of undefined (reading 'get')
   × Devices API > sendTestNotification > should return 404 when device not found 19ms
     → Cannot read properties of undefined (reading 'get')
   × Devices API > sendTestNotification > should return 400 when userId is missing 20ms
     → expected 405 to be 400 // Object.is equality
   × Devices API > sendTestNotification > should return 405 for non-POST methods 7ms
     → Cannot read properties of undefined (reading 'get')
   × Devices API > sendTestNotification > should handle FCM send failures 8ms
     → Cannot read properties of undefined (reading 'get')
stdout | test/integration/stock-flow.spec.ts > Stock Data Flow Integration > Caching Flow > should cache stock data and serve from cache on subsequent requests
{"timestamp":"2025-12-14T19:16:20.724Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > uses default interval (4h) when not provided
[fetch30MinuteData] Received 0 30-minute candles

stdout | test/logging/logger.spec.ts > Logger > log entry structure > should handle null userId
{"timestamp":"2025-12-14T19:16:20.737Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-123","userId":null,"path":"/v1/api/test","message":"Test","type":"general"}

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > uses default days (3) when not provided
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-12-11 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-11 to 2025-12-14

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > uses default days (3) when not provided
[fetch30MinuteData] Received 0 30-minute candles

stdout | test/get-stock.spec.ts > getStock handler > falls back to DB when provider network request fails
{"timestamp":"2025-12-14T19:16:20.761Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for MSFT","type":"general","cacheStatus":"MISS"}

stdout | test/logging/logger.spec.ts > Logger > log entry structure > should handle undefined userId
{"timestamp":"2025-12-14T19:16:20.765Z","service":"test","level":"INFO","traceId":"test","userId":null,"path":"/test","message":"Test","type":"general"}

 ✓ test/cron/alerts-cron.spec.ts (15 tests) 1050ms
stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > normalizes symbol to uppercase
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-12-11 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-11 to 2025-12-14

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > normalizes symbol to uppercase
[fetch30MinuteData] Received 0 30-minute candles

 ✓ test/logging/kv-wrapper.spec.ts (26 tests) 1577ms
stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle the complete use case: 3 PM check with multiple users and symbols
{"timestamp":"2025-12-14T19:16:20.797Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780797","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle the complete use case: 3 PM check with multiple users and symbols
{"timestamp":"2025-12-14T19:16:20.797Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780797","userId":null,"path":"/cron/news-alerts","message":"Checking news for 4 unique symbols: LXEO, AMZN, AAPL, BABA","type":"general"}
{"timestamp":"2025-12-14T19:16:20.797Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780797","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle the complete use case: 3 PM check with multiple users and symbols
{"timestamp":"2025-12-14T19:16:20.797Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780797","userId":null,"path":"/cron/news-alerts","message":"Fetched 2 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:16:20.797Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780797","userId":null,"path":"/cron/news-alerts","message":"Found news for 2 symbols: LXEO, AMZN","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle the complete use case: 3 PM check with multiple users and symbols
{"timestamp":"2025-12-14T19:16:20.798Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780797","userId":null,"path":"/cron/news-alerts","message":"New article found (published today)","type":"general","symbol":"LXEO","title":"LXEO News Today","publishedDate":"2025-12-14T10:00:00Z"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle the complete use case: 3 PM check with multiple users and symbols
{"timestamp":"2025-12-14T19:16:20.798Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780797","userId":null,"path":"/cron/news-alerts","message":"Found 2 users with LXEO in favorites: user1, user3","type":"general"}

 ✓ test/integration/stock-flow.spec.ts (3 tests) 233ms
stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle the complete use case: 3 PM check with multiple users and symbols
{"timestamp":"2025-12-14T19:16:20.798Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780797","userId":null,"path":"/cron/news-alerts","message":"Sent 3 notifications for LXEO news to 2 users","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle the complete use case: 3 PM check with multiple users and symbols
{"timestamp":"2025-12-14T19:16:20.798Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780797","userId":null,"path":"/cron/news-alerts","message":"New article found (published today)","type":"general","symbol":"AMZN","title":"AMZN News Today","publishedDate":"2025-12-14T11:00:00Z"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle the complete use case: 3 PM check with multiple users and symbols
{"timestamp":"2025-12-14T19:16:20.798Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780797","userId":null,"path":"/cron/news-alerts","message":"Found 2 users with AMZN in favorites: user1, user2","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle the complete use case: 3 PM check with multiple users and symbols
{"timestamp":"2025-12-14T19:16:20.798Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780797","userId":null,"path":"/cron/news-alerts","message":"Sent 3 notifications for AMZN news to 2 users","type":"general"}
{"timestamp":"2025-12-14T19:16:20.798Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780797","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle 7 PM check: no duplicate notifications for same articles
{"timestamp":"2025-12-14T19:16:20.819Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780819","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle 7 PM check: no duplicate notifications for same articles
{"timestamp":"2025-12-14T19:16:20.820Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780819","userId":null,"path":"/cron/news-alerts","message":"Checking news for 1 unique symbols: LXEO","type":"general"}
{"timestamp":"2025-12-14T19:16:20.820Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780819","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle 7 PM check: no duplicate notifications for same articles
{"timestamp":"2025-12-14T19:16:20.820Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780819","userId":null,"path":"/cron/news-alerts","message":"Fetched 1 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:16:20.820Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780819","userId":null,"path":"/cron/news-alerts","message":"Found news for 1 symbols: LXEO","type":"general"}

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Date range calculation > calculates correct date range based on days parameter
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-12-09 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-09 to 2025-12-14

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle 7 PM check: no duplicate notifications for same articles
{"timestamp":"2025-12-14T19:16:20.820Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780819","userId":null,"path":"/cron/news-alerts","message":"New article found (published today)","type":"general","symbol":"LXEO","title":"LXEO News Today","publishedDate":"2025-12-14T10:00:00Z"}

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Date range calculation > calculates correct date range based on days parameter
[fetch30MinuteData] Received 10 30-minute candles

 ✓ test/get-stock.spec.ts (10 tests) 723ms
stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle 7 PM check: no duplicate notifications for same articles
{"timestamp":"2025-12-14T19:16:20.820Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780819","userId":null,"path":"/cron/news-alerts","message":"Found 1 users with LXEO in favorites: user1","type":"general"}

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Date range calculation > calculates correct date range based on days parameter
[getHistoricalIntraday] Aggregated 10 30-min candles into 2 4h candles

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle 7 PM check: no duplicate notifications for same articles
{"timestamp":"2025-12-14T19:16:20.820Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780819","userId":null,"path":"/cron/news-alerts","message":"Sent 1 notifications for LXEO news to 1 users","type":"general"}
{"timestamp":"2025-12-14T19:16:20.820Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780819","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle 7 PM check: no duplicate notifications for same articles
{"timestamp":"2025-12-14T19:16:20.820Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780820","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle 7 PM check: no duplicate notifications for same articles
{"timestamp":"2025-12-14T19:16:20.820Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765739780820","userId":null,"path":"/cron/news-alerts","message":"No favorite symbols found to check for news","type":"general"}

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Invalid Input Handling > should handle invalid symbol format
{"timestamp":"2025-12-14T19:16:20.858Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /quote","type":"api_call","apiProvider":"FMP","endpoint":"/quote","method":"GET","statusCode":200,"latencyMs":355}

 ✓ test/cron/news-alert-cron.spec.ts (18 tests) 1598ms
stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > FMP API integration > handles FMP API errors gracefully
[getHistoricalIntraday] Fetching 4h data for INVALID (2025-12-11 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for INVALID from 2025-12-11 to 2025-12-14

 ❯ test/get-news.spec.ts (7 tests | 6 failed) 299ms
   ✓ News API > getGeneralNews > should return general news from FMP API 34ms
   × News API > getGeneralNews > should handle API errors gracefully 14ms
     → expected [ { title: 'Apple News', …(7) } ] to deeply equal []
   × News API > getFavoriteNews > should return news for favorite symbols 15ms
     → expected 401 to be 200 // Object.is equality
   × News API > getFavoriteNews > should return empty list if no favorites 8ms
     → expected 401 to be 200 // Object.is equality
   × News API > News Archive > should toggle archived news 5ms
     → expected 401 to be 200 // Object.is equality
   × News API > News Archive > should retrieve archived news 7ms
     → expected 401 to be 200 // Object.is equality
   × News API > User Preferences > should update news favorite symbols 7ms
     → (0 , updatePreferences) is not a function
stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > FMP API integration > filters out invalid records from API response
[getHistoricalIntraday] Fetching 1h data for AAPL (2025-12-11 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-11 to 2025-12-14

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > FMP API integration > filters out invalid records from API response
[fetch30MinuteData] Received 4 30-minute candles

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > FMP API integration > filters out invalid records from API response
[getHistoricalIntraday] Aggregated 2 30-min candles into 2 1h candles

 ❯ test/api/auth.spec.ts (14 tests | 7 failed) 748ms
   ✓ Authentication API > handleGoogleAuth > should reject non-POST requests 51ms
   × Authentication API > handleGoogleAuth > should reject requests without idToken 39ms
     → expected 401 to be 400 // Object.is equality
   × Authentication API > handleGoogleAuth > should reject invalid JSON payload 14ms
     → Invalid URL: /v1/api/auth/google
   ✓ Authentication API > checkUsernameAvailability > should return available for new username 62ms
   × Authentication API > checkUsernameAvailability > should return unavailable for existing username 23ms
     → expected true to be false // Object.is equality
   × Authentication API > checkUsernameAvailability > should reject invalid username format 7ms
     → expected 200 to be 400 // Object.is equality
   × Authentication API > checkUsernameAvailability > should reject reserved usernames 8ms
     → expected 200 to be 400 // Object.is equality
   ✓ Authentication API > setUsername > should set username for authenticated user 26ms
   ✓ Authentication API > setUsername > should reject username if already taken 25ms
   ✓ Authentication API > refreshToken > should refresh access token with valid refresh token 26ms
   ✓ Authentication API > refreshToken > should reject invalid refresh token 21ms
   ✓ Authentication API > getCurrentUser > should return current user for authenticated request 21ms
   × Authentication API > getCurrentUser > should return 401 for unauthenticated request 10ms
     → expected 400 to be 401 // Object.is equality
   × Authentication API > logout > should clear cookies and return success 7ms
     → [vitest] No "clearHttpOnlyCookie" export is defined on the "../../src/auth/middleware" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Invalid Input Handling > should handle invalid symbol format
{"timestamp":"2025-12-14T19:16:20.953Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","statusCode":200,"latencyMs":95}

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Invalid Input Handling > should handle invalid symbol format
{"timestamp":"2025-12-14T19:16:20.954Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API response","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile?symbol=!!!&apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","responseType":"array","responseLength":0}
{"timestamp":"2025-12-14T19:16:20.954Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API returned empty array","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile?symbol=!!!&apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM"}

 ❯ test/api/admin.spec.ts (14 tests | 12 failed) 561ms
   × Admin API > getRecentNotifications > should return recent notifications 20ms
     → expected 400 to be 200 // Object.is equality
   × Admin API > getRecentNotifications > should return empty array when no notifications 20ms
     → expected 400 to be 200 // Object.is equality
   × Admin API > getRecentNotifications > should handle database errors 9ms
     → expected 400 to be 500 // Object.is equality
   × Admin API > getRecentNotifications > should limit to 100 notifications 9ms
     → Cannot read properties of undefined (reading 'get')
   × Admin API > getRecentNotifications > should order by sent_at DESC 6ms
     → Cannot read properties of undefined (reading 'get')
   × Admin API > getFailedNotifications > should return only failed notifications 8ms
     → expected "spy" to be called with arguments: [ StringContaining{…} ]

Received: 

  1st spy call:

  [
-   StringContaining "WHERE status IN ('failed', 'error')",
+   "SELECT 
+            nl.id, 
+            nl.alert_id, 
+            nl.symbol, 
+            nl.threshold, 
+            nl.price, 
+            nl.direction, 
+            nl.push_token, 
+            nl.status, 
+            nl.error_message, 
+            nl.attempt_count, 
+            nl.sent_at,
+            nl.username
+          FROM notifications_log nl
+          WHERE nl.status IN ('failed', 'error')
+          ORDER BY nl.sent_at DESC
+          LIMIT 100",
  ]


Number of calls: 1

   ✓ Admin API > getFailedNotifications > should return empty array when no failed notifications 38ms
   ✓ Admin API > getFailedNotifications > should handle database errors 27ms
   × Admin API > retryNotification > should retry failed notification successfully 8ms
     → expected 400 to be 200 // Object.is equality
   × Admin API > retryNotification > should return 404 when log not found 13ms
     → Cannot read properties of undefined (reading 'get')
   × Admin API > retryNotification > should handle retry failure 5ms
     → expected 400 to be 200 // Object.is equality
   × Admin API > retryNotification > should create new log entry with attempt count 1 4ms
     → expected "spy" to be called with arguments: [ StringContaining "retry", …(10) ]

Number of calls: 0

   × Admin API > retryNotification > should handle database errors during retry 4ms
     → expected 400 to be 500 // Object.is equality
   × Admin API > retryNotification > should handle FCM send errors 4ms
     → expected 400 to be 200 // Object.is equality
 ✓ test/logging/logger.spec.ts (31 tests) 1914ms
stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > OHLC aggregation > aggregates 30-minute data to 1-hour intervals
[getHistoricalIntraday] Fetching 1h data for AAPL (2025-12-13 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-13 to 2025-12-14

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > OHLC aggregation > aggregates 30-minute data to 1-hour intervals
[fetch30MinuteData] Received 4 30-minute candles

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > OHLC aggregation > aggregates 30-minute data to 1-hour intervals
[getHistoricalIntraday] Aggregated 4 30-min candles into 2 1h candles

stdout | test/api-comprehensive.spec.ts > API - Get Single Stock > GET /v1/api/get-stock returns stock data with all required fields
{"timestamp":"2025-12-14T19:16:20.975Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for AAPL","type":"general","cacheStatus":"MISS"}

stdout | test/api-comprehensive.spec.ts > API - Get Single Stock > GET /v1/api/get-stock returns stock data with all required fields
{"timestamp":"2025-12-14T19:16:20.976Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /quote","type":"api_call","apiProvider":"FMP","endpoint":"/quote","method":"GET","latencyMs":0}

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > OHLC aggregation > aggregates 30-minute data to 4-hour intervals
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-12-13 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-13 to 2025-12-14

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > OHLC aggregation > aggregates 30-minute data to 4-hour intervals
[fetch30MinuteData] Received 8 30-minute candles

stdout | test/api-comprehensive.spec.ts > API - Get Single Stock > GET /v1/api/get-stock returns stock data with all required fields
{"timestamp":"2025-12-14T19:16:20.977Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","statusCode":404,"latencyMs":1}

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > OHLC aggregation > aggregates 30-minute data to 4-hour intervals
[getHistoricalIntraday] Aggregated 8 30-min candles into 2 4h candles

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > OHLC aggregation > correctly calculates OHLC values during aggregation
[getHistoricalIntraday] Fetching 1h data for AAPL (2025-12-13 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-13 to 2025-12-14

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > OHLC aggregation > correctly calculates OHLC values during aggregation
[fetch30MinuteData] Received 4 30-minute candles

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > OHLC aggregation > correctly calculates OHLC values during aggregation
[getHistoricalIntraday] Aggregated 4 30-min candles into 2 1h candles

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Response format > returns correct JSON structure on success
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-12-11 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-11 to 2025-12-14

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Response format > returns correct JSON structure on success
[fetch30MinuteData] Received 10 30-minute candles

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Response format > returns correct JSON structure on success
[getHistoricalIntraday] Aggregated 10 30-min candles into 2 4h candles

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Response format > returns correct structure on empty data
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-12-11 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-11 to 2025-12-14

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Response format > returns correct structure on empty data
[fetch30MinuteData] Received 0 30-minute candles

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Error handling > handles network errors
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-12-11 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-11 to 2025-12-14

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Error handling > handles invalid JSON response
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-12-11 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-11 to 2025-12-14

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Invalid Input Handling > should handle invalid symbol format
{"timestamp":"2025-12-14T19:16:21.051Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","statusCode":404,"latencyMs":97}

 ❯ test/api-schema-validation.spec.ts (16 tests | 11 failed) 351ms
   ✓ API Schema Validation - Health Check > health endpoint returns valid HealthCheckResponse schema 27ms
   × API Schema Validation - Get Stock > getStock returns valid StockQuoteResponse schema on success 13ms
     → Cannot read properties of undefined (reading 'get')
   × API Schema Validation - Get Stock > getStock returns valid ErrorResponse schema on error 16ms
     → Cannot read properties of undefined (reading 'get')
   × API Schema Validation - Get Stocks > getStocks returns valid StockQuotesResponse schema on success 5ms
     → Cannot read properties of undefined (reading 'get')
   × API Schema Validation - Get Stocks > getStocks returns valid ErrorResponse schema on error 6ms
     → Cannot read properties of undefined (reading 'get')
   × API Schema Validation - Search Stock > searchStock returns valid SearchStockResponse schema 6ms
     → Cannot read properties of undefined (reading 'get')
   × API Schema Validation - Get Historical > getHistorical returns valid HistoricalPricesResponse schema 5ms
     → Cannot read properties of undefined (reading 'get')
   × API Schema Validation - Get Historical > getHistorical returns valid ErrorResponse schema on error 4ms
     → Cannot read properties of undefined (reading 'get')
   × API Schema Validation - Alerts > listAlerts returns valid AlertsListResponse schema 7ms
     → expected 401 to be 200 // Object.is equality
   × API Schema Validation - Alerts > createAlert accepts valid CreateAlertRequest schema 3ms
     → expected 401 to be 201 // Object.is equality
   × API Schema Validation - Alerts > updateAlert accepts valid UpdateAlertRequest schema 3ms
     → expected 401 to be 200 // Object.is equality
   × API Schema Validation - Alerts > getAlert returns valid Alert schema 4ms
     → expected 401 to be 200 // Object.is equality
   ✓ API Schema Validation - Input Validation > rejects invalid CreateAlertRequest 6ms
   ✓ API Schema Validation - Input Validation > accepts valid CreateAlertRequest with optional fields 8ms
   ✓ API Schema Validation - Input Validation > rejects invalid UpdateAlertRequest 5ms
   ✓ API Schema Validation - Input Validation > accepts partial UpdateAlertRequest 6ms
 ❯ test/api/get-historical-intraday.spec.ts (19 tests | 6 failed) 1112ms
   ✓ getHistoricalIntraday handler > Parameter validation > requires a symbol parameter 36ms
   × getHistoricalIntraday handler > Parameter validation > validates days parameter - must be between 1 and 30 467ms
     → expected 500 to be 200 // Object.is equality
   × getHistoricalIntraday handler > Parameter validation > validates interval format 112ms
     → expected 500 to be 400 // Object.is equality
   ✓ getHistoricalIntraday handler > Parameter validation > uses default interval (4h) when not provided 25ms
   ✓ getHistoricalIntraday handler > Parameter validation > uses default days (3) when not provided 28ms
   ✓ getHistoricalIntraday handler > Parameter validation > normalizes symbol to uppercase 27ms
   ✓ getHistoricalIntraday handler > Date range calculation > calculates correct date range based on days parameter 23ms
   × getHistoricalIntraday handler > FMP API integration > calls FMP API with correct parameters 8ms
     → Cannot read properties of undefined (reading 'get')
   ✓ getHistoricalIntraday handler > FMP API integration > handles FMP API errors gracefully 15ms
   × getHistoricalIntraday handler > FMP API integration > handles HTTP errors from FMP API 8ms
     → Cannot read properties of undefined (reading 'get')
   × getHistoricalIntraday handler > FMP API integration > handles empty data response 4ms
     → Cannot read properties of undefined (reading 'get')
   ✓ getHistoricalIntraday handler > FMP API integration > filters out invalid records from API response 16ms
   ✓ getHistoricalIntraday handler > OHLC aggregation > aggregates 30-minute data to 1-hour intervals 11ms
   ✓ getHistoricalIntraday handler > OHLC aggregation > aggregates 30-minute data to 4-hour intervals 10ms
   × getHistoricalIntraday handler > OHLC aggregation > correctly calculates OHLC values during aggregation 3ms
     → expected 103 to be 105 // Object.is equality
   ✓ getHistoricalIntraday handler > Response format > returns correct JSON structure on success 8ms
   ✓ getHistoricalIntraday handler > Response format > returns correct structure on empty data 12ms
   ✓ getHistoricalIntraday handler > Error handling > handles network errors 10ms
   ✓ getHistoricalIntraday handler > Error handling > handles invalid JSON response 8ms
 ❯ test/api-integration.spec.ts (17 tests | 16 failed) 351ms
   ✓ API Integration - Health Check > health endpoint returns OK status 29ms
   × API Integration - Get Stock > successfully fetches and returns stock data with all required fields 15ms
     → Cannot read properties of undefined (reading 'get')
   × API Integration - Get Stock > returns error when symbol is missing 16ms
     → Cannot read properties of undefined (reading 'get')
   × API Integration - Get Stock > uses cache when available 8ms
     → Cannot read properties of undefined (reading 'get')
   × API Integration - Get Stocks > successfully fetches multiple stocks with all required fields 5ms
     → Cannot read properties of undefined (reading 'get')
   × API Integration - Get Stocks > returns error when symbols parameter is missing 5ms
     → Cannot read properties of undefined (reading 'get')
   × API Integration - Get Stocks > handles empty symbols list 4ms
     → Cannot read properties of undefined (reading 'get')
   × API Integration - Search Stock > successfully searches and returns matching stocks 5ms
     → Cannot read properties of undefined (reading 'get')
   × API Integration - Search Stock > returns empty array when query parameter is missing 5ms
     → Cannot read properties of undefined (reading 'get')
   × API Integration - Get Historical > successfully fetches historical price data 4ms
     → Cannot read properties of undefined (reading 'get')
   × API Integration - Get Historical > returns error when symbol is missing 3ms
     → Cannot read properties of undefined (reading 'get')
   × API Integration - Get Historical > validates days parameter 3ms
     → Cannot read properties of undefined (reading 'get')
   × API Integration - Alerts > successfully lists all alerts 6ms
     → expected 401 to be 200 // Object.is equality
   × API Integration - Alerts > successfully creates an alert 3ms
     → expected 401 to be 201 // Object.is equality
   × API Integration - Alerts > successfully updates an alert 4ms
     → expected 401 to be 200 // Object.is equality
   × API Integration - Alerts > successfully deletes an alert 3ms
     → expected 401 to be 200 // Object.is equality
   × API Integration - Alerts > returns 404 when alert not found 2ms
     → expected 401 to be 404 // Object.is equality
 ✓ test/api/devices.spec.ts (25 tests) 534ms
 ✓ test/index.spec.ts (6 tests) 29ms
stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Invalid Input Handling > should handle invalid symbol format
{"timestamp":"2025-12-14T19:16:21.143Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","statusCode":404,"latencyMs":91}

stdout | test/get-historical.spec.ts > getHistorical handler > Parameter validation > normalizes symbol to uppercase
{"timestamp":"2025-12-14T19:16:21.213Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-06-17 to 2025-12-14","recordCount":0}

stdout | test/get-historical.spec.ts > getHistorical handler > Date range parameters (from/to) > accepts from and to parameters
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-31): 3 records found in database

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Invalid Input Handling > should handle invalid symbol format
{"timestamp":"2025-12-14T19:16:21.366Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","statusCode":403,"latencyMs":222}

stdout | test/api-comprehensive.spec.ts > API - Get Single Stock > GET /v1/api/get-stock returns stock data with all required fields
{"timestamp":"2025-12-14T19:16:21.394Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","statusCode":404,"latencyMs":417}

stdout | test/api-comprehensive.spec.ts > API - Get Single Stock > GET /v1/api/get-stock returns stock data with all required fields
{"timestamp":"2025-12-14T19:16:21.511Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","statusCode":404,"latencyMs":117}

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Invalid Input Handling > should handle invalid symbol format
{"timestamp":"2025-12-14T19:16:21.516Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Final description resolved","type":"general","hasDescription":false,"descriptionLength":0,"source":"none"}

stdout | test/api-comprehensive.spec.ts > API - Get Single Stock > GET /v1/api/get-stock returns stock data with all required fields
{"timestamp":"2025-12-14T19:16:21.608Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","statusCode":403,"latencyMs":96}

stdout | test/api-comprehensive.spec.ts > API - Get Single Stock > GET /v1/api/get-stock returns stock data with all required fields
{"timestamp":"2025-12-14T19:16:21.609Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Final description resolved","type":"general","hasDescription":true,"descriptionLength":38,"source":"quote"}

stdout | test/api-comprehensive.spec.ts > API - Get Historical > GET /v1/api/get-historical returns historical data
[getHistoricalPricesByDateRange] Querying database for AAPL from 2025-06-17 to 2025-12-14

stdout | test/api-comprehensive.spec.ts > API - Get Historical > GET /v1/api/get-historical returns historical data
[getHistoricalPricesByDateRange] Found 2 records for AAPL in date range 2025-06-17 to 2025-12-14

stdout | test/api-comprehensive.spec.ts > API - Get Historical > GET /v1/api/get-historical returns historical data
[get-historical] Query result for AAPL (2025-06-17 to 2025-12-14): 2 records found in database
{"timestamp":"2025-12-14T19:16:21.634Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No historical data in database for AAPL","type":"general","dateRange":"2025-06-17 to 2025-12-14","action":"fetching from FMP API"}
[fetchAndSaveHistoricalPrice] Starting fetch for AAPL from FMP API
[fetchAndSaveHistoricalPrice] Fetching from: https://financialmodelingprep.com/stable/historical-chart/30min?symbol=AAPL&apikey=***&from=2025-06-17&to=2025-12-14

stdout | test/api-comprehensive.spec.ts > API - Get Historical > GET /v1/api/get-historical returns historical data
[fetchAndSaveHistoricalPrice] Received 2 1-hour OHLC records from FMP API
[fetchAndSaveHistoricalPrice] FMP API returned 2 records for AAPL
[fetchAndSaveHistoricalPrice] Sample record structure: {
  date: undefined,
  hasOpen: false,
  hasHigh: false,
  hasLow: false,
  hasClose: false,
  hasPrice: false,
  keys: [ 'symbol', 'name', 'currency', 'stockExchange' ]
}
Saved 0 daily candles (aggregated from 2 1-hour records) for AAPL with OHLC data

stdout | test/get-historical.spec.ts > getHistorical handler > Date range parameters (from/to) > accepts from and to parameters
{"timestamp":"2025-12-14T19:16:21.723Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","recordCount":3}
[get-historical] Successfully fetched 3 historical records for AAPL from FMP API

stdout | test/get-historical.spec.ts > getHistorical handler > Date range parameters (from/to) > allows from and to to be the same date
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-01): 1 records found in database

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Database Error Handling > should handle database connection errors gracefully
{"timestamp":"2025-12-14T19:16:21.990Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for AAPL","type":"general","cacheStatus":"MISS"}

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Database Error Handling > should handle database connection errors gracefully
{"timestamp":"2025-12-14T19:16:22.084Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /quote","type":"api_call","apiProvider":"FMP","endpoint":"/quote","method":"GET","statusCode":200,"latencyMs":94}

stdout | test/api-comprehensive.spec.ts > API - Get Historical > GET /v1/api/get-historical returns historical data
[getHistoricalPricesByDateRange] Querying database for AAPL from 2025-06-17 to 2025-12-14

stdout | test/api-comprehensive.spec.ts > API - Get Historical > GET /v1/api/get-historical returns historical data
[getHistoricalPricesByDateRange] Found 2 records for AAPL in date range 2025-06-17 to 2025-12-14

stdout | test/api-comprehensive.spec.ts > API - Get Historical > GET /v1/api/get-historical returns historical data
{"timestamp":"2025-12-14T19:16:22.138Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-06-17 to 2025-12-14","recordCount":2}
[get-historical] Successfully fetched 2 historical records for AAPL from FMP API

stdout | test/api-comprehensive.spec.ts > API - Alerts > GET /v1/api/alerts lists all alerts
{"timestamp":"2025-12-14T19:16:22.147Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Alerts request authenticated","type":"general","username":"testuser","isAdmin":false,"requestUsername":"testuser","method":"GET"}

stdout | test/api-comprehensive.spec.ts > API - Alerts > GET /v1/api/alerts lists all alerts
{"timestamp":"2025-12-14T19:16:22.147Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Fetched alerts from D1","type":"general","username":"testuser","alertCount":1,"alertIds":["alert-123"]}

stdout | test/api-comprehensive.spec.ts > API - Alerts > POST /v1/api/alerts creates a new alert
{"timestamp":"2025-12-14T19:16:22.153Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Alerts request authenticated","type":"general","username":"testuser","isAdmin":false,"requestUsername":"testuser","method":"POST"}

stdout | test/api-comprehensive.spec.ts > API - Alerts > POST /v1/api/alerts creates a new alert
{"timestamp":"2025-12-14T19:16:22.153Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Creating alert","type":"general","username":"testuser","symbol":"AAPL","direction":"above","threshold":200}

stdout | test/api-comprehensive.spec.ts > API - Alerts > POST /v1/api/alerts creates a new alert
{"timestamp":"2025-12-14T19:16:22.153Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Created alert successfully","type":"general","alertId":"alert-123","username":"testuser","alertUsername":"testuser","isAdmin":false}

stdout | test/api-comprehensive.spec.ts > API - Alerts > GET /v1/api/alerts/:id gets a specific alert
{"timestamp":"2025-12-14T19:16:22.157Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Alerts request authenticated","type":"general","username":"testuser","isAdmin":false,"requestUsername":"testuser","method":"GET"}

stdout | test/api-comprehensive.spec.ts > API - Alerts > PUT /v1/api/alerts/:id updates an alert
{"timestamp":"2025-12-14T19:16:22.160Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Alerts request authenticated","type":"general","username":"testuser","isAdmin":false,"requestUsername":"testuser","method":"PUT"}

stdout | test/api-comprehensive.spec.ts > API - Alerts > PUT /v1/api/alerts/:id updates an alert
{"timestamp":"2025-12-14T19:16:22.160Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Updated alert","type":"general","alertId":"alert-123","username":"testuser"}

stdout | test/api-comprehensive.spec.ts > API - Alerts > DELETE /v1/api/alerts/:id deletes an alert
{"timestamp":"2025-12-14T19:16:22.163Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Alerts request authenticated","type":"general","username":"testuser","isAdmin":false,"requestUsername":"testuser","method":"DELETE"}

stdout | test/api-comprehensive.spec.ts > API - Alerts > DELETE /v1/api/alerts/:id deletes an alert
{"timestamp":"2025-12-14T19:16:22.164Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Deleted alert","type":"general","alertId":"alert-123","username":"testuser"}

stdout | test/api-comprehensive.spec.ts > API - Push Token > POST /v1/api/push-token registers a new push token
✅ FCM token validation passed: length=30, format valid

stdout | test/api-comprehensive.spec.ts > API - Push Token > POST /v1/api/push-token registers a new push token
{"timestamp":"2025-12-14T19:16:22.169Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Registering new push token","type":"general","username":"testuser","deviceType":"ios","tokenPreview":"fcm-token-1234567890..."}

stdout | test/api-comprehensive.spec.ts > API - Push Token > POST /v1/api/push-token registers a new push token
{"timestamp":"2025-12-14T19:16:22.170Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Push token registered successfully","type":"general","username":"testuser","deviceType":"ios","deviceId":"fcm-token-1234567890..."}

stdout | test/api-comprehensive.spec.ts > API - Push Token > POST /v1/api/push-token updates existing push token
✅ FCM token validation passed: length=30, format valid

stdout | test/api-comprehensive.spec.ts > API - Push Token > POST /v1/api/push-token updates existing push token
{"timestamp":"2025-12-14T19:16:22.174Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Updating existing push token","type":"general","username":"testuser","deviceType":"ios"}

stdout | test/api-comprehensive.spec.ts > API - Push Token > POST /v1/api/push-token updates existing push token
{"timestamp":"2025-12-14T19:16:22.174Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Push token updated successfully","type":"general","username":"testuser","deviceType":"ios"}

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Database Error Handling > should handle database connection errors gracefully
{"timestamp":"2025-12-14T19:16:22.179Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","statusCode":200,"latencyMs":95}

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Database Error Handling > should handle database connection errors gracefully
{"timestamp":"2025-12-14T19:16:22.179Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API response","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile?symbol=AAPL&apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","responseType":"array","responseLength":1}
{"timestamp":"2025-12-14T19:16:22.179Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Found description from profile","type":"general","descriptionLength":1665}
{"timestamp":"2025-12-14T19:16:22.179Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Final description resolved","type":"general","hasDescription":true,"descriptionLength":1665,"source":"profile"}

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Database Error Handling > should handle database timeout errors
{"timestamp":"2025-12-14T19:16:22.186Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > External API Error Handling > should handle external API rate limiting
{"timestamp":"2025-12-14T19:16:22.194Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > External API Error Handling > should handle external API timeout
{"timestamp":"2025-12-14T19:16:22.199Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > External API Error Handling > should handle external API returning invalid JSON
{"timestamp":"2025-12-14T19:16:22.203Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}

stdout | test/get-historical.spec.ts > getHistorical handler > Date range parameters (from/to) > allows from and to to be the same date
{"timestamp":"2025-12-14T19:16:22.235Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-01","recordCount":1}
[get-historical] Successfully fetched 1 historical records for AAPL from FMP API

stdout | test/get-historical.spec.ts > getHistorical handler > Date range parameters (from/to) > defaults to today when only 'to' is provided
[get-historical] Query result for AAPL (2024-08-03 to 2025-01-31): 0 records found in database
{"timestamp":"2025-12-14T19:16:22.243Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No historical data in database for AAPL","type":"general","dateRange":"2024-08-03 to 2025-01-31","action":"fetching from FMP API"}

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Concurrent Request Handling > should handle multiple simultaneous requests for same symbol
{"timestamp":"2025-12-14T19:16:22.245Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}
{"timestamp":"2025-12-14T19:16:22.245Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}
{"timestamp":"2025-12-14T19:16:22.245Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}
{"timestamp":"2025-12-14T19:16:22.245Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}
{"timestamp":"2025-12-14T19:16:22.245Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}
{"timestamp":"2025-12-14T19:16:22.245Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}
{"timestamp":"2025-12-14T19:16:22.245Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}
{"timestamp":"2025-12-14T19:16:22.245Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}
{"timestamp":"2025-12-14T19:16:22.245Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}
{"timestamp":"2025-12-14T19:16:22.246Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}

stdout | test/api-comprehensive.spec.ts > API - Devices > DELETE /v1/api/devices deletes a device
{"timestamp":"2025-12-14T19:16:22.253Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Device deleted successfully","type":"general","deletedPushToken":"fcm-token-1234567890...","deletedUserId":"user-123","deletedBy":"testuser","isAdmin":true}

 ❯ test/api/edge-cases.spec.ts (19 tests | 5 failed) 1864ms
   ✓ Edge Cases and Error Scenarios > Invalid Input Handling > should handle empty symbol in getStock 46ms
   ✓ Edge Cases and Error Scenarios > Invalid Input Handling > should handle invalid symbol format  1046ms
   ✓ Edge Cases and Error Scenarios > Invalid Input Handling > should handle empty symbols array in getStocks 4ms
   × Edge Cases and Error Scenarios > Invalid Input Handling > should handle very long symbol list in getStocks 2ms
     → Cannot read properties of undefined (reading 'bind')
   × Edge Cases and Error Scenarios > Invalid Input Handling > should handle empty search query 2ms
     → expected 200 to be greater than or equal to 400
   ✓ Edge Cases and Error Scenarios > Invalid Input Handling > should handle SQL injection attempts in search  448ms
   ✓ Edge Cases and Error Scenarios > Database Error Handling > should handle database connection errors gracefully 195ms
   × Edge Cases and Error Scenarios > Database Error Handling > should handle database timeout errors 2ms
     → expected 200 to be greater than or equal to 500
   ✓ Edge Cases and Error Scenarios > External API Error Handling > should handle external API rate limiting 4ms
   × Edge Cases and Error Scenarios > External API Error Handling > should handle external API timeout 2ms
     → expected 200 to be greater than or equal to 500
   × Edge Cases and Error Scenarios > External API Error Handling > should handle external API returning invalid JSON 2ms
     → expected 200 to be greater than or equal to 500
   ✓ Edge Cases and Error Scenarios > Authentication Edge Cases > should handle expired access token 5ms
   ✓ Edge Cases and Error Scenarios > Authentication Edge Cases > should handle malformed authorization header 3ms
   ✓ Edge Cases and Error Scenarios > Alert Edge Cases > should handle negative threshold values 4ms
   ✓ Edge Cases and Error Scenarios > Alert Edge Cases > should handle extremely large threshold values 3ms
   ✓ Edge Cases and Error Scenarios > Alert Edge Cases > should handle missing required fields in alert creation 3ms
   ✓ Edge Cases and Error Scenarios > Boundary Conditions > should handle maximum number of symbols in batch request 3ms
   ✓ Edge Cases and Error Scenarios > Boundary Conditions > should handle very long search query 5ms
   ✓ Edge Cases and Error Scenarios > Concurrent Request Handling > should handle multiple simultaneous requests for same symbol 4ms
 ✓ test/api-comprehensive.spec.ts (35 tests) 1342ms
   ✓ API - Get Single Stock > GET /v1/api/get-stock returns stock data with all required fields  642ms
   ✓ API - Get Historical > GET /v1/api/get-historical returns historical data  508ms
stdout | test/get-stock-details.spec.ts > getStockDetails service > returns error when all critical endpoints fail
Cache miss for stock details: AAPL, fetching...

stdout | test/get-historical.spec.ts > getHistorical handler > Date range parameters (from/to) > defaults to today when only 'to' is provided
{"timestamp":"2025-12-14T19:16:22.744Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2024-08-03 to 2025-01-31","recordCount":0}

stdout | test/get-historical.spec.ts > getHistorical handler > Date range parameters (from/to) > defaults to today when only 'from' is provided
[get-historical] Query result for AAPL (2025-01-01 to 2025-12-14): 0 records found in database
{"timestamp":"2025-12-14T19:16:22.749Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No historical data in database for AAPL","type":"general","dateRange":"2025-01-01 to 2025-12-14","action":"fetching from FMP API"}

stdout | test/get-historical.spec.ts > getHistorical handler > Date range parameters (from/to) > defaults to today when only 'from' is provided
{"timestamp":"2025-12-14T19:16:23.250Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-01-01 to 2025-12-14","recordCount":0}

stdout | test/get-historical.spec.ts > getHistorical handler > Days parameter (backward compatibility) > accepts days parameter
[get-historical] Query result for AAPL (2025-11-14 to 2025-12-14): 2 records found in database

stdout | test/get-historical.spec.ts > getHistorical handler > Days parameter (backward compatibility) > accepts days parameter
{"timestamp":"2025-12-14T19:16:23.757Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-11-14 to 2025-12-14","recordCount":2}
[get-historical] Successfully fetched 2 historical records for AAPL from FMP API

stdout | test/get-historical.spec.ts > getHistorical handler > Days parameter (backward compatibility) > defaults to 180 days when no parameters provided
[get-historical] Query result for AAPL (2025-06-17 to 2025-12-14): 0 records found in database
{"timestamp":"2025-12-14T19:16:23.763Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No historical data in database for AAPL","type":"general","dateRange":"2025-06-17 to 2025-12-14","action":"fetching from FMP API"}

stdout | test/get-historical.spec.ts > getHistorical handler > Days parameter (backward compatibility) > defaults to 180 days when no parameters provided
{"timestamp":"2025-12-14T19:16:24.263Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-06-17 to 2025-12-14","recordCount":0}

stdout | test/get-historical.spec.ts > getHistorical handler > Parameter priority > prioritizes from/to parameters over days parameter
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-31): 1 records found in database

stdout | test/get-historical.spec.ts > getHistorical handler > Parameter priority > prioritizes from/to parameters over days parameter
{"timestamp":"2025-12-14T19:16:24.779Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","recordCount":1}
[get-historical] Successfully fetched 1 historical records for AAPL from FMP API

stdout | test/get-historical.spec.ts > getHistorical handler > Database query > queries database with correct date range
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-31): 2 records found in database

stdout | test/get-historical.spec.ts > getHistorical handler > Database query > queries database with correct date range
{"timestamp":"2025-12-14T19:16:25.287Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","recordCount":2}
[get-historical] Successfully fetched 2 historical records for AAPL from FMP API

stdout | test/get-historical.spec.ts > getHistorical handler > Database query > returns data from database when available
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-31): 3 records found in database

stdout | test/get-historical.spec.ts > getHistorical handler > Database query > returns data from database when available
{"timestamp":"2025-12-14T19:16:25.795Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","recordCount":3}
[get-historical] Successfully fetched 3 historical records for AAPL from FMP API

stdout | test/get-historical.spec.ts > getHistorical handler > Database query > returns empty array when database has no data
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-31): 0 records found in database
{"timestamp":"2025-12-14T19:16:25.799Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No historical data in database for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","action":"fetching from FMP API"}

stdout | test/get-historical.spec.ts > getHistorical handler > Database query > returns empty array when database has no data
{"timestamp":"2025-12-14T19:16:26.300Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","recordCount":0}

stdout | test/get-historical.spec.ts > getHistorical handler > FMP API fallback > fetches from FMP API when database is empty and ctx is available
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-31): 0 records found in database
{"timestamp":"2025-12-14T19:16:26.307Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No historical data in database for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","action":"fetching from FMP API"}

stdout | test/get-historical.spec.ts > getHistorical handler > FMP API fallback > fetches from FMP API when database is empty and ctx is available
{"timestamp":"2025-12-14T19:16:26.807Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","recordCount":1}
[get-historical] Successfully fetched 1 historical records for AAPL from FMP API

stdout | test/get-historical.spec.ts > getHistorical handler > FMP API fallback > creates fallback ExecutionContext when ctx is not available and fetches from FMP API
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-31): 0 records found in database
{"timestamp":"2025-12-14T19:16:26.813Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No historical data in database for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","action":"fetching from FMP API"}

stdout | test/get-historical.spec.ts > getHistorical handler > FMP API fallback > creates fallback ExecutionContext when ctx is not available and fetches from FMP API
{"timestamp":"2025-12-14T19:16:27.314Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","recordCount":1}
[get-historical] Successfully fetched 1 historical records for AAPL from FMP API

stdout | test/get-historical.spec.ts > getHistorical handler > FMP API fallback > handles FMP API fetch errors gracefully
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-31): 0 records found in database
{"timestamp":"2025-12-14T19:16:27.319Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No historical data in database for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","action":"fetching from FMP API"}

stdout | test/get-historical.spec.ts > getHistorical handler > Response format > returns correct response format with from/to parameters
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-31): 1 records found in database

stdout | test/get-historical.spec.ts > getHistorical handler > Response format > returns correct response format with from/to parameters
{"timestamp":"2025-12-14T19:16:27.824Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","recordCount":1}
[get-historical] Successfully fetched 1 historical records for AAPL from FMP API

stdout | test/get-historical.spec.ts > getHistorical handler > Response format > returns correct response format with days parameter
[get-historical] Query result for AAPL (2025-11-14 to 2025-12-14): 1 records found in database

stdout | test/get-historical.spec.ts > getHistorical handler > Response format > returns correct response format with days parameter
{"timestamp":"2025-12-14T19:16:28.329Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-11-14 to 2025-12-14","recordCount":1}
[get-historical] Successfully fetched 1 historical records for AAPL from FMP API

stdout | test/get-historical.spec.ts > getHistorical handler > Response format > includes all required fields in data items
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-31): 1 records found in database

stdout | test/get-historical.spec.ts > getHistorical handler > Response format > includes all required fields in data items
{"timestamp":"2025-12-14T19:16:28.834Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","recordCount":1}
[get-historical] Successfully fetched 1 historical records for AAPL from FMP API

stdout | test/get-historical.spec.ts > getHistorical handler > Missing OHLC data handling > re-fetches from FMP API when OHLC data is missing (null)
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-31): 1 records found in database
{"timestamp":"2025-12-14T19:16:28.840Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No historical data in database for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","action":"fetching from FMP API"}

stdout | test/get-historical.spec.ts > getHistorical handler > Missing OHLC data handling > re-fetches from FMP API when OHLC data is missing (null)
{"timestamp":"2025-12-14T19:16:29.340Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","recordCount":1}
[get-historical] Successfully fetched 1 historical records for AAPL from FMP API

stdout | test/get-historical.spec.ts > getHistorical handler > Missing OHLC data handling > does not re-fetch when OHLC data is present
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-31): 1 records found in database

stdout | test/get-historical.spec.ts > getHistorical handler > Missing OHLC data handling > does not re-fetch when OHLC data is present
{"timestamp":"2025-12-14T19:16:29.846Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","recordCount":1}
[get-historical] Successfully fetched 1 historical records for AAPL from FMP API

 ❯ test/get-historical.spec.ts (28 tests | 1 failed) 9833ms
   ✓ getHistorical handler > Parameter validation > requires a symbol parameter 52ms
   ✓ getHistorical handler > Parameter validation > accepts symbol parameter  562ms
   ✓ getHistorical handler > Parameter validation > normalizes symbol to uppercase  520ms
   ✓ getHistorical handler > Date range parameters (from/to) > accepts from and to parameters  506ms
   ✓ getHistorical handler > Date range parameters (from/to) > validates from date format 3ms
   ✓ getHistorical handler > Date range parameters (from/to) > validates to date format 2ms
   ✓ getHistorical handler > Date range parameters (from/to) > validates that from date is before to date 2ms
   ✓ getHistorical handler > Date range parameters (from/to) > allows from and to to be the same date  506ms
   ✓ getHistorical handler > Date range parameters (from/to) > defaults to today when only 'to' is provided  508ms
   ✓ getHistorical handler > Date range parameters (from/to) > defaults to today when only 'from' is provided  506ms
   ✓ getHistorical handler > Days parameter (backward compatibility) > accepts days parameter  505ms
   ✓ getHistorical handler > Days parameter (backward compatibility) > defaults to 180 days when no parameters provided  505ms
   ✓ getHistorical handler > Days parameter (backward compatibility) > validates days parameter minimum value 3ms
   ✓ getHistorical handler > Days parameter (backward compatibility) > validates days parameter maximum value 3ms
   ✓ getHistorical handler > Days parameter (backward compatibility) > validates days parameter is a number 3ms
   ✓ getHistorical handler > Parameter priority > prioritizes from/to parameters over days parameter  505ms
   ✓ getHistorical handler > Database query > queries database with correct date range  507ms
   ✓ getHistorical handler > Database query > returns data from database when available  506ms
   ✓ getHistorical handler > Database query > returns empty array when database has no data  505ms
   ✓ getHistorical handler > FMP API fallback > fetches from FMP API when database is empty and ctx is available  505ms
   ✓ getHistorical handler > FMP API fallback > creates fallback ExecutionContext when ctx is not available and fetches from FMP API  506ms
   ✓ getHistorical handler > FMP API fallback > handles FMP API fetch errors gracefully 4ms
   ✓ getHistorical handler > Response format > returns correct response format with from/to parameters  505ms
   ✓ getHistorical handler > Response format > returns correct response format with days parameter  504ms
   ✓ getHistorical handler > Response format > includes all required fields in data items  506ms
   ✓ getHistorical handler > Missing OHLC data handling > re-fetches from FMP API when OHLC data is missing (null)  504ms
   × getHistorical handler > Missing OHLC data handling > does not re-fetch when OHLC data is present 501ms
     → expected "spy" to not be called at all, but actually been called 1 times

Received: 

  1st spy call:

    Array [
      "AAPL",
      Object {
        "stockly": Object {},
      },
      Object {
        "passThroughOnException": [Function spy],
        "props": Object {},
        "waitUntil": [Function spy],
      },
      "2025-01-01",
      "2025-01-31",
    ]


Number of calls: 1

   ✓ getHistorical handler > Error handling > handles database query errors gracefully 6ms
stdout | test/get-stock-details.spec.ts > getStockDetails service > normalizes chart data correctly by time periods
Cache miss for stock details: AAPL, fetching...

stdout | test/get-stock-details.spec.ts > getStockDetails service > handles rate limiting with retry
Cache miss for stock details: AAPL, fetching...

stdout | test/get-stock-details.spec.ts > getStockDetails service > normalizes financial data correctly
Cache miss for stock details: AAPL, fetching...

 ✓ test/get-stock-details.spec.ts (7 tests) 13201ms
   ✓ getStockDetails service > handles partial data failures gracefully  3050ms
   ✓ getStockDetails service > returns error when all critical endpoints fail  9011ms
   ✓ getStockDetails service > handles rate limiting with retry  1005ms

 Test Files  13 failed | 32 passed (45)
      Tests  78 failed | 418 passed (496)
     Errors  1 error
   Start at  20:16:10
   Duration  22.52s (transform 3.37s, setup 0ms, collect 50.44s, tests 52.04s, environment 10ms, prepare 57.44s)

JSON report written to /home/sngvahmed/workspace/stockly/api/test-results/results.json
JUNIT report written to /home/sngvahmed/workspace/stockly/api/test-results/junit.xml
[vpw:debug] Shutting down runtimes...
