
> stockly-api@0.0.0 test
> vitest run


 RUN  v3.2.4 /home/sngvahmed/workspace/stockly/api

Using vars defined in .dev.vars
[vpw:info] Starting isolated runtimes for vitest.config.mts...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
[mf:warn] The latest compatibility date supported by the installed Cloudflare Workers Runtime is "2025-09-06",
but you've requested "2025-11-13". Falling back to "2025-09-06"...
stdout | test/logging/loki-shipper.spec.ts > Loki Shipper > sendLogsToLoki > should ship logs successfully
[Loki Shipper] Successfully shipped 2 log entries

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > getCachedState > should return cached state
[KV Cache] Queued state update for alert alert-1 (1 pending writes)

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > get > should log HIT when value exists (text)
{"timestamp":"2025-12-14T19:34:03.648Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV get: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"HIT"}

stdout | test/logging/loki-shipper.spec.ts > Loki Shipper > sendLogsToLoki > should format timestamps as nanoseconds
[Loki Shipper] Successfully shipped 2 log entries

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > get > should log MISS when value is null (text)
{"timestamp":"2025-12-14T19:34:03.684Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV get: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"MISS"}

stdout | test/logging/loki-shipper.spec.ts > Loki Shipper > sendLogsToLoki > should handle URL with trailing slash
[Loki Shipper] Successfully shipped 2 log entries

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > updateStateInCache > should update state in cache
[KV Cache] Queued state update for alert alert-1 (1 pending writes)

stderr | test/config.spec.ts > Config System > getConfig > returns default config when KV is not available
alertsKv not available, using default config

stdout | test/logging/logger.spec.ts > Logger > debug > should create debug log entry
{"timestamp":"2025-12-14T19:34:03.724Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"Debug message","type":"general","extra":"data"}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > get > should log HIT when value exists (json)
{"timestamp":"2025-12-14T19:34:03.750Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV get: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"HIT"}

stdout | test/logging/loki-shipper.spec.ts > Loki Shipper > sendLogsToLoki > should include Basic Auth when credentials provided
[Loki Shipper] Successfully shipped 2 log entries

 ✓ test/cache.spec.ts (2 tests) 181ms
stdout | test/alerts/state-cache.spec.ts > Alert State Cache > updateStateInCache > should queue state for KV write
[KV Cache] Queued state update for alert alert-1 (1 pending writes)

 ✓ test/util.spec.ts (2 tests) 175ms
stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > get > should log MISS when value is null (json)
{"timestamp":"2025-12-14T19:34:03.772Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV get: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"MISS"}

 ✓ test/alerts-evaluate.spec.ts (3 tests) 203ms
stdout | test/logging/loki-shipper.spec.ts > Loki Shipper > sendLogsToLoki > should not include Auth when credentials not provided
[Loki Shipper] Successfully shipped 2 log entries

stdout | test/logging/d1-wrapper.spec.ts > LoggedD1Database > exec > should log successful exec operation
{"timestamp":"2025-12-14T19:34:03.791Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"D1 exec: SELECT * FROM alerts","type":"data_operation","operation":"d1","query":"SELECT * FROM alerts","latencyMs":0,"cacheStatus":"N/A"}

stdout | test/logging/logger.spec.ts > Logger > info > should create info log entry
{"timestamp":"2025-12-14T19:34:03.798Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"Info message","type":"general","action":"test"}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > get > should handle arrayBuffer type
{"timestamp":"2025-12-14T19:34:03.801Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV get: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"HIT"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > User Symbol Collection > should collect unique symbols from all users
{"timestamp":"2025-12-14T19:34:03.813Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740843813","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/alerts-storage.spec.ts > alerts storage queries > creates and returns an alert
Creating alert with username: testuser, symbol: AAPL

stdout | test/logging/loki-shipper.spec.ts > Loki Shipper > sendLogsToLoki > should include custom labels
[Loki Shipper] Successfully shipped 2 log entries

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should load states from KV
[KV Cache] Loading 2 alert states from KV...

stdout | test/logging/d1-wrapper.spec.ts > LoggedD1Database > exec > should log failed exec operation
{"timestamp":"2025-12-14T19:34:03.827Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"D1 exec failed: SELECT * FROM alerts","type":"data_operation","operation":"d1","query":"SELECT * FROM alerts","latencyMs":0,"cacheStatus":"N/A","error":"Database error"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > User Symbol Collection > should collect unique symbols from all users
{"timestamp":"2025-12-14T19:34:03.815Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740843813","userId":null,"path":"/cron/news-alerts","message":"Checking news for 4 unique symbols: LXEO, AMZN, AAPL, BABA","type":"general"}
{"timestamp":"2025-12-14T19:34:03.815Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740843813","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/alerts-storage.spec.ts > alerts storage queries > creates and returns an alert
Alert created successfully: id=generated-id, username=testuser, symbol=AAPL

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should load states from KV
[KV Cache] Loaded 2 states from KV

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > User Symbol Collection > should collect unique symbols from all users
{"timestamp":"2025-12-14T19:34:03.815Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740843813","userId":null,"path":"/cron/news-alerts","message":"Fetched 0 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:34:03.815Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740843813","userId":null,"path":"/cron/news-alerts","message":"Found news for 0 symbols: ","type":"general"}
{"timestamp":"2025-12-14T19:34:03.815Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740843813","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

 ✓ test/alerts-validation.spec.ts (4 tests) 229ms
stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > User Symbol Collection > should normalize symbols to uppercase
{"timestamp":"2025-12-14T19:34:03.849Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740843849","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > get > should handle stream type
{"timestamp":"2025-12-14T19:34:03.863Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV get: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"HIT"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > User Symbol Collection > should normalize symbols to uppercase
{"timestamp":"2025-12-14T19:34:03.849Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740843849","userId":null,"path":"/cron/news-alerts","message":"Checking news for 2 unique symbols: LXEO, AMZN","type":"general"}
{"timestamp":"2025-12-14T19:34:03.849Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740843849","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > User Symbol Collection > should normalize symbols to uppercase
{"timestamp":"2025-12-14T19:34:03.849Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740843849","userId":null,"path":"/cron/news-alerts","message":"Fetched 0 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:34:03.849Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740843849","userId":null,"path":"/cron/news-alerts","message":"Found news for 0 symbols: ","type":"general"}
{"timestamp":"2025-12-14T19:34:03.850Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740843849","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stderr | test/logging/logger.spec.ts > Logger > warn > should create warn log entry
{"timestamp":"2025-12-14T19:34:03.888Z","service":"stockly-api-test","level":"WARN","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"Warning message","type":"general","warning":"test"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should cache loaded states in memory
[KV Cache] Loading 1 alert states from KV...

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > get > should log failed get operation
{"timestamp":"2025-12-14T19:34:03.894Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV get failed: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"N/A","error":"KV error"}

stdout | test/logging/d1-wrapper.spec.ts > LoggedD1Database > batch > should log successful batch operation
{"timestamp":"2025-12-14T19:34:03.905Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"D1 batch: BATCH(2 statements)","type":"data_operation","operation":"d1","query":"BATCH(2 statements)","latencyMs":0,"cacheStatus":"N/A"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should cache loaded states in memory
[KV Cache] Loaded 1 states from KV

stdout | test/get-stock-details.spec.ts > getStockDetails service > returns cached data when available and valid
Cache hit for stock details: AAPL

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should return cached data if cache is fresh
[KV Cache] Loading 1 alert states from KV...

stdout | test/logging/d1-wrapper.spec.ts > LoggedD1Database > batch > should log failed batch operation
{"timestamp":"2025-12-14T19:34:03.940Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"D1 batch failed: BATCH(2 statements)","type":"data_operation","operation":"d1","query":"BATCH(2 statements)","latencyMs":0,"cacheStatus":"N/A","error":"Batch failed"}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > get > should measure latency
{"timestamp":"2025-12-14T19:34:03.941Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV get: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":10,"cacheStatus":"HIT"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > User Symbol Collection > should skip users with no favorite symbols
{"timestamp":"2025-12-14T19:34:03.942Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740843942","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should return cached data if cache is fresh
[KV Cache] Loaded 1 states from KV

stdout | test/get-stock-details.spec.ts > getStockDetails service > fetches all data from FMP API when cache misses
Cache miss for stock details: AAPL, fetching...

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > User Symbol Collection > should skip users with no favorite symbols
{"timestamp":"2025-12-14T19:34:03.942Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740843942","userId":null,"path":"/cron/news-alerts","message":"Checking news for 1 unique symbols: LXEO","type":"general"}
{"timestamp":"2025-12-14T19:34:03.942Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740843942","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > User Symbol Collection > should skip users with no favorite symbols
{"timestamp":"2025-12-14T19:34:03.942Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740843942","userId":null,"path":"/cron/news-alerts","message":"Fetched 0 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:34:03.942Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740843942","userId":null,"path":"/cron/news-alerts","message":"Found news for 0 symbols: ","type":"general"}
{"timestamp":"2025-12-14T19:34:03.942Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740843942","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stderr | test/logging/logger.spec.ts > Logger > error > should create error log entry with Error object
{"timestamp":"2025-12-14T19:34:03.984Z","service":"stockly-api-test","level":"ERROR","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"Error message","type":"general","context":"test","error":{"name":"Error","message":"Test error","stack":"Error stack trace"}}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should handle missing states
[KV Cache] Loading 2 alert states from KV...

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should handle missing states
[KV Cache] Loaded 1 states from KV

stdout | test/get-stock-details.spec.ts > getStockDetails service > handles partial data failures gracefully
Cache miss for stock details: AAPL, fetching...

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > put > should log successful put operation
{"timestamp":"2025-12-14T19:34:04.014Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV put: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"N/A"}

stderr | test/logging/logger.spec.ts > Logger > error > should create error log entry with string error
{"timestamp":"2025-12-14T19:34:04.021Z","service":"stockly-api-test","level":"ERROR","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"Error message","type":"general","context":"test","error":"String error"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should handle invalid JSON
[KV Cache] Loading 1 alert states from KV...

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should fetch news for all symbols in one batch call
{"timestamp":"2025-12-14T19:34:04.036Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844036","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stderr | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should handle invalid JSON
[KV Cache] Failed to load state for alert alert-1: SyntaxError: Unexpected token 'i', "invalid json" is not valid JSON
    at JSON.parse (<anonymous>)
    at /home/sngvahmed/workspace/stockly/api/src/alerts/state-cache.ts:54:29
    at async Promise.all (index 0)
    at loadAllStatesFromKV (/home/sngvahmed/workspace/stockly/api/src/alerts/state-cache.ts:64:19)
    at /home/sngvahmed/workspace/stockly/api/test/alerts/state-cache.spec.ts:158:22
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20

stdout | test/alerts-storage.spec.ts > alerts state KV > reads and writes state snapshots
[KV Cache] Queued state update for alert 1 (1 pending writes)

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should fetch news for all symbols in one batch call
{"timestamp":"2025-12-14T19:34:04.037Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844036","userId":null,"path":"/cron/news-alerts","message":"Checking news for 3 unique symbols: LXEO, AMZN, AAPL","type":"general"}
{"timestamp":"2025-12-14T19:34:04.037Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844036","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should handle invalid JSON
[KV Cache] Loaded 0 states from KV

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should fetch news for all symbols in one batch call
{"timestamp":"2025-12-14T19:34:04.037Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844036","userId":null,"path":"/cron/news-alerts","message":"Fetched 2 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:34:04.037Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844036","userId":null,"path":"/cron/news-alerts","message":"Found news for 2 symbols: LXEO, AMZN","type":"general"}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > put > should log put with expiration options
{"timestamp":"2025-12-14T19:34:04.071Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV put: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"N/A"}

stderr | test/logging/logger.spec.ts > Logger > error > should create error log entry without error
{"timestamp":"2025-12-14T19:34:04.060Z","service":"stockly-api-test","level":"ERROR","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"Error message","type":"general","context":"test"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should fetch news for all symbols in one batch call
{"timestamp":"2025-12-14T19:34:04.037Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844036","userId":null,"path":"/cron/news-alerts","message":"New article found (published today)","type":"general","symbol":"LXEO","title":"LXEO News Today","publishedDate":"2025-12-14T10:00:00Z"}

stdout | test/logging/loki-shipper.spec.ts > Loki Shipper > sendLogsToLoki > should format logs correctly with all log types
[Loki Shipper] Successfully shipped 3 log entries

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should fetch news for all symbols in one batch call
{"timestamp":"2025-12-14T19:34:04.037Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844036","userId":null,"path":"/cron/news-alerts","message":"Found 1 users with LXEO in favorites: user1","type":"general"}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > put > should log failed put operation
{"timestamp":"2025-12-14T19:34:04.097Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV put failed: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"N/A","error":"Put failed"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should fetch news for all symbols in one batch call
{"timestamp":"2025-12-14T19:34:04.037Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844036","userId":null,"path":"/cron/news-alerts","message":"Sent 2 notifications for LXEO news to 1 users","type":"general"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should handle KV read errors
[KV Cache] Loading 1 alert states from KV...

stdout | test/alerts-storage.spec.ts > alerts state KV > deletes state
[KV Cache] Queued state update for alert 1 (1 pending writes)

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should fetch news for all symbols in one batch call
{"timestamp":"2025-12-14T19:34:04.038Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844036","userId":null,"path":"/cron/news-alerts","message":"New article found (published today)","type":"general","symbol":"AMZN","title":"AMZN News Today","publishedDate":"2025-12-14T11:00:00Z"}

stderr | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should handle KV read errors
[KV Cache] Failed to load state for alert alert-1: Error: KV error
    at /home/sngvahmed/workspace/stockly/api/test/alerts/state-cache.spec.ts:166:47
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:155:11
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:26
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1863:10)
    at runTest (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1574:12)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)

stderr | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should skip cron if alertsKv is not configured
{"timestamp":"2025-12-14T19:34:04.127Z","service":"stockly-api","level":"WARN","traceId":"cron-1765740844126","userId":null,"path":"/cron/alerts","message":"Alerts KV is not configured; skipping cron","type":"general"}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > put > should handle ArrayBuffer value
{"timestamp":"2025-12-14T19:34:04.131Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV put: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"N/A"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should fetch news for all symbols in one batch call
{"timestamp":"2025-12-14T19:34:04.038Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844036","userId":null,"path":"/cron/news-alerts","message":"Found 1 users with AMZN in favorites: user1","type":"general"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > loadAllStatesFromKV > should handle KV read errors
[KV Cache] Loaded 0 states from KV

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should fetch news for all symbols in one batch call
{"timestamp":"2025-12-14T19:34:04.038Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844036","userId":null,"path":"/cron/news-alerts","message":"Sent 2 notifications for AMZN news to 1 users","type":"general"}
{"timestamp":"2025-12-14T19:34:04.038Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844036","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stdout | test/logging/logger.spec.ts > Logger > logApiCall > should create API call log entry
{"timestamp":"2025-12-14T19:34:04.151Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"API call made","type":"api_call","apiProvider":"FMP","endpoint":"/quote","method":"GET","statusCode":200,"latencyMs":150}

 ✓ test/logging/loki-shipper.spec.ts (12 tests) 634ms
stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should only process news published today
{"timestamp":"2025-12-14T19:34:04.070Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844070","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should skip cron if no active alerts found
{"timestamp":"2025-12-14T19:34:04.166Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844166","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

 ✓ test/notifications/jwt-helper.spec.ts (10 tests) 616ms
 ✓ test/alerts-storage.spec.ts (7 tests) 427ms
stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should only process news published today
{"timestamp":"2025-12-14T19:34:04.070Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844070","userId":null,"path":"/cron/news-alerts","message":"Checking news for 1 unique symbols: LXEO","type":"general"}
{"timestamp":"2025-12-14T19:34:04.070Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844070","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should skip cron if no active alerts found
{"timestamp":"2025-12-14T19:34:04.166Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844166","userId":null,"path":"/cron/alerts","message":"No active alerts found","type":"general"}

stdout | test/logging/d1-wrapper.spec.ts > LoggedD1Database > LoggedD1PreparedStatement > first > should log successful first operation
{"timestamp":"2025-12-14T19:34:04.171Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"D1 first: SELECT * FROM alerts WHERE id = ?","type":"data_operation","operation":"d1","query":"SELECT * FROM alerts WHERE id = ?","latencyMs":0,"cacheStatus":"N/A"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should only process news published today
{"timestamp":"2025-12-14T19:34:04.071Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844070","userId":null,"path":"/cron/news-alerts","message":"Fetched 2 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:34:04.071Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844070","userId":null,"path":"/cron/news-alerts","message":"Found news for 1 symbols: LXEO","type":"general"}

stdout | test/logging/logger.spec.ts > Logger > logApiCall > should create API call log entry with partial options
{"timestamp":"2025-12-14T19:34:04.196Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"API call","type":"api_call","apiProvider":"FMP","latencyMs":100}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should write pending states to KV
[KV Cache] Queued state update for alert alert-1 (1 pending writes)
[KV Cache] Flushing 1 pending writes to KV...

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should only process news published today
{"timestamp":"2025-12-14T19:34:04.071Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844070","userId":null,"path":"/cron/news-alerts","message":"New article found (published today)","type":"general","symbol":"LXEO","title":"LXEO News Today","publishedDate":"2025-12-14T10:00:00Z"}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > delete > should log successful delete operation
{"timestamp":"2025-12-14T19:34:04.205Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV delete: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"N/A"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should write pending states to KV
[KV Cache] Flushed 1/1 writes to KV

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should only process news published today
{"timestamp":"2025-12-14T19:34:04.071Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844070","userId":null,"path":"/cron/news-alerts","message":"Found 1 users with LXEO in favorites: user1","type":"general"}

stdout | test/logging/d1-wrapper.spec.ts > LoggedD1Database > LoggedD1PreparedStatement > first > should log failed first operation
{"timestamp":"2025-12-14T19:34:04.225Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"D1 first failed: SELECT * FROM alerts WHERE id = ?","type":"data_operation","operation":"d1","query":"SELECT * FROM alerts WHERE id = ?","latencyMs":0,"cacheStatus":"N/A","error":"Query failed"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should process alerts and send notifications
{"timestamp":"2025-12-14T19:34:04.223Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844223","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should only process news published today
{"timestamp":"2025-12-14T19:34:04.071Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844070","userId":null,"path":"/cron/news-alerts","message":"Sent 1 notifications for LXEO news to 1 users","type":"general"}
{"timestamp":"2025-12-14T19:34:04.071Z","service":"stockly-api","level":"DEBUG","traceId":"cron-news-1765740844070","userId":null,"path":"/cron/news-alerts","message":"Skipping article not published today: LXEO News Yesterday (2025-12-13T10:00:00Z)","type":"general"}
{"timestamp":"2025-12-14T19:34:04.071Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844070","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should batch multiple writes
[KV Cache] Queued state update for alert alert-1 (1 pending writes)
[KV Cache] Queued state update for alert alert-2 (2 pending writes)
[KV Cache] Flushing 2 pending writes to KV...

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > delete > should log failed delete operation
{"timestamp":"2025-12-14T19:34:04.238Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV delete failed: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"N/A","error":"Delete failed"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should process alerts and send notifications
{"timestamp":"2025-12-14T19:34:04.224Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844223","userId":null,"path":"/cron/alerts","message":"Processing 1 active alerts","type":"general"}
{"timestamp":"2025-12-14T19:34:04.224Z","service":"stockly-api","level":"DEBUG","traceId":"cron-1765740844223","userId":null,"path":"/cron/alerts","message":"Fetching prices for 1 unique symbols","type":"general","symbols":["AAPL"]}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should batch multiple writes
[KV Cache] Flushed 2/2 writes to KV

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should process alerts and send notifications
{"timestamp":"2025-12-14T19:34:04.224Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844223","userId":null,"path":"/cron/alerts","message":"Successfully fetched prices for 1 symbols","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should handle empty news response
{"timestamp":"2025-12-14T19:34:04.098Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844098","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/logging/logger.spec.ts > Logger > logDataOperation > should create D1 operation log entry
{"timestamp":"2025-12-14T19:34:04.257Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"D1 query executed","type":"data_operation","operation":"d1","query":"SELECT * FROM alerts","latencyMs":25,"cacheStatus":"N/A"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should not write if interval has not passed
[KV Cache] Queued state update for alert alert-1 (1 pending writes)
[KV Cache] Flushing 1 pending writes to KV...

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should process alerts and send notifications
{"timestamp":"2025-12-14T19:34:04.224Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844223","userId":null,"path":"/cron/alerts","message":"Evaluated 1 alerts, 1 triggered","type":"general"}
{"timestamp":"2025-12-14T19:34:04.224Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844223","userId":null,"path":"/cron/alerts","message":"Alert triggered","type":"general","alertId":"alert-1","symbol":"AAPL","price":205,"direction":"above","threshold":200,"channel":"notification"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should handle empty news response
{"timestamp":"2025-12-14T19:34:04.098Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844098","userId":null,"path":"/cron/news-alerts","message":"Checking news for 1 unique symbols: LXEO","type":"general"}
{"timestamp":"2025-12-14T19:34:04.098Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844098","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should not write if interval has not passed
[KV Cache] Flushed 1/1 writes to KV

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should process alerts and send notifications
{"timestamp":"2025-12-14T19:34:04.225Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844223","userId":null,"path":"/cron/alerts","message":"FCM notification sent successfully","type":"general","alertId":"alert-1","symbol":"AAPL","pushToken":"fcm-token-123"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > News Fetching and Filtering > should handle empty news response
{"timestamp":"2025-12-14T19:34:04.098Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844098","userId":null,"path":"/cron/news-alerts","message":"Fetched 0 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:34:04.099Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844098","userId":null,"path":"/cron/news-alerts","message":"Found news for 0 symbols: ","type":"general"}
{"timestamp":"2025-12-14T19:34:04.099Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844098","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should not write if interval has not passed
[KV Cache] Queued state update for alert alert-2 (1 pending writes)
[KV Cache] Skipping KV write - only 0s since last write (interval: 3600s)

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should process alerts and send notifications
{"timestamp":"2025-12-14T19:34:04.225Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844223","userId":null,"path":"/cron/alerts","message":"Alert notification sent to all user devices","type":"general","alertId":"alert-1","symbol":"AAPL","username":"testuser","devicesCount":1,"successCount":1,"failCount":0}
{"timestamp":"2025-12-14T19:34:04.225Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844223","userId":null,"path":"/cron/alerts","message":"Alert cron job completed successfully","type":"general","alertsProcessed":1,"notificationsSent":1}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle fetch price failures gracefully
{"timestamp":"2025-12-14T19:34:04.256Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844256","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stdout | test/logging/d1-wrapper.spec.ts > LoggedD1Database > LoggedD1PreparedStatement > all > should log successful all operation
{"timestamp":"2025-12-14T19:34:04.299Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"D1 all: SELECT * FROM alerts WHERE id = ?","type":"data_operation","operation":"d1","query":"SELECT * FROM alerts WHERE id = ?","latencyMs":0,"cacheStatus":"N/A"}

stdout | test/logging/logger.spec.ts > Logger > logDataOperation > should create KV operation log entry with HIT
{"timestamp":"2025-12-14T19:34:04.304Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"KV get","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":5,"cacheStatus":"HIT"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle fetch price failures gracefully
{"timestamp":"2025-12-14T19:34:04.256Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844256","userId":null,"path":"/cron/alerts","message":"Processing 1 active alerts","type":"general"}
{"timestamp":"2025-12-14T19:34:04.256Z","service":"stockly-api","level":"DEBUG","traceId":"cron-1765740844256","userId":null,"path":"/cron/alerts","message":"Fetching prices for 1 unique symbols","type":"general","symbols":["AAPL"]}

 ✓ test/config.spec.ts (10 tests) 612ms
stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > list > should log successful list operation without options
{"timestamp":"2025-12-14T19:34:04.314Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV list: prefix=all","type":"data_operation","operation":"kv","key":"*","latencyMs":0,"cacheStatus":"N/A"}

stderr | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle fetch price failures gracefully
{"timestamp":"2025-12-14T19:34:04.256Z","service":"stockly-api","level":"ERROR","traceId":"cron-1765740844256","userId":null,"path":"/cron/alerts","message":"Failed to fetch quote for alert","type":"general","symbol":"AAPL","error":{"name":"Error","message":"Network error","stack":"Error: Network error\n    at /home/sngvahmed/workspace/stockly/api/test/cron/alerts-cron.spec.ts:199:49\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:155:11\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:26\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1897:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1863:10)\n    at runTest (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1574:12)\n    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)\n    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)\n    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)"}}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should write if interval has passed
[KV Cache] Queued state update for alert alert-1 (1 pending writes)
[KV Cache] Flushing 1 pending writes to KV...

stderr | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle fetch price failures gracefully
{"timestamp":"2025-12-14T19:34:04.259Z","service":"stockly-api","level":"WARN","traceId":"cron-1765740844256","userId":null,"path":"/cron/alerts","message":"No prices available for alerts run","type":"general","symbols":["AAPL"]}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should write if interval has passed
[KV Cache] Flushed 1/1 writes to KV

stdout | test/logging/d1-wrapper.spec.ts > LoggedD1Database > LoggedD1PreparedStatement > all > should log failed all operation
{"timestamp":"2025-12-14T19:34:04.332Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"D1 all failed: SELECT * FROM alerts WHERE id = ?","type":"data_operation","operation":"d1","query":"SELECT * FROM alerts WHERE id = ?","latencyMs":0,"cacheStatus":"N/A","error":"Query failed"}

stdout | test/logging/logger.spec.ts > Logger > logDataOperation > should create KV operation log entry with MISS
{"timestamp":"2025-12-14T19:34:04.338Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"KV get","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":5,"cacheStatus":"MISS"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should write if interval has passed
[KV Cache] Queued state update for alert alert-2 (1 pending writes)
[KV Cache] Flushing 1 pending writes to KV...

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > list > should log successful list operation with prefix
{"timestamp":"2025-12-14T19:34:04.351Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV list: prefix=cache:","type":"data_operation","operation":"kv","key":"cache:","latencyMs":0,"cacheStatus":"N/A"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should not send duplicate notifications for the same article
{"timestamp":"2025-12-14T19:34:04.351Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844351","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should skip alert with old Expo token
{"timestamp":"2025-12-14T19:34:04.288Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844288","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should write if interval has passed
[KV Cache] Flushed 1/1 writes to KV

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should not send duplicate notifications for the same article
{"timestamp":"2025-12-14T19:34:04.351Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844351","userId":null,"path":"/cron/news-alerts","message":"Checking news for 1 unique symbols: LXEO","type":"general"}
{"timestamp":"2025-12-14T19:34:04.351Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844351","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should skip alert with old Expo token
{"timestamp":"2025-12-14T19:34:04.289Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844288","userId":null,"path":"/cron/alerts","message":"Processing 1 active alerts","type":"general"}
{"timestamp":"2025-12-14T19:34:04.289Z","service":"stockly-api","level":"DEBUG","traceId":"cron-1765740844288","userId":null,"path":"/cron/alerts","message":"Fetching prices for 1 unique symbols","type":"general","symbols":["AAPL"]}

stdout | test/api/favorite-stocks.spec.ts > Favorite Stocks API > getFavoriteStocks > should return favorite stocks for authenticated user
{"timestamp":"2025-12-14T19:34:04.370Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Fetched favorite stocks","type":"general","username":"testuser","count":2}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should handle KV write errors gracefully
[KV Cache] Queued state update for alert alert-1 (1 pending writes)
[KV Cache] Flushing 1 pending writes to KV...

stdout | test/logging/logger.spec.ts > Logger > logDataOperation > should create data operation log entry with error
{"timestamp":"2025-12-14T19:34:04.376Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"D1 query failed","type":"data_operation","operation":"d1","query":"SELECT * FROM alerts","latencyMs":25,"cacheStatus":"N/A","error":"Database connection failed"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should not send duplicate notifications for the same article
{"timestamp":"2025-12-14T19:34:04.351Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844351","userId":null,"path":"/cron/news-alerts","message":"Fetched 1 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:34:04.351Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844351","userId":null,"path":"/cron/news-alerts","message":"Found news for 1 symbols: LXEO","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should skip alert with old Expo token
{"timestamp":"2025-12-14T19:34:04.289Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844288","userId":null,"path":"/cron/alerts","message":"Successfully fetched prices for 1 symbols","type":"general"}

stderr | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should handle KV write errors gracefully
[KV Cache] Failed to write state for alert alert-1: Error: KV write failed
    at /home/sngvahmed/workspace/stockly/api/test/alerts/state-cache.spec.ts:264:47
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:155:11
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:26
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1863:10)
    at runTest (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1574:12)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)

stderr | test/notifications/fcm-sender.spec.ts > FCM Sender > sendFCMNotificationWithLogs > should handle JWT generation failure
Failed to get Google access token: Error: JWT generation failed
    at /home/sngvahmed/workspace/stockly/api/test/notifications/fcm-sender.spec.ts:116:54
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:155:11
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:26
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1863:10)
    at runTest (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1574:12)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should not send duplicate notifications for the same article
{"timestamp":"2025-12-14T19:34:04.351Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844351","userId":null,"path":"/cron/news-alerts","message":"New article found (published today)","type":"general","symbol":"LXEO","title":"LXEO News Today","publishedDate":"2025-12-14T10:00:00Z"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should skip alert with old Expo token
{"timestamp":"2025-12-14T19:34:04.289Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844288","userId":null,"path":"/cron/alerts","message":"Evaluated 1 alerts, 1 triggered","type":"general"}
{"timestamp":"2025-12-14T19:34:04.289Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844288","userId":null,"path":"/cron/alerts","message":"Alert triggered","type":"general","alertId":"alert-1","symbol":"AAPL","price":205,"direction":"above","threshold":200,"channel":"notification"}

 ✓ test/integration/alerts-flow.spec.ts (2 tests) 205ms
stderr | test/get-stocks.spec.ts > getStocks handler > serves fresh entries from cache
alertsKv not available, using default config

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > flushPendingWritesToKV > should handle KV write errors gracefully
[KV Cache] Flushed 0/1 writes to KV

stdout | test/api/push-token.spec.ts > Push Token API > registerPushToken > should register new push token
✅ FCM token validation passed: length=30, format valid

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should not send duplicate notifications for the same article
{"timestamp":"2025-12-14T19:34:04.352Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844351","userId":null,"path":"/cron/news-alerts","message":"Found 1 users with LXEO in favorites: user1","type":"general"}

stderr | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should skip alert with old Expo token
{"timestamp":"2025-12-14T19:34:04.289Z","service":"stockly-api","level":"WARN","traceId":"cron-1765740844288","userId":null,"path":"/cron/alerts","message":"Skipping alert with old Expo token - FCM migration required","type":"general","alertId":"alert-1","symbol":"AAPL","pushToken":"ExponentPushToken[123]"}

stdout | test/api/push-token.spec.ts > Push Token API > registerPushToken > should register new push token
{"timestamp":"2025-12-14T19:34:04.391Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Registering new push token","type":"general","username":"testuser","deviceType":"android","tokenPreview":"fcm-token-1234567890..."}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should not send duplicate notifications for the same article
{"timestamp":"2025-12-14T19:34:04.352Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844351","userId":null,"path":"/cron/news-alerts","message":"Sent 1 notifications for LXEO news to 1 users","type":"general"}
{"timestamp":"2025-12-14T19:34:04.352Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844351","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should skip alert with old Expo token
{"timestamp":"2025-12-14T19:34:04.289Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844288","userId":null,"path":"/cron/alerts","message":"Alert notification sent to all user devices","type":"general","alertId":"alert-1","symbol":"AAPL","username":"testuser","devicesCount":1,"successCount":0,"failCount":1}
{"timestamp":"2025-12-14T19:34:04.289Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844288","userId":null,"path":"/cron/alerts","message":"Alert cron job completed successfully","type":"general","alertsProcessed":1,"notificationsSent":1}

stdout | test/logging/d1-wrapper.spec.ts > LoggedD1Database > LoggedD1PreparedStatement > run > should log successful run operation
{"timestamp":"2025-12-14T19:34:04.417Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"D1 run: SELECT * FROM alerts WHERE id = ?","type":"data_operation","operation":"d1","query":"SELECT * FROM alerts WHERE id = ?","latencyMs":0,"cacheStatus":"N/A"}

 ✓ test/integration/auth-flow.spec.ts (2 tests) 209ms
stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > list > should log successful list operation with limit
{"timestamp":"2025-12-14T19:34:04.423Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV list: prefix=all","type":"data_operation","operation":"kv","key":"*","latencyMs":0,"cacheStatus":"N/A"}

stderr | test/api/push-token.spec.ts > Push Token API > registerPushToken > should register new push token
{"timestamp":"2025-12-14T19:34:04.392Z","service":"stockly-api-test","level":"ERROR","traceId":"test-trace-id","userId":null,"path":"/test","message":"Device creation verification failed","type":"general","error":"[object Object]"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should not send duplicate notifications for the same article
{"timestamp":"2025-12-14T19:34:04.352Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844352","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/api/news-archive.spec.ts > News Archive API > getArchivedNews > should return archived news for authenticated user
{"timestamp":"2025-12-14T19:34:04.435Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Fetching archived news","type":"general","username":"testuser","page":1,"limit":10}

stderr | test/notifications/fcm-sender.spec.ts > FCM Sender > sendFCMNotificationWithLogs > should handle access token exchange failure
Failed to get Google access token: Error: Token exchange failed
    at /home/sngvahmed/workspace/stockly/api/test/notifications/fcm-sender.spec.ts:133:9
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:155:11
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:26
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1863:10)
    at runTest (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1574:12)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)

stderr | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should not send duplicate notifications for the same article
{"timestamp":"2025-12-14T19:34:04.352Z","service":"stockly-api","level":"WARN","traceId":"cron-news-1765740844352","userId":"user1","path":"/cron/news-alerts","message":"Failed to parse news_favorite_symbols","type":"general"}

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > validates days parameter - must be between 1 and 30
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-12-13 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-13 to 2025-12-14

stdout | test/api/news-archive.spec.ts > News Archive API > getArchivedNews > should return archived news for authenticated user
{"timestamp":"2025-12-14T19:34:04.436Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Archived news fetched successfully","type":"general","username":"testuser","page":1,"limit":10,"total":10,"returned":1,"hasMore":false}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should not send duplicate notifications for the same article
{"timestamp":"2025-12-14T19:34:04.352Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844352","userId":null,"path":"/cron/news-alerts","message":"No favorite symbols found to check for news","type":"general"}

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > validates days parameter - must be between 1 and 30
[fetch30MinuteData] Received 0 30-minute candles

stdout | test/logging/d1-wrapper.spec.ts > LoggedD1Database > LoggedD1PreparedStatement > run > should log failed run operation
{"timestamp":"2025-12-14T19:34:04.461Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"D1 run failed: SELECT * FROM alerts WHERE id = ?","type":"data_operation","operation":"d1","query":"SELECT * FROM alerts WHERE id = ?","latencyMs":0,"cacheStatus":"N/A","error":"Update failed"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should log failed FCM notifications
{"timestamp":"2025-12-14T19:34:04.463Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844463","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > list > should log successful list operation with cursor
{"timestamp":"2025-12-14T19:34:04.466Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV list: prefix=all","type":"data_operation","operation":"kv","key":"*","latencyMs":0,"cacheStatus":"N/A"}

stderr | test/logging/logger.spec.ts > Logger > logFCMError > should create FCM error log entry
{"timestamp":"2025-12-14T19:34:04.468Z","service":"stockly-api-test","level":"ERROR","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"FCM notification failed","type":"fcm_error","fcmErrorCode":"5","fcmErrorType":"NOT_FOUND","isPermanent":true,"shouldCleanupToken":true,"requestPayload":{"token":"fcm-token","title":"Alert","body":"Price alert"},"errorMessage":"Token not found"}

stderr | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > validates days parameter - must be between 1 and 30
[getHistoricalIntraday] No 30-minute data available for AAPL

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should log failed FCM notifications
{"timestamp":"2025-12-14T19:34:04.463Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844463","userId":null,"path":"/cron/alerts","message":"Processing 1 active alerts","type":"general"}
{"timestamp":"2025-12-14T19:34:04.463Z","service":"stockly-api","level":"DEBUG","traceId":"cron-1765740844463","userId":null,"path":"/cron/alerts","message":"Fetching prices for 1 unique symbols","type":"general","symbols":["AAPL"]}

stdout | test/api/push-token.spec.ts > Push Token API > registerPushToken > should update existing push token
✅ FCM token validation passed: length=30, format valid

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > validates days parameter - must be between 1 and 30
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-11-29 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-11-29 to 2025-12-14

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should log failed FCM notifications
{"timestamp":"2025-12-14T19:34:04.464Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844463","userId":null,"path":"/cron/alerts","message":"Successfully fetched prices for 1 symbols","type":"general"}

stdout | test/api/push-token.spec.ts > Push Token API > registerPushToken > should update existing push token
{"timestamp":"2025-12-14T19:34:04.477Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Updating existing push token","type":"general","username":"testuser","deviceType":"android"}

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > validates days parameter - must be between 1 and 30
[fetch30MinuteData] Received 0 30-minute candles

stdout | test/api/news-archive.spec.ts > News Archive API > getArchivedNews > should handle pagination correctly
{"timestamp":"2025-12-14T19:34:04.482Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Fetching archived news","type":"general","username":"testuser","page":2,"limit":10}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should log failed FCM notifications
{"timestamp":"2025-12-14T19:34:04.464Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844463","userId":null,"path":"/cron/alerts","message":"Evaluated 1 alerts, 1 triggered","type":"general"}
{"timestamp":"2025-12-14T19:34:04.464Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844463","userId":null,"path":"/cron/alerts","message":"Alert triggered","type":"general","alertId":"alert-1","symbol":"AAPL","price":205,"direction":"above","threshold":200,"channel":"notification"}

stderr | test/api/push-token.spec.ts > Push Token API > registerPushToken > should update existing push token
{"timestamp":"2025-12-14T19:34:04.477Z","service":"stockly-api-test","level":"ERROR","traceId":"test-trace-id","userId":null,"path":"/test","message":"Device update verification failed","type":"general","error":"[object Object]"}

stderr | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > validates days parameter - must be between 1 and 30
[getHistoricalIntraday] No 30-minute data available for AAPL

stdout | test/api/news-archive.spec.ts > News Archive API > getArchivedNews > should handle pagination correctly
{"timestamp":"2025-12-14T19:34:04.482Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Archived news fetched successfully","type":"general","username":"testuser","page":2,"limit":10,"total":25,"returned":0,"hasMore":true}

stderr | test/devices.spec.ts > Devices API > getAllDevices > should return list of devices
{"timestamp":"2025-12-14T19:34:04.503Z","service":"stockly-api-test","level":"WARN","traceId":"test-trace-id","userId":null,"path":"/test","message":"Found devices with null username","type":"general","count":2,"deviceIds":["dXXXXXXXXXXXXXXXXXXX...","eYYYYYYYYYYYYYYYYYYY..."]}

stderr | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should log failed FCM notifications
{"timestamp":"2025-12-14T19:34:04.464Z","service":"stockly-api","level":"ERROR","traceId":"cron-1765740844463","userId":null,"path":"/cron/alerts","message":"Failed to send FCM notification","type":"general","alertId":"alert-1","symbol":"AAPL","pushToken":"fcm-token-123","error":{"name":"Error","message":"FCM send returned false","stack":"Error: FCM send returned false\n    at Module.runAlertCron (/home/sngvahmed/workspace/stockly/api/src/cron/alerts-cron.ts:204:63)\n    at /home/sngvahmed/workspace/stockly/api/test/cron/alerts-cron.spec.ts:309:7\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20"}}

stdout | test/get-stock-news.spec.ts > getStockNews handler > returns cached data without calling the upstream API
Cache hit for news AAPL: age=0s < interval=30s

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > validates days parameter - must be between 1 and 30
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-11-14 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-11-14 to 2025-12-14

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should mark articles as seen in KV after sending notification
{"timestamp":"2025-12-14T19:34:04.502Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844502","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should log failed FCM notifications
{"timestamp":"2025-12-14T19:34:04.465Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844463","userId":null,"path":"/cron/alerts","message":"Alert notification sent to all user devices","type":"general","alertId":"alert-1","symbol":"AAPL","username":"testuser","devicesCount":1,"successCount":0,"failCount":1}
{"timestamp":"2025-12-14T19:34:04.465Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844463","userId":null,"path":"/cron/alerts","message":"Alert cron job completed successfully","type":"general","alertsProcessed":1,"notificationsSent":1}

stdout | test/api/push-token.spec.ts > Push Token API > registerPushToken > should reassign token to new user if different user
✅ FCM token validation passed: length=30, format valid

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > validates days parameter - must be between 1 and 30
[fetch30MinuteData] Received 0 30-minute candles

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should mark articles as seen in KV after sending notification
{"timestamp":"2025-12-14T19:34:04.502Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844502","userId":null,"path":"/cron/news-alerts","message":"Checking news for 1 unique symbols: LXEO","type":"general"}
{"timestamp":"2025-12-14T19:34:04.502Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844502","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/api/push-token.spec.ts > Push Token API > registerPushToken > should reassign token to new user if different user
{"timestamp":"2025-12-14T19:34:04.518Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Reassigning push token to different user","type":"general","username":"testuser","previousUserId":"user-456","deviceType":"android"}

stdout | test/get-historical.spec.ts > getHistorical handler > Parameter validation > accepts symbol parameter
[get-historical] Query result for AAPL (2025-06-17 to 2025-12-14): 0 records found in database
{"timestamp":"2025-12-14T19:34:04.521Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No historical data in database for AAPL","type":"general","dateRange":"2025-06-17 to 2025-12-14","action":"fetching from FMP API"}

stderr | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > validates days parameter - must be between 1 and 30
[getHistoricalIntraday] No 30-minute data available for AAPL

stderr | test/api/user-preferences.spec.ts > User Preferences API > updateUserPreferences > should validate symbols array
{"timestamp":"2025-12-14T19:34:04.526Z","service":"stockly-api-test","level":"ERROR","traceId":"test-trace-id","path":"/test","message":"Failed to update user preferences","type":"general","username":"testuser","error":{"name":"TypeError","message":"Cannot read properties of undefined (reading 'bind')","stack":"TypeError: Cannot read properties of undefined (reading 'bind')\n    at Module.updateUserPreferences (/home/sngvahmed/workspace/stockly/api/src/api/user-preferences.ts:36:63)\n    at /home/sngvahmed/workspace/stockly/api/test/api/user-preferences.spec.ts:142:24\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20"}}

stdout | test/api/get-news.spec.ts > Get News API > getNews > should return news articles
News cache miss for AAPL, fetching from API...

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > list > should log failed list operation
{"timestamp":"2025-12-14T19:34:04.531Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV list failed: prefix=all","type":"data_operation","operation":"kv","key":"*","latencyMs":0,"cacheStatus":"N/A","error":"List failed"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should mark articles as seen in KV after sending notification
{"timestamp":"2025-12-14T19:34:04.502Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844502","userId":null,"path":"/cron/news-alerts","message":"Fetched 1 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:34:04.502Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844502","userId":null,"path":"/cron/news-alerts","message":"Found news for 1 symbols: LXEO","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle FCM notification errors
{"timestamp":"2025-12-14T19:34:04.511Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844511","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stderr | test/api/push-token.spec.ts > Push Token API > registerPushToken > should reassign token to new user if different user
{"timestamp":"2025-12-14T19:34:04.519Z","service":"stockly-api-test","level":"ERROR","traceId":"test-trace-id","userId":null,"path":"/test","message":"Device update verification failed","type":"general","error":"[object Object]"}

stderr | test/notifications/fcm-sender.spec.ts > FCM Sender > sendFCMNotificationWithLogs > should retry on temporary errors
{"timestamp":"2025-12-14T19:34:04.537Z","service":"stockly-api-test","level":"ERROR","traceId":"test-trace-id","userId":null,"path":"/test","message":"FCM push notification failed","type":"fcm_error","fcmErrorCode":"14","fcmErrorType":"UNAVAILABLE","isPermanent":false,"shouldCleanupToken":false,"requestPayload":{"token":"dXXXXXXXXXXXXXXXXXXXXXXXXXXXXX...","title":"Test Title","body":"Test Body","dataKeys":["alertId"]},"errorMessage":"Service unavailable"}

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > validates interval format
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-12-11 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-11 to 2025-12-14

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > invalidateState > should remove state from cache and pending writes
[KV Cache] Queued state update for alert alert-1 (1 pending writes)

stdout | test/alerts-handler.spec.ts > alerts handler > lists alerts
{"timestamp":"2025-12-14T19:34:04.538Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Alerts request authenticated","type":"general","username":"testuser","isAdmin":false,"requestUsername":"testuser","method":"GET"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should mark articles as seen in KV after sending notification
{"timestamp":"2025-12-14T19:34:04.502Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844502","userId":null,"path":"/cron/news-alerts","message":"New article found (published today)","type":"general","symbol":"LXEO","title":"LXEO News Today","publishedDate":"2025-12-14T10:00:00Z"}

stdout | test/api/favorite-stocks.spec.ts > Favorite Stocks API > updateFavoriteStocks > should update favorite stocks for authenticated user
{"timestamp":"2025-12-14T19:34:04.543Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Received favorite stocks update request","type":"general","bodyType":"object","bodyStringified":"{\"symbols\":[\"AAPL\",\"GOOGL\"]}","hasSymbols":true,"bodyKeys":["symbols"]}
{"timestamp":"2025-12-14T19:34:04.543Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Processing symbols array","type":"general","symbolsArrayLength":2,"symbolsArray":"[\"AAPL\",\"GOOGL\"]","symbolsArrayTypes":["string","string"]}
{"timestamp":"2025-12-14T19:34:04.543Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Normalized symbols","type":"general","originalCount":2,"normalizedCount":2,"uniqueCount":2,"uniqueSymbols":["AAPL","GOOGL"]}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle FCM notification errors
{"timestamp":"2025-12-14T19:34:04.511Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844511","userId":null,"path":"/cron/alerts","message":"Processing 1 active alerts","type":"general"}
{"timestamp":"2025-12-14T19:34:04.511Z","service":"stockly-api","level":"DEBUG","traceId":"cron-1765740844511","userId":null,"path":"/cron/alerts","message":"Fetching prices for 1 unique symbols","type":"general","symbols":["AAPL"]}

stdout | test/alerts-handler.spec.ts > alerts handler > lists alerts
{"timestamp":"2025-12-14T19:34:04.539Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Fetched alerts from D1","type":"general","username":"testuser","alertCount":1,"alertIds":["1"]}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should mark articles as seen in KV after sending notification
{"timestamp":"2025-12-14T19:34:04.502Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844502","userId":null,"path":"/cron/news-alerts","message":"Found 1 users with LXEO in favorites: user1","type":"general"}

stdout | test/api/favorite-stocks.spec.ts > Favorite Stocks API > updateFavoriteStocks > should update favorite stocks for authenticated user
{"timestamp":"2025-12-14T19:34:04.544Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Updated favorite stocks","type":"general","username":"testuser","count":2,"symbols":["AAPL","GOOGL"]}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle FCM notification errors
{"timestamp":"2025-12-14T19:34:04.511Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844511","userId":null,"path":"/cron/alerts","message":"Successfully fetched prices for 1 symbols","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Deduplication > should mark articles as seen in KV after sending notification
{"timestamp":"2025-12-14T19:34:04.502Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844502","userId":null,"path":"/cron/news-alerts","message":"Sent 1 notifications for LXEO news to 1 users","type":"general"}
{"timestamp":"2025-12-14T19:34:04.502Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844502","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle FCM notification errors
{"timestamp":"2025-12-14T19:34:04.511Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844511","userId":null,"path":"/cron/alerts","message":"Evaluated 1 alerts, 1 triggered","type":"general"}
{"timestamp":"2025-12-14T19:34:04.511Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844511","userId":null,"path":"/cron/alerts","message":"Alert triggered","type":"general","alertId":"alert-1","symbol":"AAPL","price":205,"direction":"above","threshold":200,"channel":"notification"}

stderr | test/get-stocks.spec.ts > getStocks handler > returns empty array when all API calls fail
Failed to fetch quote for MSFT: Error: boom
    at /home/sngvahmed/workspace/stockly/api/test/get-stocks.spec.ts:191:60
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:155:11
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:26
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1863:10)
    at runTest (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1574:12)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)
    at runFiles (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1787:3)

stdout | test/api/get-news.spec.ts > Get News API > getNews > should handle pagination correctly
News cache miss for AAPL, fetching from API...

stdout | test/get-stock-news.spec.ts > getStockNews handler > fetches news from FMP API when cache misses
No cache for news AAPL, fetching fresh data

stderr | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle FCM notification errors
{"timestamp":"2025-12-14T19:34:04.511Z","service":"stockly-api","level":"ERROR","traceId":"cron-1765740844511","userId":null,"path":"/cron/alerts","message":"Error sending FCM notification","type":"general","alertId":"alert-1","symbol":"AAPL","pushToken":"fcm-token-123","error":{"name":"Error","message":"FCM send failed","stack":"Error: FCM send failed\n    at /home/sngvahmed/workspace/stockly/api/test/cron/alerts-cron.spec.ts:343:9\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:155:11\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:26\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1897:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1863:10)\n    at runTest (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1574:12)\n    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)\n    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)\n    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)"}}

stdout | test/logging/logger.spec.ts > Logger > getLogs > should return copy of log buffer
{"timestamp":"2025-12-14T19:34:04.570Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"Message 1","type":"general"}
{"timestamp":"2025-12-14T19:34:04.570Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"Message 2","type":"general"}

stdout | test/logging/d1-wrapper.spec.ts > LoggedD1Database > LoggedD1PreparedStatement > latency measurement > should measure latency accurately
{"timestamp":"2025-12-14T19:34:04.572Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"D1 first: SELECT * FROM alerts WHERE id = ?","type":"data_operation","operation":"d1","query":"SELECT * FROM alerts WHERE id = ?","latencyMs":10,"cacheStatus":"N/A"}

stdout | test/api/news-archive.spec.ts > News Archive API > toggleArchivedNews > should save article to archive
{"timestamp":"2025-12-14T19:34:04.574Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Article saved successfully","type":"general","username":"testuser","articleId":"article-123","symbol":"AAPL"}

stderr | test/get-stock.spec.ts > getStock handler > returns cached data without calling the upstream API
alertsKv not available, using default config

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle FCM notification errors
{"timestamp":"2025-12-14T19:34:04.512Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844511","userId":null,"path":"/cron/alerts","message":"Alert notification sent to all user devices","type":"general","alertId":"alert-1","symbol":"AAPL","username":"testuser","devicesCount":1,"successCount":0,"failCount":1}
{"timestamp":"2025-12-14T19:34:04.512Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844511","userId":null,"path":"/cron/alerts","message":"Alert cron job completed successfully","type":"general","alertsProcessed":1,"notificationsSent":1}

stdout | test/alerts-handler.spec.ts > alerts handler > creates an alert when payload is valid
{"timestamp":"2025-12-14T19:34:04.578Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Alerts request authenticated","type":"general","username":"testuser","isAdmin":false,"requestUsername":"testuser","method":"POST"}

stdout | test/get-stock.spec.ts > getStock handler > returns cached data without calling the upstream API
{"timestamp":"2025-12-14T19:34:04.575Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for MSFT","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}

stderr | test/api/favorite-stocks.spec.ts > Favorite Stocks API > updateFavoriteStocks > should validate symbols array
{"timestamp":"2025-12-14T19:34:04.584Z","service":"stockly-api-test","level":"ERROR","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cannot read properties of undefined (reading 'bind')","type":"general","username":"testuser","name":"TypeError","stack":"TypeError: Cannot read properties of undefined (reading 'bind')\n    at Module.updateFavoriteStocks (/home/sngvahmed/workspace/stockly/api/src/api/favorite-stocks.ts:111:57)\n    at /home/sngvahmed/workspace/stockly/api/test/api/favorite-stocks.spec.ts:134:24\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20","error":{"name":"TypeError","message":"Cannot read properties of undefined (reading 'bind')","stack":"TypeError: Cannot read properties of undefined (reading 'bind')\n    at Module.updateFavoriteStocks (/home/sngvahmed/workspace/stockly/api/src/api/favorite-stocks.ts:111:57)\n    at /home/sngvahmed/workspace/stockly/api/test/api/favorite-stocks.spec.ts:134:24\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20"}}
{"timestamp":"2025-12-14T19:34:04.584Z","service":"stockly-api-test","level":"ERROR","traceId":"test-trace-id","userId":null,"path":"/test","message":"Unexpected error in updateFavoriteStocks","type":"general","error":"[object Object]"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle multiple alerts
{"timestamp":"2025-12-14T19:34:04.583Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844583","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stdout | test/alerts-handler.spec.ts > alerts handler > creates an alert when payload is valid
{"timestamp":"2025-12-14T19:34:04.578Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Creating alert","type":"general","username":"testuser","symbol":"AAPL","direction":"above","threshold":200}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle multiple alerts
{"timestamp":"2025-12-14T19:34:04.583Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844583","userId":null,"path":"/cron/alerts","message":"Processing 2 active alerts","type":"general"}
{"timestamp":"2025-12-14T19:34:04.583Z","service":"stockly-api","level":"DEBUG","traceId":"cron-1765740844583","userId":null,"path":"/cron/alerts","message":"Fetching prices for 2 unique symbols","type":"general","symbols":["AAPL","MSFT"]}

stdout | test/alerts-handler.spec.ts > alerts handler > creates an alert when payload is valid
{"timestamp":"2025-12-14T19:34:04.578Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Created alert successfully","type":"general","alertId":"2","username":"testuser","alertUsername":"testuser","isAdmin":false}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle multiple alerts
{"timestamp":"2025-12-14T19:34:04.583Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844583","userId":null,"path":"/cron/alerts","message":"Successfully fetched prices for 2 symbols","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send notifications to all users who have the symbol in favorites
{"timestamp":"2025-12-14T19:34:04.602Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844602","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/get-stock-news.spec.ts > getStockNews handler > returns empty array when FMP API returns empty array
No cache for news XYZ, fetching fresh data

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send notifications to all users who have the symbol in favorites
{"timestamp":"2025-12-14T19:34:04.602Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844602","userId":null,"path":"/cron/news-alerts","message":"Checking news for 4 unique symbols: LXEO, AMZN, AAPL, BABA","type":"general"}
{"timestamp":"2025-12-14T19:34:04.602Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844602","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle multiple alerts
{"timestamp":"2025-12-14T19:34:04.583Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844583","userId":null,"path":"/cron/alerts","message":"Evaluated 2 alerts, 2 triggered","type":"general"}
{"timestamp":"2025-12-14T19:34:04.583Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844583","userId":null,"path":"/cron/alerts","message":"Alert triggered","type":"general","alertId":"alert-1","symbol":"AAPL","price":205,"direction":"above","threshold":200,"channel":"notification"}

stderr | test/devices.spec.ts > Devices API > getAllDevices > should handle database errors
{"timestamp":"2025-12-14T19:34:04.609Z","service":"stockly-api-test","level":"ERROR","traceId":"test-trace-id","userId":null,"path":"/test","message":"Failed to get devices","type":"general","username":null,"error":{"name":"Error","message":"Database error","stack":"Error: Database error\n    at Object.<anonymous> (/home/sngvahmed/workspace/stockly/api/test/devices.spec.ts:128:42)\n    at Object.mockCall (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/spy/dist/index.js:96:15)\n    at Object.spy [as prepare] (home/sngvahmed/workspace/stockly/api/node_modules/tinyspy/dist/index.js:47:80)\n    at Module.getAllDevices (/home/sngvahmed/workspace/stockly/api/src/api/devices.ts:69:12)\n    at /home/sngvahmed/workspace/stockly/api/test/devices.spec.ts:133:24\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20"}}

stdout | test/api/news-archive.spec.ts > News Archive API > toggleArchivedNews > should remove article from archive if already saved
{"timestamp":"2025-12-14T19:34:04.617Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Article unsaved successfully","type":"general","username":"testuser","articleId":"article-123"}

 ✓ test/api/user-preferences.spec.ts (3 tests) 254ms
stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > error propagation > should re-throw errors after logging
{"timestamp":"2025-12-14T19:34:04.608Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV get failed: cache:key","type":"data_operation","operation":"kv","key":"cache:key","latencyMs":0,"cacheStatus":"N/A","error":"KV error"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send notifications to all users who have the symbol in favorites
{"timestamp":"2025-12-14T19:34:04.602Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844602","userId":null,"path":"/cron/news-alerts","message":"Fetched 1 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:34:04.602Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844602","userId":null,"path":"/cron/news-alerts","message":"Found news for 1 symbols: LXEO","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle multiple alerts
{"timestamp":"2025-12-14T19:34:04.583Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844583","userId":null,"path":"/cron/alerts","message":"FCM notification sent successfully","type":"general","alertId":"alert-1","symbol":"AAPL","pushToken":"fcm-token-123"}

stdout | test/api/get-news.spec.ts > Get News API > getNews > should handle external API errors gracefully
News cache miss for AAPL, fetching from API...

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle multiple alerts
{"timestamp":"2025-12-14T19:34:04.583Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844583","userId":null,"path":"/cron/alerts","message":"Alert notification sent to all user devices","type":"general","alertId":"alert-1","symbol":"AAPL","username":"testuser","devicesCount":1,"successCount":1,"failCount":0}
{"timestamp":"2025-12-14T19:34:04.583Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844583","userId":null,"path":"/cron/alerts","message":"Alert triggered","type":"general","alertId":"alert-2","symbol":"MSFT","price":310,"direction":"above","threshold":300,"channel":"notification"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send notifications to all users who have the symbol in favorites
{"timestamp":"2025-12-14T19:34:04.602Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844602","userId":null,"path":"/cron/news-alerts","message":"New article found (published today)","type":"general","symbol":"LXEO","title":"LXEO News Today","publishedDate":"2025-12-14T10:00:00Z"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > clearCache > should clear all cached states
[KV Cache] Queued state update for alert alert-1 (1 pending writes)
[KV Cache] Queued state update for alert alert-2 (2 pending writes)

stderr | test/api/get-news.spec.ts > Get News API > getNews > should handle external API errors gracefully
Failed to fetch news from FMP API for symbols AAPL: Error: FMP API failed: HTTP 500
    at fetchNewsFromApi (/home/sngvahmed/workspace/stockly/api/src/api/get-news.ts:68:13)
    at Module.getNews (/home/sngvahmed/workspace/stockly/api/src/api/get-news.ts:293:22)
    at /home/sngvahmed/workspace/stockly/api/test/api/get-news.spec.ts:72:24
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle multiple alerts
{"timestamp":"2025-12-14T19:34:04.584Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844583","userId":null,"path":"/cron/alerts","message":"FCM notification sent successfully","type":"general","alertId":"alert-2","symbol":"MSFT","pushToken":"fcm-token-123"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send notifications to all users who have the symbol in favorites
{"timestamp":"2025-12-14T19:34:04.602Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844602","userId":null,"path":"/cron/news-alerts","message":"Found 2 users with LXEO in favorites: user1, user3","type":"general"}

 ✓ test/search-stock.spec.ts (6 tests) 357ms
stdout | test/get-stock.spec.ts > getStock handler > fetches the quote and caches the parsed response
{"timestamp":"2025-12-14T19:34:04.638Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for AAPL","type":"general","cacheStatus":"MISS"}

stdout | test/alerts-handler.spec.ts > alerts handler > returns 404 when an alert is missing
{"timestamp":"2025-12-14T19:34:04.642Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Alerts request authenticated","type":"general","username":"testuser","isAdmin":false,"requestUsername":"testuser","method":"GET"}

stderr | test/api/get-news.spec.ts > Get News API > getNews > should handle external API errors gracefully
Error fetching news for AAPL: Error: FMP API failed: HTTP 500
    at fetchNewsFromApi (/home/sngvahmed/workspace/stockly/api/src/api/get-news.ts:68:13)
    at Module.getNews (/home/sngvahmed/workspace/stockly/api/src/api/get-news.ts:293:22)
    at /home/sngvahmed/workspace/stockly/api/test/api/get-news.spec.ts:72:24
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle multiple alerts
{"timestamp":"2025-12-14T19:34:04.584Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844583","userId":null,"path":"/cron/alerts","message":"Alert notification sent to all user devices","type":"general","alertId":"alert-2","symbol":"MSFT","username":"testuser","devicesCount":1,"successCount":1,"failCount":0}
{"timestamp":"2025-12-14T19:34:04.584Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844583","userId":null,"path":"/cron/alerts","message":"Alert cron job completed successfully","type":"general","alertsProcessed":2,"notificationsSent":2}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send notifications to all users who have the symbol in favorites
{"timestamp":"2025-12-14T19:34:04.602Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844602","userId":null,"path":"/cron/news-alerts","message":"Sent 2 notifications for LXEO news to 2 users","type":"general"}
{"timestamp":"2025-12-14T19:34:04.602Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844602","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stdout | test/get-stock.spec.ts > getStock handler > fetches the quote and caches the parsed response
{"timestamp":"2025-12-14T19:34:04.638Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /quote","type":"api_call","apiProvider":"FMP","endpoint":"/quote","method":"GET","latencyMs":0}

stdout | test/get-stock.spec.ts > getStock handler > fetches the quote and caches the parsed response
{"timestamp":"2025-12-14T19:34:04.639Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","latencyMs":0}

stdout | test/get-stock-news.spec.ts > getStockNews handler > handles API errors gracefully
No cache for news AAPL, fetching fresh data

stdout | test/logging/logger.spec.ts > Logger > clearLogs > should clear log buffer
{"timestamp":"2025-12-14T19:34:04.669Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"Message 1","type":"general"}
{"timestamp":"2025-12-14T19:34:04.669Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"Message 2","type":"general"}

stdout | test/logging/d1-wrapper.spec.ts > LoggedD1Database > LoggedD1PreparedStatement > error propagation > should re-throw errors after logging
{"timestamp":"2025-12-14T19:34:04.669Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"D1 first failed: SELECT * FROM alerts WHERE id = ?","type":"data_operation","operation":"d1","query":"SELECT * FROM alerts WHERE id = ?","latencyMs":0,"cacheStatus":"N/A","error":"Database error"}

stdout | test/get-stock.spec.ts > getStock handler > fetches the quote and caches the parsed response
{"timestamp":"2025-12-14T19:34:04.639Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API response","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile?symbol=AAPL&apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","responseType":"array","responseLength":0}
{"timestamp":"2025-12-14T19:34:04.639Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API returned empty array","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile?symbol=AAPL&apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM"}

stderr | test/get-stock-news.spec.ts > getStockNews handler > handles API errors gracefully
Provider API failed for news AAPL: HTTP 500

stdout | test/alerts-handler.spec.ts > alerts handler > updates alerts via PUT
{"timestamp":"2025-12-14T19:34:04.680Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Alerts request authenticated","type":"general","username":"testuser","isAdmin":false,"requestUsername":"testuser","method":"PUT"}

stdout | test/get-stock.spec.ts > getStock handler > fetches the quote and caches the parsed response
{"timestamp":"2025-12-14T19:34:04.639Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","latencyMs":0}

stdout | test/api/favorite-stocks.spec.ts > Favorite Stocks API > deleteFavoriteStock > should delete favorite stock for authenticated user
{"timestamp":"2025-12-14T19:34:04.685Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Deleted favorite stock","type":"general","username":"testuser","symbol":"AAPL"}

stdout | test/alerts-handler.spec.ts > alerts handler > updates alerts via PUT
{"timestamp":"2025-12-14T19:34:04.680Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Updated alert","type":"general","alertId":"3","username":"testuser"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should skip when no prices available
{"timestamp":"2025-12-14T19:34:04.686Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844686","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stdout | test/get-stock.spec.ts > getStock handler > fetches the quote and caches the parsed response
{"timestamp":"2025-12-14T19:34:04.639Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API response","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","responseType":"array","responseLength":0}
{"timestamp":"2025-12-14T19:34:04.639Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API returned empty array","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send separate notifications for different symbols
{"timestamp":"2025-12-14T19:34:04.687Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844687","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should skip when no prices available
{"timestamp":"2025-12-14T19:34:04.687Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844686","userId":null,"path":"/cron/alerts","message":"Processing 1 active alerts","type":"general"}
{"timestamp":"2025-12-14T19:34:04.687Z","service":"stockly-api","level":"DEBUG","traceId":"cron-1765740844686","userId":null,"path":"/cron/alerts","message":"Fetching prices for 1 unique symbols","type":"general","symbols":["AAPL"]}

stdout | test/get-stock.spec.ts > getStock handler > fetches the quote and caches the parsed response
{"timestamp":"2025-12-14T19:34:04.639Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","latencyMs":0}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send separate notifications for different symbols
{"timestamp":"2025-12-14T19:34:04.687Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844687","userId":null,"path":"/cron/news-alerts","message":"Checking news for 2 unique symbols: LXEO, AMZN","type":"general"}
{"timestamp":"2025-12-14T19:34:04.687Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844687","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stderr | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should skip when no prices available
{"timestamp":"2025-12-14T19:34:04.687Z","service":"stockly-api","level":"WARN","traceId":"cron-1765740844686","userId":null,"path":"/cron/alerts","message":"No prices available for alerts run","type":"general","symbols":["AAPL"]}

stdout | test/get-stock.spec.ts > getStock handler > fetches the quote and caches the parsed response
{"timestamp":"2025-12-14T19:34:04.639Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API response","type":"general","endpoint":"https://financialmodelingprep.com/stable/company/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","responseType":"array","responseLength":0}
{"timestamp":"2025-12-14T19:34:04.639Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API returned empty array","type":"general","endpoint":"https://financialmodelingprep.com/stable/company/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send separate notifications for different symbols
{"timestamp":"2025-12-14T19:34:04.687Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844687","userId":null,"path":"/cron/news-alerts","message":"Fetched 2 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:34:04.687Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844687","userId":null,"path":"/cron/news-alerts","message":"Found news for 2 symbols: LXEO, AMZN","type":"general"}

stdout | test/get-stock-news.spec.ts > getStockNews handler > handles network errors gracefully
No cache for news AAPL, fetching fresh data

stdout | test/get-stock.spec.ts > getStock handler > fetches the quote and caches the parsed response
{"timestamp":"2025-12-14T19:34:04.639Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","latencyMs":0}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send separate notifications for different symbols
{"timestamp":"2025-12-14T19:34:04.687Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844687","userId":null,"path":"/cron/news-alerts","message":"New article found (published today)","type":"general","symbol":"LXEO","title":"LXEO News Today","publishedDate":"2025-12-14T10:00:00Z"}

stdout | test/alerts/state-cache.spec.ts > Alert State Cache > getCacheStats > should return cache statistics
[KV Cache] Queued state update for alert alert-1 (1 pending writes)
[KV Cache] Queued state update for alert alert-2 (2 pending writes)

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > cache status detection > should detect HIT for non-null text value
{"timestamp":"2025-12-14T19:34:04.710Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV get: key","type":"data_operation","operation":"kv","key":"key","latencyMs":0,"cacheStatus":"HIT"}

stderr | test/get-stock-news.spec.ts > getStockNews handler > handles network errors gracefully
Error fetching news for AAPL: Error: Failed to fetch
    at /home/sngvahmed/workspace/stockly/api/test/get-stock-news.spec.ts:185:60
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:155:11
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:26
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1863:10)
    at runTest (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1574:12)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)
    at runFiles (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1787:3)
Provider network error for news AAPL: Failed to fetch

stdout | test/api/get-news.spec.ts > Get News API > getFavoriteNews > should return favorite news for authenticated user
{"timestamp":"2025-12-14T19:34:04.710Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Fetching favorite news","type":"general","username":"testuser"}

stdout | test/get-stock.spec.ts > getStock handler > fetches the quote and caches the parsed response
{"timestamp":"2025-12-14T19:34:04.640Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API response","type":"general","endpoint":"https://financialmodelingprep.com/api/v3/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","responseType":"array","responseLength":0}
{"timestamp":"2025-12-14T19:34:04.640Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API returned empty array","type":"general","endpoint":"https://financialmodelingprep.com/api/v3/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send separate notifications for different symbols
{"timestamp":"2025-12-14T19:34:04.687Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844687","userId":null,"path":"/cron/news-alerts","message":"Found 1 users with LXEO in favorites: user1","type":"general"}

stdout | test/api/get-news.spec.ts > Get News API > getFavoriteNews > should return favorite news for authenticated user
{"timestamp":"2025-12-14T19:34:04.710Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No favorite symbols selected","type":"general","username":"testuser"}

stdout | test/get-stock.spec.ts > getStock handler > fetches the quote and caches the parsed response
{"timestamp":"2025-12-14T19:34:04.640Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Final description resolved","type":"general","hasDescription":false,"descriptionLength":0,"source":"none"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send separate notifications for different symbols
{"timestamp":"2025-12-14T19:34:04.687Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844687","userId":null,"path":"/cron/news-alerts","message":"Sent 2 notifications for LXEO news to 1 users","type":"general"}

stdout | test/get-stock.spec.ts > getStock handler > returns an error when the upstream API fails
{"timestamp":"2025-12-14T19:34:04.680Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for TSLA","type":"general","cacheStatus":"MISS"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send separate notifications for different symbols
{"timestamp":"2025-12-14T19:34:04.687Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844687","userId":null,"path":"/cron/news-alerts","message":"New article found (published today)","type":"general","symbol":"AMZN","title":"AMZN News Today","publishedDate":"2025-12-14T11:00:00Z"}

stderr | test/get-stock.spec.ts > getStock handler > returns an error when the upstream API fails
{"timestamp":"2025-12-14T19:34:04.681Z","service":"stockly-api-test","level":"ERROR","traceId":"test-trace-id","userId":null,"path":"/test","message":"ERROR in getStock","type":"general","symbol":"TSLA","error":{"name":"Error","message":"fail","stack":"Error: fail\n    at /home/sngvahmed/workspace/stockly/api/test/get-stock.spec.ts:136:60\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:155:11\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:26\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1897:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1863:10)\n    at runTest (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1574:12)\n    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)\n    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)\n    at runFiles (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1787:3)"}}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send separate notifications for different symbols
{"timestamp":"2025-12-14T19:34:04.687Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844687","userId":null,"path":"/cron/news-alerts","message":"Found 2 users with AMZN in favorites: user1, user2","type":"general"}

 ✓ test/api/settings.spec.ts (4 tests) 361ms
stdout | test/alerts-handler.spec.ts > alerts handler > deletes alerts and clears KV state
{"timestamp":"2025-12-14T19:34:04.739Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Alerts request authenticated","type":"general","username":"testuser","isAdmin":false,"requestUsername":"testuser","method":"DELETE"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should send separate notifications for different symbols
{"timestamp":"2025-12-14T19:34:04.687Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844687","userId":null,"path":"/cron/news-alerts","message":"Sent 2 notifications for AMZN news to 2 users","type":"general"}
{"timestamp":"2025-12-14T19:34:04.687Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844687","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should flush pending KV writes
{"timestamp":"2025-12-14T19:34:04.743Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844743","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stdout | test/alerts-handler.spec.ts > alerts handler > deletes alerts and clears KV state
{"timestamp":"2025-12-14T19:34:04.740Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Deleted alert","type":"general","alertId":"123","username":"testuser"}

 ✓ test/contract/openapi-validation.spec.ts (6 tests) 500ms
stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should not send notifications if user has no push token
{"timestamp":"2025-12-14T19:34:04.730Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844730","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should flush pending KV writes
{"timestamp":"2025-12-14T19:34:04.743Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844743","userId":null,"path":"/cron/alerts","message":"Processing 1 active alerts","type":"general"}
{"timestamp":"2025-12-14T19:34:04.743Z","service":"stockly-api","level":"DEBUG","traceId":"cron-1765740844743","userId":null,"path":"/cron/alerts","message":"Fetching prices for 1 unique symbols","type":"general","symbols":["AAPL"]}

 ✓ test/api/preferences.spec.ts (5 tests) 391ms
stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should not send notifications if user has no push token
{"timestamp":"2025-12-14T19:34:04.730Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844730","userId":null,"path":"/cron/news-alerts","message":"Checking news for 1 unique symbols: LXEO","type":"general"}
{"timestamp":"2025-12-14T19:34:04.730Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844730","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > cache status detection > should detect HIT for non-null json value
{"timestamp":"2025-12-14T19:34:04.756Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV get: key","type":"data_operation","operation":"kv","key":"key","latencyMs":0,"cacheStatus":"HIT"}

stdout | test/get-stock-news.spec.ts > getStockNews handler > handles simulation mode
No cache for news AAPL, fetching fresh data

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should flush pending KV writes
{"timestamp":"2025-12-14T19:34:04.743Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844743","userId":null,"path":"/cron/alerts","message":"Successfully fetched prices for 1 symbols","type":"general"}

 ✓ test/api/news-archive.spec.ts (4 tests) 329ms
stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should not send notifications if user has no push token
{"timestamp":"2025-12-14T19:34:04.730Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844730","userId":null,"path":"/cron/news-alerts","message":"Fetched 1 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:34:04.730Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844730","userId":null,"path":"/cron/news-alerts","message":"Found news for 1 symbols: LXEO","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should flush pending KV writes
{"timestamp":"2025-12-14T19:34:04.743Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844743","userId":null,"path":"/cron/alerts","message":"Evaluated 1 alerts, 0 triggered","type":"general"}
{"timestamp":"2025-12-14T19:34:04.743Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844743","userId":null,"path":"/cron/alerts","message":"Alert cron job completed successfully","type":"general","alertsProcessed":1,"notificationsSent":0}

stdout | test/get-stock.spec.ts > getStock handler > returns stale data from DB when simulation mode is enabled
{"timestamp":"2025-12-14T19:34:04.769Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for AAPL","type":"general","cacheStatus":"MISS"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should not send notifications if user has no push token
{"timestamp":"2025-12-14T19:34:04.730Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844730","userId":null,"path":"/cron/news-alerts","message":"New article found (published today)","type":"general","symbol":"LXEO","title":"LXEO News Today","publishedDate":"2025-12-14T10:00:00Z"}

 ✓ test/api/favorite-stocks.spec.ts (5 tests) 461ms
stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Invalid Input Handling > should handle invalid symbol format
{"timestamp":"2025-12-14T19:34:04.779Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for !!!","type":"general","cacheStatus":"MISS"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should send logs to Loki if configured
{"timestamp":"2025-12-14T19:34:04.780Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844780","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should not send notifications if user has no push token
{"timestamp":"2025-12-14T19:34:04.730Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844730","userId":null,"path":"/cron/news-alerts","message":"Found 1 users with LXEO in favorites: user1","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should send logs to Loki if configured
{"timestamp":"2025-12-14T19:34:04.780Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844780","userId":null,"path":"/cron/alerts","message":"Processing 1 active alerts","type":"general"}
{"timestamp":"2025-12-14T19:34:04.780Z","service":"stockly-api","level":"DEBUG","traceId":"cron-1765740844780","userId":null,"path":"/cron/alerts","message":"Fetching prices for 1 unique symbols","type":"general","symbols":["AAPL"]}

stderr | test/notifications/fcm-sender.spec.ts > FCM Sender > sendFCMNotificationWithLogs > should not retry on permanent errors
{"timestamp":"2025-12-14T19:34:04.785Z","service":"stockly-api-test","level":"ERROR","traceId":"test-trace-id","userId":null,"path":"/test","message":"FCM push notification failed","type":"fcm_error","fcmErrorCode":"5","fcmErrorType":"NOT_FOUND","isPermanent":true,"shouldCleanupToken":true,"requestPayload":{"token":"dXXXXXXXXXXXXXXXXXXXXXXXXXXXXX...","title":"Test Title","body":"Test Body","dataKeys":["alertId"]},"errorMessage":"Token not found"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Notification Sending > should not send notifications if user has no push token
{"timestamp":"2025-12-14T19:34:04.730Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844730","userId":null,"path":"/cron/news-alerts","message":"Sent 0 notifications for LXEO news to 1 users","type":"general"}
{"timestamp":"2025-12-14T19:34:04.730Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844730","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should send logs to Loki if configured
{"timestamp":"2025-12-14T19:34:04.780Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844780","userId":null,"path":"/cron/alerts","message":"Successfully fetched prices for 1 symbols","type":"general"}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > cache status detection > should detect MISS for null value
{"timestamp":"2025-12-14T19:34:04.794Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV get: key","type":"data_operation","operation":"kv","key":"key","latencyMs":0,"cacheStatus":"MISS"}

stdout | test/get-stock-news.spec.ts > getStockNews handler > normalizes news data correctly
No cache for news AAPL, fetching fresh data

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should send logs to Loki if configured
{"timestamp":"2025-12-14T19:34:04.780Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844780","userId":null,"path":"/cron/alerts","message":"Evaluated 1 alerts, 0 triggered","type":"general"}
{"timestamp":"2025-12-14T19:34:04.780Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844780","userId":null,"path":"/cron/alerts","message":"Alert cron job completed successfully","type":"general","alertsProcessed":1,"notificationsSent":0}

stderr | test/get-stocks.spec.ts > getStocks handler > handles partial failures gracefully with Promise.allSettled
Failed to fetch quote for INVALID: Error: Failed to fetch INVALID
    at fetchQuoteFromApi (/home/sngvahmed/workspace/stockly/api/src/api/get-stocks.ts:178:11)
    at async Promise.allSettled (index 1)
    at fetchQuotesBatchFromApi (/home/sngvahmed/workspace/stockly/api/src/api/get-stocks.ts:216:24)
    at getStocks (/home/sngvahmed/workspace/stockly/api/src/api/get-stocks.ts:304:25)
    at /home/sngvahmed/workspace/stockly/api/test/get-stocks.spec.ts:473:22
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20

 ✓ test/api/throttle-cache.spec.ts (21 tests) 1259ms
stdout | test/get-stock.spec.ts > getStock handler > returns no_price_available when simulation is enabled but no DB data exists
{"timestamp":"2025-12-14T19:34:04.804Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for AAPL","type":"general","cacheStatus":"MISS"}

 ❯ test/api/push-token.spec.ts (5 tests | 3 failed) 429ms
   × Push Token API > registerPushToken > should register new push token 24ms
     → expected 500 to be 201 // Object.is equality
   × Push Token API > registerPushToken > should update existing push token 52ms
     → expected 500 to be 200 // Object.is equality
   × Push Token API > registerPushToken > should reassign token to new user if different user 7ms
     → expected 500 to be 200 // Object.is equality
   ✓ Push Token API > registerPushToken > should validate token format 59ms
   ✓ Push Token API > getPushToken > should return push tokens for authenticated user 58ms
 ✓ test/api/get-news.spec.ts (4 tests) 329ms
stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should not send logs to Loki if not configured
{"timestamp":"2025-12-14T19:34:04.817Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844817","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

 ✓ test/alerts/state-cache.spec.ts (19 tests) 1297ms
stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should not send logs to Loki if not configured
{"timestamp":"2025-12-14T19:34:04.817Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844817","userId":null,"path":"/cron/alerts","message":"Processing 1 active alerts","type":"general"}
{"timestamp":"2025-12-14T19:34:04.817Z","service":"stockly-api","level":"DEBUG","traceId":"cron-1765740844817","userId":null,"path":"/cron/alerts","message":"Fetching prices for 1 unique symbols","type":"general","symbols":["AAPL"]}

stderr | test/notifications/fcm-sender.spec.ts > FCM Sender > sendFCMNotificationWithLogs > should log FCM errors
{"timestamp":"2025-12-14T19:34:04.823Z","service":"stockly-api-test","level":"ERROR","traceId":"test-trace-id","userId":null,"path":"/test","message":"FCM push notification failed","type":"fcm_error","fcmErrorCode":"3","fcmErrorType":"INVALID_ARGUMENT","isPermanent":true,"shouldCleanupToken":true,"requestPayload":{"token":"dXXXXXXXXXXXXXXXXXXXXXXXXXXXXX...","title":"Test Title","body":"Test Body","dataKeys":["alertId"]},"errorMessage":"Invalid token"}

stderr | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should not send logs to Loki if not configured
{"timestamp":"2025-12-14T19:34:04.817Z","service":"stockly-api","level":"WARN","traceId":"cron-1765740844817","userId":null,"path":"/cron/alerts","message":"No prices available for alerts run","type":"general","symbols":["AAPL"]}

stdout | test/logging/logger.spec.ts > Logger > updateContext > should use updated context in new logs
{"timestamp":"2025-12-14T19:34:04.829Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-123","userId":"updated-user","path":"/v1/api/test","message":"New message","type":"general"}

 ✓ test/alerts-handler.spec.ts (5 tests) 301ms
 ✓ test/logging/d1-wrapper.spec.ts (15 tests) 1149ms
stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > cache status detection > should use N/A for put operations
{"timestamp":"2025-12-14T19:34:04.838Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV put: key","type":"data_operation","operation":"kv","key":"key","latencyMs":0,"cacheStatus":"N/A"}

 ✓ test/get-stock-news.spec.ts (8 tests) 435ms
 ✓ test/get-stocks.spec.ts (10 tests) 544ms
stdout | test/get-stock.spec.ts > getStock handler > calls provider normally when simulation is disabled
{"timestamp":"2025-12-14T19:34:04.847Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for AAPL","type":"general","cacheStatus":"MISS"}

stdout | test/get-stock.spec.ts > getStock handler > calls provider normally when simulation is disabled
{"timestamp":"2025-12-14T19:34:04.847Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /quote","type":"api_call","apiProvider":"FMP","endpoint":"/quote","method":"GET","latencyMs":0}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Error Handling > should handle API fetch errors gracefully
{"timestamp":"2025-12-14T19:34:04.852Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844852","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle fatal errors and re-throw
{"timestamp":"2025-12-14T19:34:04.852Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844852","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stdout | test/get-stock.spec.ts > getStock handler > calls provider normally when simulation is disabled
{"timestamp":"2025-12-14T19:34:04.847Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","latencyMs":0}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Error Handling > should handle API fetch errors gracefully
{"timestamp":"2025-12-14T19:34:04.853Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844852","userId":null,"path":"/cron/news-alerts","message":"Checking news for 1 unique symbols: LXEO","type":"general"}
{"timestamp":"2025-12-14T19:34:04.853Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844852","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stderr | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle fatal errors and re-throw
{"timestamp":"2025-12-14T19:34:04.852Z","service":"stockly-api","level":"ERROR","traceId":"cron-1765740844852","userId":null,"path":"/cron/alerts","message":"Fatal error in alert cron job","type":"general","error":{"name":"Error","message":"Fatal error","stack":"Error: Fatal error\n    at /home/sngvahmed/workspace/stockly/api/test/cron/alerts-cron.spec.ts:530:21\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:155:11\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:26\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1897:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1863:10)\n    at runTest (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1574:12)\n    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)\n    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)\n    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)"}}

stdout | test/get-stock.spec.ts > getStock handler > calls provider normally when simulation is disabled
{"timestamp":"2025-12-14T19:34:04.847Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API response","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile?symbol=AAPL&apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","responseType":"array","responseLength":0}
{"timestamp":"2025-12-14T19:34:04.847Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API returned empty array","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile?symbol=AAPL&apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM"}

stdout | test/integration/stock-flow.spec.ts > Stock Data Flow Integration > Stock Search to Details Flow > should complete flow: search -> get stock -> get details
{"timestamp":"2025-12-14T19:34:04.855Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for AAPL","type":"general","cacheStatus":"MISS"}

stderr | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Error Handling > should handle API fetch errors gracefully
{"timestamp":"2025-12-14T19:34:04.853Z","service":"stockly-api","level":"WARN","traceId":"cron-news-1765740844852","userId":null,"path":"/cron/news-alerts","message":"Failed to fetch news for symbols","type":"general","status":500,"symbols":"LXEO"}

stdout | test/get-stock.spec.ts > getStock handler > calls provider normally when simulation is disabled
{"timestamp":"2025-12-14T19:34:04.847Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","latencyMs":0}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > cache status detection > should use N/A for delete operations
{"timestamp":"2025-12-14T19:34:04.862Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV delete: key","type":"data_operation","operation":"kv","key":"key","latencyMs":0,"cacheStatus":"N/A"}

stdout | test/integration/stock-flow.spec.ts > Stock Data Flow Integration > Stock Search to Details Flow > should complete flow: search -> get stock -> get details
{"timestamp":"2025-12-14T19:34:04.856Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /quote","type":"api_call","apiProvider":"FMP","endpoint":"/quote","method":"GET","latencyMs":1}

stdout | test/get-stock.spec.ts > getStock handler > calls provider normally when simulation is disabled
{"timestamp":"2025-12-14T19:34:04.847Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API response","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","responseType":"array","responseLength":0}
{"timestamp":"2025-12-14T19:34:04.847Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API returned empty array","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM"}

stdout | test/integration/stock-flow.spec.ts > Stock Data Flow Integration > Stock Search to Details Flow > should complete flow: search -> get stock -> get details
{"timestamp":"2025-12-14T19:34:04.856Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","latencyMs":0}

stdout | test/get-stock.spec.ts > getStock handler > calls provider normally when simulation is disabled
{"timestamp":"2025-12-14T19:34:04.847Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","latencyMs":0}

stdout | test/integration/stock-flow.spec.ts > Stock Data Flow Integration > Stock Search to Details Flow > should complete flow: search -> get stock -> get details
{"timestamp":"2025-12-14T19:34:04.856Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API response","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile?symbol=AAPL&apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","responseType":"object","responseLength":"N/A"}
{"timestamp":"2025-12-14T19:34:04.856Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile fetched but no description field","type":"general","profileKeys":["price","symbol"]}

stdout | test/get-stock.spec.ts > getStock handler > calls provider normally when simulation is disabled
{"timestamp":"2025-12-14T19:34:04.847Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API response","type":"general","endpoint":"https://financialmodelingprep.com/stable/company/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","responseType":"array","responseLength":0}
{"timestamp":"2025-12-14T19:34:04.847Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API returned empty array","type":"general","endpoint":"https://financialmodelingprep.com/stable/company/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM"}

stdout | test/integration/stock-flow.spec.ts > Stock Data Flow Integration > Stock Search to Details Flow > should complete flow: search -> get stock -> get details
{"timestamp":"2025-12-14T19:34:04.856Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Final description resolved","type":"general","hasDescription":false,"descriptionLength":0,"source":"none"}

stdout | test/get-stock.spec.ts > getStock handler > calls provider normally when simulation is disabled
{"timestamp":"2025-12-14T19:34:04.847Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","latencyMs":0}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should use default KV write interval if not in config
{"timestamp":"2025-12-14T19:34:04.878Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844878","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stdout | test/integration/stock-flow.spec.ts > Stock Data Flow Integration > Stock Search to Details Flow > should complete flow: search -> get stock -> get details
[fetchAndSaveHistoricalPrice] Starting fetch for AAPL from FMP API
[fetchAndSaveHistoricalPrice] Fetching from: https://financialmodelingprep.com/stable/historical-chart/30min?symbol=AAPL&apikey=***

stdout | test/get-stock.spec.ts > getStock handler > calls provider normally when simulation is disabled
{"timestamp":"2025-12-14T19:34:04.847Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API response","type":"general","endpoint":"https://financialmodelingprep.com/api/v3/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","responseType":"array","responseLength":0}
{"timestamp":"2025-12-14T19:34:04.847Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API returned empty array","type":"general","endpoint":"https://financialmodelingprep.com/api/v3/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM"}

stderr | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > validates interval format
[fetch30MinuteData] HTTP 401: {
  "Error Message": "Invalid API KEY. Feel free to create a Free API Key or visit https://site.financialmodelingprep.com/faqs?search=why-is-my-api-key-invalid for more information."
}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Error Handling > should handle network errors gracefully
{"timestamp":"2025-12-14T19:34:04.878Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844878","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stderr | test/integration/stock-flow.spec.ts > Stock Data Flow Integration > Stock Search to Details Flow > should complete flow: search -> get stock -> get details
[fetchAndSaveHistoricalPrice] Failed to parse date from timestamp undefined, skipping record

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should use default KV write interval if not in config
{"timestamp":"2025-12-14T19:34:04.878Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844878","userId":null,"path":"/cron/alerts","message":"Processing 1 active alerts","type":"general"}
{"timestamp":"2025-12-14T19:34:04.878Z","service":"stockly-api","level":"DEBUG","traceId":"cron-1765740844878","userId":null,"path":"/cron/alerts","message":"Fetching prices for 1 unique symbols","type":"general","symbols":["AAPL"]}

stdout | test/get-stock.spec.ts > getStock handler > calls provider normally when simulation is disabled
{"timestamp":"2025-12-14T19:34:04.847Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Final description resolved","type":"general","hasDescription":false,"descriptionLength":0,"source":"none"}

stderr | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > validates interval format
[getHistoricalIntraday] Error: Failed to fetch 30-minute data: HTTP 401 Error: Failed to fetch 30-minute data: HTTP 401
    at fetch30MinuteData (/home/sngvahmed/workspace/stockly/api/src/api/get-historical-intraday.ts:171:15)
    at getHistoricalIntraday (/home/sngvahmed/workspace/stockly/api/src/api/get-historical-intraday.ts:252:31)
    at /home/sngvahmed/workspace/stockly/api/test/api/get-historical-intraday.spec.ts:119:26
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Error Handling > should handle network errors gracefully
{"timestamp":"2025-12-14T19:34:04.878Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844878","userId":null,"path":"/cron/news-alerts","message":"Checking news for 1 unique symbols: LXEO","type":"general"}
{"timestamp":"2025-12-14T19:34:04.878Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844878","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/logging/kv-wrapper.spec.ts > LoggedKVNamespace > cache status detection > should use N/A for list operations
{"timestamp":"2025-12-14T19:34:04.886Z","service":"test","level":"DEBUG","traceId":"test-trace","userId":null,"path":"/test","message":"KV list: prefix=all","type":"data_operation","operation":"kv","key":"*","latencyMs":0,"cacheStatus":"N/A"}

stdout | test/integration/stock-flow.spec.ts > Stock Data Flow Integration > Stock Search to Details Flow > should complete flow: search -> get stock -> get details
[fetchAndSaveHistoricalPrice] Received single record from FMP API
[fetchAndSaveHistoricalPrice] FMP API returned 1 records for AAPL
[fetchAndSaveHistoricalPrice] Sample record structure: {
  date: undefined,
  hasOpen: false,
  hasHigh: false,
  hasLow: false,
  hasClose: false,
  hasPrice: true,
  keys: [ 'price', 'symbol' ]
}
Saved 0 daily candles (aggregated from 1 1-hour records) for AAPL with OHLC data

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should use default KV write interval if not in config
{"timestamp":"2025-12-14T19:34:04.878Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844878","userId":null,"path":"/cron/alerts","message":"Successfully fetched prices for 1 symbols","type":"general"}

stdout | test/get-stock.spec.ts > getStock handler > falls back to DB and returns stale data when provider API fails
{"timestamp":"2025-12-14T19:34:04.870Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for AAPL","type":"general","cacheStatus":"MISS"}

stderr | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Error Handling > should handle network errors gracefully
{"timestamp":"2025-12-14T19:34:04.878Z","service":"stockly-api","level":"ERROR","traceId":"cron-news-1765740844878","userId":null,"path":"/cron/news-alerts","message":"Failed to fetch news from FMP API","type":"general","error":{"name":"Error","message":"Network error","stack":"Error: Network error\n    at /home/sngvahmed/workspace/stockly/api/test/cron/news-alert-cron.spec.ts:641:47\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:155:11\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:26\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1897:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1863:10)\n    at runTest (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1574:12)\n    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)\n    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)\n    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)"}}

stdout | test/integration/stock-flow.spec.ts > Stock Data Flow Integration > Stock Search to Details Flow > should complete flow: search -> get stock -> get details
Cache miss for stock details: AAPL, fetching...

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should use default KV write interval if not in config
{"timestamp":"2025-12-14T19:34:04.878Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844878","userId":null,"path":"/cron/alerts","message":"Evaluated 1 alerts, 0 triggered","type":"general"}
{"timestamp":"2025-12-14T19:34:04.878Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844878","userId":null,"path":"/cron/alerts","message":"Alert cron job completed successfully","type":"general","alertsProcessed":1,"notificationsSent":0}

stdout | test/get-stock.spec.ts > getStock handler > falls back to DB and returns stale data when provider API fails
{"timestamp":"2025-12-14T19:34:04.871Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /quote","type":"api_call","apiProvider":"FMP","endpoint":"/quote","method":"GET","statusCode":500,"latencyMs":0}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Error Handling > should handle network errors gracefully
{"timestamp":"2025-12-14T19:34:04.881Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844878","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stderr | test/get-stock.spec.ts > getStock handler > falls back to DB and returns stale data when provider API fails
{"timestamp":"2025-12-14T19:34:04.871Z","service":"stockly-api-test","level":"WARN","traceId":"test-trace-id","userId":null,"path":"/test","message":"Provider API failed for AAPL","type":"general","statusCode":500,"apiProvider":"FMP"}

stdout | test/get-news.spec.ts > News API > getGeneralNews > should return general news from FMP API
[News Cache] Queued news update for news:general (1 pending writes)
[News Cache] Flushing 1 pending writes to KV...

stdout | test/get-news.spec.ts > News API > getGeneralNews > should return general news from FMP API
[News Cache] Flushed 1/1 writes to KV

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle array response from quote API
{"timestamp":"2025-12-14T19:34:04.898Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844898","userId":null,"path":"/cron/alerts","message":"Starting alert evaluation cron job","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Error Handling > should skip users with invalid favorite symbols JSON
{"timestamp":"2025-12-14T19:34:04.900Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844900","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle array response from quote API
{"timestamp":"2025-12-14T19:34:04.898Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844898","userId":null,"path":"/cron/alerts","message":"Processing 1 active alerts","type":"general"}
{"timestamp":"2025-12-14T19:34:04.898Z","service":"stockly-api","level":"DEBUG","traceId":"cron-1765740844898","userId":null,"path":"/cron/alerts","message":"Fetching prices for 1 unique symbols","type":"general","symbols":["AAPL"]}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Error Handling > should skip users with invalid favorite symbols JSON
{"timestamp":"2025-12-14T19:34:04.900Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844900","userId":null,"path":"/cron/news-alerts","message":"Checking news for 1 unique symbols: LXEO","type":"general"}
{"timestamp":"2025-12-14T19:34:04.900Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844900","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle array response from quote API
{"timestamp":"2025-12-14T19:34:04.899Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844898","userId":null,"path":"/cron/alerts","message":"Successfully fetched prices for 1 symbols","type":"general"}

stderr | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Error Handling > should skip users with invalid favorite symbols JSON
{"timestamp":"2025-12-14T19:34:04.900Z","service":"stockly-api","level":"WARN","traceId":"cron-news-1765740844900","userId":"user2","path":"/cron/news-alerts","message":"Failed to parse news_favorite_symbols","type":"general"}

stdout | test/cron/alerts-cron.spec.ts > Alert Cron Job > runAlertCron > should handle array response from quote API
{"timestamp":"2025-12-14T19:34:04.899Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844898","userId":null,"path":"/cron/alerts","message":"Evaluated 1 alerts, 0 triggered","type":"general"}
{"timestamp":"2025-12-14T19:34:04.899Z","service":"stockly-api","level":"INFO","traceId":"cron-1765740844898","userId":null,"path":"/cron/alerts","message":"Alert cron job completed successfully","type":"general","alertsProcessed":1,"notificationsSent":0}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Error Handling > should skip users with invalid favorite symbols JSON
{"timestamp":"2025-12-14T19:34:04.900Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844900","userId":null,"path":"/cron/news-alerts","message":"Fetched 0 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:34:04.900Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844900","userId":null,"path":"/cron/news-alerts","message":"Found news for 0 symbols: ","type":"general"}
{"timestamp":"2025-12-14T19:34:04.900Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844900","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stderr | test/get-stock.spec.ts > getStock handler > falls back to DB and returns stale data when provider API fails
{"timestamp":"2025-12-14T19:34:04.910Z","service":"stockly-api-test","level":"ERROR","traceId":"test-trace-id","userId":null,"path":"/test","message":"Failed to send provider failure notifications","type":"general","symbol":"AAPL","error":{"name":"TypeError","message":"env.stockly.prepare(...).all is not a function","stack":"TypeError: env.stockly.prepare(...).all is not a function\n    at notifyUsersOfProviderFailure (/home/sngvahmed/workspace/stockly/api/src/api/get-stock.ts:452:8)"}}

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > uses default interval (4h) when not provided
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-12-11 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-11 to 2025-12-14

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > uses default interval (4h) when not provided
[fetch30MinuteData] Received 0 30-minute candles

stdout | test/get-news.spec.ts > News API > getGeneralNews > should handle API errors gracefully
{"timestamp":"2025-12-14T19:34:04.918Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"General news cache hit","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}

stdout | test/logging/logger.spec.ts > Logger > log entry structure > should include all required fields
{"timestamp":"2025-12-14T19:34:04.922Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-123","userId":"user-456","path":"/v1/api/test","message":"Test message","type":"general"}

stderr | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > uses default interval (4h) when not provided
[getHistoricalIntraday] No 30-minute data available for AAPL

stderr | test/notifications/fcm-sender.spec.ts > FCM Sender > sendFCMNotification > should return false on failure
{"timestamp":"2025-12-14T19:34:04.924Z","service":"stockly-api-test","level":"ERROR","traceId":"test-trace-id","userId":null,"path":"/test","message":"FCM push notification failed","type":"fcm_error","fcmErrorCode":"3","fcmErrorType":"INVALID_ARGUMENT","isPermanent":true,"shouldCleanupToken":true,"requestPayload":{"token":"dXXXXXXXXXXXXXXXXXXXXXXXXXXXXX...","title":"Title","body":"Body","dataKeys":[]},"errorMessage":"Invalid token"}

stdout | test/get-stock.spec.ts > getStock handler > falls back to DB when provider returns invalid data
{"timestamp":"2025-12-14T19:34:04.926Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for TSLA","type":"general","cacheStatus":"MISS"}

stdout | test/get-stock.spec.ts > getStock handler > falls back to DB when provider returns invalid data
{"timestamp":"2025-12-14T19:34:04.926Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /quote","type":"api_call","apiProvider":"FMP","endpoint":"/quote","method":"GET","latencyMs":0}

 ✓ test/logging/kv-wrapper.spec.ts (26 tests) 1346ms
stderr | test/get-stock.spec.ts > getStock handler > falls back to DB when provider returns invalid data
{"timestamp":"2025-12-14T19:34:04.926Z","service":"stockly-api-test","level":"WARN","traceId":"test-trace-id","userId":null,"path":"/test","message":"Provider API returned invalid data for TSLA","type":"general","apiProvider":"FMP"}

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > uses default days (3) when not provided
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-12-11 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-11 to 2025-12-14

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > uses default days (3) when not provided
[fetch30MinuteData] Received 0 30-minute candles

 ❯ test/devices.spec.ts (9 tests | 7 failed) 476ms
   × Devices API > getAllDevices > should return list of devices 25ms
     → expected "spy" to be called with arguments: [ StringContaining{…} ]

Received: 

  1st spy call:

  [
-   StringContaining "SELECT user_id, push_token, device_info",
+   "SELECT 
+                upt.user_id, 
+                upt.push_token, 
+                upt.device_info,
+                upt.device_type,
+                upt.created_at, 
+                upt.updated_at,
+                u.username
+              FROM user_push_tokens upt
+              LEFT JOIN users u ON upt.user_id = u.id
+              ORDER BY upt.updated_at DESC",
  ]

  2nd spy call:

  [
-   StringContaining "SELECT user_id, push_token, device_info",
+   "SELECT COUNT(*) as count FROM alerts WHERE target = ?",
  ]

  3rd spy call:

  [
-   StringContaining "SELECT user_id, push_token, device_info",
+   "SELECT COUNT(*) as count FROM alerts WHERE target = ?",
  ]

  4th spy call:

  [
-   StringContaining "SELECT user_id, push_token, device_info",
+   "SELECT COUNT(*) as count FROM alerts WHERE target = ? AND status = 'active'",
  ]

  5th spy call:

  [
-   StringContaining "SELECT user_id, push_token, device_info",
+   "SELECT COUNT(*) as count FROM alerts WHERE target = ? AND status = 'active'",
  ]


Number of calls: 5

   ✓ Devices API > getAllDevices > should return empty array when no devices 58ms
   ✓ Devices API > getAllDevices > should handle database errors 41ms
   × Devices API > sendTestNotification > should send test notification successfully 12ms
     → Cannot read properties of undefined (reading 'get')
   × Devices API > sendTestNotification > should use default message when no custom message provided 7ms
     → Cannot read properties of undefined (reading 'get')
   × Devices API > sendTestNotification > should return 404 when device not found 26ms
     → Cannot read properties of undefined (reading 'get')
   × Devices API > sendTestNotification > should return 400 when userId is missing 12ms
     → expected 405 to be 400 // Object.is equality
   × Devices API > sendTestNotification > should return 405 for non-POST methods 7ms
     → Cannot read properties of undefined (reading 'get')
   × Devices API > sendTestNotification > should handle FCM send failures 8ms
     → Cannot read properties of undefined (reading 'get')
stdout | test/logging/logger.spec.ts > Logger > log entry structure > should handle null userId
{"timestamp":"2025-12-14T19:34:04.939Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-123","userId":null,"path":"/v1/api/test","message":"Test","type":"general"}

stderr | test/get-stock.spec.ts > getStock handler > falls back to DB when provider returns invalid data
{"timestamp":"2025-12-14T19:34:04.940Z","service":"stockly-api-test","level":"ERROR","traceId":"test-trace-id","userId":null,"path":"/test","message":"Failed to send provider failure notifications","type":"general","symbol":"TSLA","error":{"name":"TypeError","message":"env.stockly.prepare(...).all is not a function","stack":"TypeError: env.stockly.prepare(...).all is not a function\n    at notifyUsersOfProviderFailure (/home/sngvahmed/workspace/stockly/api/src/api/get-stock.ts:452:8)"}}

stderr | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > uses default days (3) when not provided
[getHistoricalIntraday] No 30-minute data available for AAPL

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Edge Cases > should handle no users with favorite symbols
{"timestamp":"2025-12-14T19:34:04.940Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844940","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

 ✓ test/cron/alerts-cron.spec.ts (15 tests) 872ms
stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Edge Cases > should handle no users with favorite symbols
{"timestamp":"2025-12-14T19:34:04.940Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844940","userId":null,"path":"/cron/news-alerts","message":"No favorite symbols found to check for news","type":"general"}

stdout | test/integration/stock-flow.spec.ts > Stock Data Flow Integration > Caching Flow > should cache stock data and serve from cache on subsequent requests
{"timestamp":"2025-12-14T19:34:04.952Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > normalizes symbol to uppercase
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-12-11 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-11 to 2025-12-14

stdout | test/integration/stock-flow.spec.ts > Stock Data Flow Integration > Caching Flow > should cache stock data and serve from cache on subsequent requests
{"timestamp":"2025-12-14T19:34:04.953Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > normalizes symbol to uppercase
[fetch30MinuteData] Received 0 30-minute candles

stderr | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > normalizes symbol to uppercase
[getHistoricalIntraday] No 30-minute data available for AAPL

stdout | test/logging/logger.spec.ts > Logger > log entry structure > should handle undefined userId
{"timestamp":"2025-12-14T19:34:04.960Z","service":"test","level":"INFO","traceId":"test","userId":null,"path":"/test","message":"Test","type":"general"}

stderr | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Edge Cases > should handle missing alertsKv gracefully
{"timestamp":"2025-12-14T19:34:04.966Z","service":"stockly-api","level":"WARN","traceId":"cron-news-1765740844966","userId":null,"path":"/cron/news-alerts","message":"Alerts KV is not configured; skipping news alert cron","type":"general"}

stdout | test/get-stock.spec.ts > getStock handler > falls back to DB when provider network request fails
{"timestamp":"2025-12-14T19:34:04.968Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for MSFT","type":"general","cacheStatus":"MISS"}

stderr | test/get-stock.spec.ts > getStock handler > falls back to DB when provider network request fails
{"timestamp":"2025-12-14T19:34:04.968Z","service":"stockly-api-test","level":"ERROR","traceId":"test-trace-id","userId":null,"path":"/test","message":"ERROR in getStock","type":"general","symbol":"MSFT","error":{"name":"Error","message":"Failed to fetch","stack":"Error: Failed to fetch\n    at /home/sngvahmed/workspace/stockly/api/test/get-stock.spec.ts:477:7\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:155:11\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:26\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1897:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1863:10)\n    at runTest (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1574:12)\n    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)\n    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)\n    at runFiles (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1787:3)"}}
{"timestamp":"2025-12-14T19:34:04.968Z","service":"stockly-api-test","level":"WARN","traceId":"test-trace-id","userId":null,"path":"/test","message":"Provider fetch error for MSFT","type":"general","error":"Failed to fetch","apiProvider":"FMP"}

stderr | test/get-stock.spec.ts > getStock handler > falls back to DB when provider network request fails
{"timestamp":"2025-12-14T19:34:04.979Z","service":"stockly-api-test","level":"ERROR","traceId":"test-trace-id","userId":null,"path":"/test","message":"Failed to send provider failure notifications","type":"general","symbol":"MSFT","error":{"name":"TypeError","message":"env.stockly.prepare(...).all is not a function","stack":"TypeError: env.stockly.prepare(...).all is not a function\n    at notifyUsersOfProviderFailure (/home/sngvahmed/workspace/stockly/api/src/api/get-stock.ts:452:8)"}}

stderr | test/api/admin.spec.ts > Admin API > getFailedNotifications > should handle database errors
Failed to retrieve failed notifications: Error: Database error
    at /home/sngvahmed/workspace/stockly/api/test/api/admin.spec.ts:221:40
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:155:11
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:26
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1863:10)
    at runTest (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1574:12)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)

 ✓ test/notifications/fcm-sender.spec.ts (13 tests) 792ms
stdout | test/api-schema-validation.spec.ts > API Schema Validation - Get Stock > getStock returns valid StockQuoteResponse schema on success
{"timestamp":"2025-12-14T19:34:04.987Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for AAPL","type":"general","cacheStatus":"MISS"}

stdout | test/api-integration.spec.ts > API Integration - Get Stock > successfully fetches and returns stock data with all required fields
{"timestamp":"2025-12-14T19:34:04.987Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for AAPL","type":"general","cacheStatus":"MISS"}

stdout | test/api-schema-validation.spec.ts > API Schema Validation - Get Stock > getStock returns valid StockQuoteResponse schema on success
{"timestamp":"2025-12-14T19:34:04.989Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /quote","type":"api_call","apiProvider":"FMP","endpoint":"/quote","method":"GET","latencyMs":1}

stdout | test/api-integration.spec.ts > API Integration - Get Stock > successfully fetches and returns stock data with all required fields
{"timestamp":"2025-12-14T19:34:04.989Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /quote","type":"api_call","apiProvider":"FMP","endpoint":"/quote","method":"GET","latencyMs":1}

stdout | test/api-schema-validation.spec.ts > API Schema Validation - Get Stock > getStock returns valid StockQuoteResponse schema on success
{"timestamp":"2025-12-14T19:34:04.989Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","latencyMs":0}

stdout | test/api-integration.spec.ts > API Integration - Get Stock > successfully fetches and returns stock data with all required fields
{"timestamp":"2025-12-14T19:34:04.989Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","latencyMs":0}

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Date range calculation > calculates correct date range based on days parameter
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-12-09 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-09 to 2025-12-14

stdout | test/api-schema-validation.spec.ts > API Schema Validation - Get Stock > getStock returns valid StockQuoteResponse schema on success
{"timestamp":"2025-12-14T19:34:04.989Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API response","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile?symbol=AAPL&apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","responseType":"array","responseLength":1}
{"timestamp":"2025-12-14T19:34:04.989Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Found description from profile","type":"general","descriptionLength":38}
{"timestamp":"2025-12-14T19:34:04.989Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Final description resolved","type":"general","hasDescription":true,"descriptionLength":38,"source":"profile"}

stdout | test/api-integration.spec.ts > API Integration - Get Stock > successfully fetches and returns stock data with all required fields
{"timestamp":"2025-12-14T19:34:04.989Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API response","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile?symbol=AAPL&apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","responseType":"array","responseLength":1}
{"timestamp":"2025-12-14T19:34:04.989Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Found description from profile","type":"general","descriptionLength":38}
{"timestamp":"2025-12-14T19:34:04.989Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Final description resolved","type":"general","hasDescription":true,"descriptionLength":38,"source":"profile"}

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Date range calculation > calculates correct date range based on days parameter
[fetch30MinuteData] Received 10 30-minute candles

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle the complete use case: 3 PM check with multiple users and symbols
{"timestamp":"2025-12-14T19:34:04.997Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844997","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Date range calculation > calculates correct date range based on days parameter
[getHistoricalIntraday] Aggregated 10 30-min candles into 2 4h candles

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle the complete use case: 3 PM check with multiple users and symbols
{"timestamp":"2025-12-14T19:34:04.998Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844997","userId":null,"path":"/cron/news-alerts","message":"Checking news for 4 unique symbols: LXEO, AMZN, AAPL, BABA","type":"general"}
{"timestamp":"2025-12-14T19:34:04.998Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844997","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle the complete use case: 3 PM check with multiple users and symbols
{"timestamp":"2025-12-14T19:34:04.998Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844997","userId":null,"path":"/cron/news-alerts","message":"Fetched 2 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:34:04.998Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844997","userId":null,"path":"/cron/news-alerts","message":"Found news for 2 symbols: LXEO, AMZN","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle the complete use case: 3 PM check with multiple users and symbols
{"timestamp":"2025-12-14T19:34:04.998Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844997","userId":null,"path":"/cron/news-alerts","message":"New article found (published today)","type":"general","symbol":"LXEO","title":"LXEO News Today","publishedDate":"2025-12-14T10:00:00Z"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle the complete use case: 3 PM check with multiple users and symbols
{"timestamp":"2025-12-14T19:34:04.998Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844997","userId":null,"path":"/cron/news-alerts","message":"Found 2 users with LXEO in favorites: user1, user3","type":"general"}

 ✓ test/integration/stock-flow.spec.ts (3 tests) 172ms
stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle the complete use case: 3 PM check with multiple users and symbols
{"timestamp":"2025-12-14T19:34:04.998Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844997","userId":null,"path":"/cron/news-alerts","message":"Sent 3 notifications for LXEO news to 2 users","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle the complete use case: 3 PM check with multiple users and symbols
{"timestamp":"2025-12-14T19:34:04.998Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844997","userId":null,"path":"/cron/news-alerts","message":"New article found (published today)","type":"general","symbol":"AMZN","title":"AMZN News Today","publishedDate":"2025-12-14T11:00:00Z"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle the complete use case: 3 PM check with multiple users and symbols
{"timestamp":"2025-12-14T19:34:04.998Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844997","userId":null,"path":"/cron/news-alerts","message":"Found 2 users with AMZN in favorites: user1, user2","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle the complete use case: 3 PM check with multiple users and symbols
{"timestamp":"2025-12-14T19:34:04.998Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844997","userId":null,"path":"/cron/news-alerts","message":"Sent 3 notifications for AMZN news to 2 users","type":"general"}
{"timestamp":"2025-12-14T19:34:04.998Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740844997","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle 7 PM check: no duplicate notifications for same articles
{"timestamp":"2025-12-14T19:34:05.015Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740845015","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

 ✓ test/get-stock.spec.ts (10 tests) 510ms
stderr | test/get-historical.spec.ts > getHistorical handler > Parameter validation > accepts symbol parameter
{"timestamp":"2025-12-14T19:34:05.022Z","service":"stockly-api-test","level":"WARN","traceId":"test-trace-id","userId":null,"path":"/test","message":"Still no data after fetching from FMP API for AAPL","type":"general","dateRange":"2025-06-17 to 2025-12-14","possibleReasons":["FMP API returned empty data","FMP API returned data outside the requested date range","Date range is in the future or has no trading days","Database schema missing OHLC columns (check migration 009)"]}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle 7 PM check: no duplicate notifications for same articles
{"timestamp":"2025-12-14T19:34:05.015Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740845015","userId":null,"path":"/cron/news-alerts","message":"Checking news for 1 unique symbols: LXEO","type":"general"}
{"timestamp":"2025-12-14T19:34:05.015Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740845015","userId":null,"path":"/cron/news-alerts","message":"Fetching news for all symbols published today (2025-12-14)","type":"general"}

stdout | test/get-historical.spec.ts > getHistorical handler > Parameter validation > accepts symbol parameter
{"timestamp":"2025-12-14T19:34:05.022Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-06-17 to 2025-12-14","recordCount":0}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle 7 PM check: no duplicate notifications for same articles
{"timestamp":"2025-12-14T19:34:05.015Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740845015","userId":null,"path":"/cron/news-alerts","message":"Fetched 1 news articles published today","type":"general"}
{"timestamp":"2025-12-14T19:34:05.015Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740845015","userId":null,"path":"/cron/news-alerts","message":"Found news for 1 symbols: LXEO","type":"general"}

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > FMP API integration > calls FMP API with correct parameters
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-12-11 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-11 to 2025-12-14

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle 7 PM check: no duplicate notifications for same articles
{"timestamp":"2025-12-14T19:34:05.015Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740845015","userId":null,"path":"/cron/news-alerts","message":"New article found (published today)","type":"general","symbol":"LXEO","title":"LXEO News Today","publishedDate":"2025-12-14T10:00:00Z"}

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > FMP API integration > calls FMP API with correct parameters
[fetch30MinuteData] Received 10 30-minute candles

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle 7 PM check: no duplicate notifications for same articles
{"timestamp":"2025-12-14T19:34:05.015Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740845015","userId":null,"path":"/cron/news-alerts","message":"Found 1 users with LXEO in favorites: user1","type":"general"}

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > FMP API integration > calls FMP API with correct parameters
[getHistoricalIntraday] Aggregated 10 30-min candles into 2 4h candles

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle 7 PM check: no duplicate notifications for same articles
{"timestamp":"2025-12-14T19:34:05.015Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740845015","userId":null,"path":"/cron/news-alerts","message":"Sent 1 notifications for LXEO news to 1 users","type":"general"}
{"timestamp":"2025-12-14T19:34:05.015Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740845015","userId":null,"path":"/cron/news-alerts","message":"News alert cron job completed","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle 7 PM check: no duplicate notifications for same articles
{"timestamp":"2025-12-14T19:34:05.016Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740845016","userId":null,"path":"/cron/news-alerts","message":"Starting news alert cron job","type":"general"}

stderr | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle 7 PM check: no duplicate notifications for same articles
{"timestamp":"2025-12-14T19:34:05.016Z","service":"stockly-api","level":"WARN","traceId":"cron-news-1765740845016","userId":"user1","path":"/cron/news-alerts","message":"Failed to parse news_favorite_symbols","type":"general"}

stdout | test/cron/news-alert-cron.spec.ts > News Alert Cron Job > Complete Use Case Flow > should handle 7 PM check: no duplicate notifications for same articles
{"timestamp":"2025-12-14T19:34:05.016Z","service":"stockly-api","level":"INFO","traceId":"cron-news-1765740845016","userId":null,"path":"/cron/news-alerts","message":"No favorite symbols found to check for news","type":"general"}

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > FMP API integration > handles FMP API errors gracefully
[getHistoricalIntraday] Fetching 4h data for INVALID (2025-12-11 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for INVALID from 2025-12-11 to 2025-12-14

stdout | test/get-historical.spec.ts > getHistorical handler > Parameter validation > normalizes symbol to uppercase
[get-historical] Query result for AAPL (2025-06-17 to 2025-12-14): 0 records found in database
{"timestamp":"2025-12-14T19:34:05.044Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No historical data in database for AAPL","type":"general","dateRange":"2025-06-17 to 2025-12-14","action":"fetching from FMP API"}

stderr | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > FMP API integration > handles FMP API errors gracefully
[fetch30MinuteData] FMP API error: Invalid symbol

stderr | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > FMP API integration > handles FMP API errors gracefully
[getHistoricalIntraday] Error: FMP API error: Invalid symbol Error: FMP API error: Invalid symbol
    at fetch30MinuteData (/home/sngvahmed/workspace/stockly/api/src/api/get-historical-intraday.ts:182:19)
    at getHistoricalIntraday (/home/sngvahmed/workspace/stockly/api/src/api/get-historical-intraday.ts:252:31)
    at /home/sngvahmed/workspace/stockly/api/test/api/get-historical-intraday.spec.ts:261:24
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > FMP API integration > handles HTTP errors from FMP API
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-12-11 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-11 to 2025-12-14

stderr | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > FMP API integration > handles HTTP errors from FMP API
[fetch30MinuteData] HTTP 500: Internal Server Error

stderr | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > FMP API integration > handles HTTP errors from FMP API
[getHistoricalIntraday] Error: Failed to fetch 30-minute data: HTTP 500 Error: Failed to fetch 30-minute data: HTTP 500
    at fetch30MinuteData (/home/sngvahmed/workspace/stockly/api/src/api/get-historical-intraday.ts:171:15)
    at getHistoricalIntraday (/home/sngvahmed/workspace/stockly/api/src/api/get-historical-intraday.ts:252:31)
    at /home/sngvahmed/workspace/stockly/api/test/api/get-historical-intraday.spec.ts:280:24
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20

 ✓ test/cron/news-alert-cron.spec.ts (18 tests) 1297ms
stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > FMP API integration > handles empty data response
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-12-11 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-11 to 2025-12-14

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > FMP API integration > handles empty data response
[fetch30MinuteData] Received 0 30-minute candles

stderr | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > FMP API integration > handles empty data response
[getHistoricalIntraday] No 30-minute data available for AAPL

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > FMP API integration > filters out invalid records from API response
[getHistoricalIntraday] Fetching 1h data for AAPL (2025-12-11 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-11 to 2025-12-14

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > FMP API integration > filters out invalid records from API response
[fetch30MinuteData] Received 4 30-minute candles

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > FMP API integration > filters out invalid records from API response
[getHistoricalIntraday] Aggregated 2 30-min candles into 2 1h candles

 ❯ test/get-news.spec.ts (7 tests | 6 failed) 235ms
   ✓ News API > getGeneralNews > should return general news from FMP API 26ms
   × News API > getGeneralNews > should handle API errors gracefully 14ms
     → expected [ { title: 'Apple News', …(7) } ] to deeply equal []
   × News API > getFavoriteNews > should return news for favorite symbols 9ms
     → expected 401 to be 200 // Object.is equality
   × News API > getFavoriteNews > should return empty list if no favorites 5ms
     → expected 401 to be 200 // Object.is equality
   × News API > News Archive > should toggle archived news 6ms
     → expected 401 to be 200 // Object.is equality
   × News API > News Archive > should retrieve archived news 4ms
     → expected 401 to be 200 // Object.is equality
   × News API > User Preferences > should update news favorite symbols 7ms
     → (0 , updatePreferences) is not a function
stdout | test/api-schema-validation.spec.ts > API Schema Validation - Get Historical > getHistorical returns valid HistoricalPricesResponse schema
[getHistoricalPricesByDateRange] Querying database for AAPL from 2025-06-17 to 2025-12-14

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > OHLC aggregation > aggregates 30-minute data to 1-hour intervals
[getHistoricalIntraday] Fetching 1h data for AAPL (2025-12-13 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-13 to 2025-12-14

stdout | test/api-schema-validation.spec.ts > API Schema Validation - Get Historical > getHistorical returns valid HistoricalPricesResponse schema
[getHistoricalPricesByDateRange] Found 2 records for AAPL in date range 2025-06-17 to 2025-12-14

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > OHLC aggregation > aggregates 30-minute data to 1-hour intervals
[fetch30MinuteData] Received 4 30-minute candles

stdout | test/api-schema-validation.spec.ts > API Schema Validation - Get Historical > getHistorical returns valid HistoricalPricesResponse schema
[get-historical] Query result for AAPL (2025-06-17 to 2025-12-14): 2 records found in database
{"timestamp":"2025-12-14T19:34:05.112Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No historical data in database for AAPL","type":"general","dateRange":"2025-06-17 to 2025-12-14","action":"fetching from FMP API"}
[fetchAndSaveHistoricalPrice] Starting fetch for AAPL from FMP API
[fetchAndSaveHistoricalPrice] Fetching from: https://financialmodelingprep.com/stable/historical-chart/30min?symbol=AAPL&apikey=***&from=2025-06-17&to=2025-12-14

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > OHLC aggregation > aggregates 30-minute data to 1-hour intervals
[getHistoricalIntraday] Aggregated 4 30-min candles into 3 1h candles

stderr | test/api-schema-validation.spec.ts > API Schema Validation - Get Historical > getHistorical returns valid HistoricalPricesResponse schema
{"timestamp":"2025-12-14T19:34:05.112Z","service":"stockly-api-test","level":"WARN","traceId":"test-trace-id","userId":null,"path":"/test","message":"Found 2 records with missing OHLC data","type":"general","symbol":"AAPL","recordsWithMissingOHLC":2,"totalRecords":2}

 ✓ test/logging/logger.spec.ts (31 tests) 1586ms
stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > OHLC aggregation > aggregates 30-minute data to 4-hour intervals
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-12-13 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-13 to 2025-12-14

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > OHLC aggregation > aggregates 30-minute data to 4-hour intervals
[fetch30MinuteData] Received 8 30-minute candles

 ❯ test/api/admin.spec.ts (14 tests | 12 failed) 400ms
   × Admin API > getRecentNotifications > should return recent notifications 16ms
     → expected 400 to be 200 // Object.is equality
   × Admin API > getRecentNotifications > should return empty array when no notifications 8ms
     → expected 400 to be 200 // Object.is equality
   × Admin API > getRecentNotifications > should handle database errors 15ms
     → expected 400 to be 500 // Object.is equality
   × Admin API > getRecentNotifications > should limit to 100 notifications 8ms
     → Cannot read properties of undefined (reading 'get')
   × Admin API > getRecentNotifications > should order by sent_at DESC 5ms
     → Cannot read properties of undefined (reading 'get')
   × Admin API > getFailedNotifications > should return only failed notifications 7ms
     → expected "spy" to be called with arguments: [ StringContaining{…} ]

Received: 

  1st spy call:

  [
-   StringContaining "WHERE status IN ('failed', 'error')",
+   "SELECT 
+            nl.id, 
+            nl.alert_id, 
+            nl.symbol, 
+            nl.threshold, 
+            nl.price, 
+            nl.direction, 
+            nl.push_token, 
+            nl.status, 
+            nl.error_message, 
+            nl.attempt_count, 
+            nl.sent_at,
+            nl.username
+          FROM notifications_log nl
+          WHERE nl.status IN ('failed', 'error')
+          ORDER BY nl.sent_at DESC
+          LIMIT 100",
  ]


Number of calls: 1

   ✓ Admin API > getFailedNotifications > should return empty array when no failed notifications 20ms
   ✓ Admin API > getFailedNotifications > should handle database errors 18ms
   × Admin API > retryNotification > should retry failed notification successfully 7ms
     → expected 400 to be 200 // Object.is equality
   × Admin API > retryNotification > should return 404 when log not found 5ms
     → Cannot read properties of undefined (reading 'get')
   × Admin API > retryNotification > should handle retry failure 9ms
     → expected 400 to be 200 // Object.is equality
   × Admin API > retryNotification > should create new log entry with attempt count 1 7ms
     → expected "spy" to be called with arguments: [ StringContaining "retry", …(10) ]

Number of calls: 0

   × Admin API > retryNotification > should handle database errors during retry 4ms
     → expected 400 to be 500 // Object.is equality
   × Admin API > retryNotification > should handle FCM send errors 3ms
     → expected 400 to be 200 // Object.is equality
stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > OHLC aggregation > aggregates 30-minute data to 4-hour intervals
[getHistoricalIntraday] Aggregated 8 30-min candles into 2 4h candles

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > OHLC aggregation > correctly calculates OHLC values during aggregation
[getHistoricalIntraday] Fetching 1h data for AAPL (2025-12-13 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-13 to 2025-12-14

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > OHLC aggregation > correctly calculates OHLC values during aggregation
[fetch30MinuteData] Received 4 30-minute candles

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > OHLC aggregation > correctly calculates OHLC values during aggregation
[getHistoricalIntraday] Aggregated 4 30-min candles into 2 1h candles

stdout | test/api-integration.spec.ts > API Integration - Get Historical > successfully fetches historical price data
[getHistoricalPricesByDateRange] Querying database for AAPL from 2025-06-17 to 2025-12-14

stdout | test/api-integration.spec.ts > API Integration - Get Historical > successfully fetches historical price data
[getHistoricalPricesByDateRange] Found 3 records for AAPL in date range 2025-06-17 to 2025-12-14

stdout | test/api-comprehensive.spec.ts > API - Get Single Stock > GET /v1/api/get-stock returns stock data with all required fields
{"timestamp":"2025-12-14T19:34:05.142Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for AAPL","type":"general","cacheStatus":"MISS"}

stderr | test/api-integration.spec.ts > API Integration - Get Historical > successfully fetches historical price data
{"timestamp":"2025-12-14T19:34:05.143Z","service":"stockly-api-test","level":"WARN","traceId":"test-trace-id","userId":null,"path":"/test","message":"Found 3 records with missing OHLC data","type":"general","symbol":"AAPL","recordsWithMissingOHLC":3,"totalRecords":3}

stdout | test/api-comprehensive.spec.ts > API - Get Single Stock > GET /v1/api/get-stock returns stock data with all required fields
{"timestamp":"2025-12-14T19:34:05.144Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /quote","type":"api_call","apiProvider":"FMP","endpoint":"/quote","method":"GET","latencyMs":1}

stdout | test/api-integration.spec.ts > API Integration - Get Historical > successfully fetches historical price data
[get-historical] Query result for AAPL (2025-06-17 to 2025-12-14): 3 records found in database
{"timestamp":"2025-12-14T19:34:05.143Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No historical data in database for AAPL","type":"general","dateRange":"2025-06-17 to 2025-12-14","action":"fetching from FMP API"}
[fetchAndSaveHistoricalPrice] Starting fetch for AAPL from FMP API
[fetchAndSaveHistoricalPrice] Fetching from: https://financialmodelingprep.com/stable/historical-chart/30min?symbol=AAPL&apikey=***&from=2025-06-17&to=2025-12-14

stderr | test/api-comprehensive.spec.ts > API - Get Single Stock > GET /v1/api/get-stock returns stock data with all required fields
{"timestamp":"2025-12-14T19:34:05.145Z","service":"stockly-api-test","level":"WARN","traceId":"test-trace-id","userId":null,"path":"/test","message":"Failed to fetch profile","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile?symbol=AAPL&apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","error":"profileRes.text is not a function"}

stdout | test/api-comprehensive.spec.ts > API - Get Single Stock > GET /v1/api/get-stock returns stock data with all required fields
{"timestamp":"2025-12-14T19:34:05.144Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","statusCode":404,"latencyMs":0}

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Response format > returns correct JSON structure on success
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-12-11 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-11 to 2025-12-14

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Response format > returns correct JSON structure on success
[fetch30MinuteData] Received 10 30-minute candles

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Response format > returns correct JSON structure on success
[getHistoricalIntraday] Aggregated 10 30-min candles into 2 4h candles

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Response format > returns correct structure on empty data
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-12-11 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-11 to 2025-12-14

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Response format > returns correct structure on empty data
[fetch30MinuteData] Received 0 30-minute candles

stderr | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Response format > returns correct structure on empty data
[getHistoricalIntraday] No 30-minute data available for AAPL

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Error handling > handles network errors
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-12-11 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-11 to 2025-12-14

stderr | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Error handling > handles network errors
[getHistoricalIntraday] Error: Network error Error: Network error
    at /home/sngvahmed/workspace/stockly/api/test/api/get-historical-intraday.spec.ts:503:9
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:155:11
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:26
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1863:10)
    at runTest (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1574:12)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)

stdout | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Error handling > handles invalid JSON response
[getHistoricalIntraday] Fetching 4h data for AAPL (2025-12-11 to 2025-12-14)
[fetch30MinuteData] Fetching 30-min data for AAPL from 2025-12-11 to 2025-12-14

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Invalid Input Handling > should handle invalid symbol format
{"timestamp":"2025-12-14T19:34:05.164Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /quote","type":"api_call","apiProvider":"FMP","endpoint":"/quote","method":"GET","statusCode":200,"latencyMs":384}

stderr | test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Error handling > handles invalid JSON response
[getHistoricalIntraday] Error: Unexpected token 'I', "Invalid JSON" is not valid JSON SyntaxError: Unexpected token 'I', "Invalid JSON" is not valid JSON
    at fetch30MinuteData (/home/sngvahmed/workspace/stockly/api/src/api/get-historical-intraday.ts:174:18)
    at getHistoricalIntraday (/home/sngvahmed/workspace/stockly/api/src/api/get-historical-intraday.ts:252:31)
    at /home/sngvahmed/workspace/stockly/api/test/api/get-historical-intraday.spec.ts:527:24
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20

 ❯ test/api/get-historical-intraday.spec.ts (19 tests | 2 failed) 846ms
   ✓ getHistoricalIntraday handler > Parameter validation > requires a symbol parameter 40ms
   ✓ getHistoricalIntraday handler > Parameter validation > validates days parameter - must be between 1 and 30 72ms
   × getHistoricalIntraday handler > Parameter validation > validates interval format 390ms
     → expected 500 to be 400 // Object.is equality
   ✓ getHistoricalIntraday handler > Parameter validation > uses default interval (4h) when not provided 22ms
   ✓ getHistoricalIntraday handler > Parameter validation > uses default days (3) when not provided 20ms
   ✓ getHistoricalIntraday handler > Parameter validation > normalizes symbol to uppercase 20ms
   ✓ getHistoricalIntraday handler > Date range calculation > calculates correct date range based on days parameter 21ms
   ✓ getHistoricalIntraday handler > FMP API integration > calls FMP API with correct parameters 16ms
   ✓ getHistoricalIntraday handler > FMP API integration > handles FMP API errors gracefully 13ms
   ✓ getHistoricalIntraday handler > FMP API integration > handles HTTP errors from FMP API 17ms
   ✓ getHistoricalIntraday handler > FMP API integration > handles empty data response 13ms
   ✓ getHistoricalIntraday handler > FMP API integration > filters out invalid records from API response 15ms
   ✓ getHistoricalIntraday handler > OHLC aggregation > aggregates 30-minute data to 1-hour intervals 13ms
   ✓ getHistoricalIntraday handler > OHLC aggregation > aggregates 30-minute data to 4-hour intervals 9ms
   × getHistoricalIntraday handler > OHLC aggregation > correctly calculates OHLC values during aggregation 3ms
     → candle is not defined
   ✓ getHistoricalIntraday handler > Response format > returns correct JSON structure on success 4ms
   ✓ getHistoricalIntraday handler > Response format > returns correct structure on empty data 5ms
   ✓ getHistoricalIntraday handler > Error handling > handles network errors 4ms
   ✓ getHistoricalIntraday handler > Error handling > handles invalid JSON response 6ms
 ✓ test/api/devices.spec.ts (25 tests) 396ms
stderr | test/index.spec.ts > worker router > returns 404 for unknown routes
{"timestamp":"2025-12-14T19:34:05.244Z","service":"stockly-api","level":"WARN","traceId":"8e496414-b5d4-4b33-a415-2d233699d5b8","userId":null,"path":"/v1/api/unknown","message":"Route not found","type":"general","pathname":"/v1/api/unknown","method":"GET"}

 ✓ test/index.spec.ts (6 tests) 25ms
stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Invalid Input Handling > should handle invalid symbol format
{"timestamp":"2025-12-14T19:34:05.264Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","statusCode":200,"latencyMs":100}

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Invalid Input Handling > should handle invalid symbol format
{"timestamp":"2025-12-14T19:34:05.265Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API response","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile?symbol=!!!&apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","responseType":"array","responseLength":0}
{"timestamp":"2025-12-14T19:34:05.265Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API returned empty array","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile?symbol=!!!&apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM"}

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Invalid Input Handling > should handle invalid symbol format
{"timestamp":"2025-12-14T19:34:05.360Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","statusCode":404,"latencyMs":95}

stderr | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Invalid Input Handling > should handle invalid symbol format
{"timestamp":"2025-12-14T19:34:05.361Z","service":"stockly-api-test","level":"WARN","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API returned non-ok status","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile/!!!?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","statusCode":404,"errorText":"[]"}

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Invalid Input Handling > should handle invalid symbol format
{"timestamp":"2025-12-14T19:34:05.459Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","statusCode":404,"latencyMs":98}

stderr | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Invalid Input Handling > should handle invalid symbol format
{"timestamp":"2025-12-14T19:34:05.460Z","service":"stockly-api-test","level":"WARN","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API returned non-ok status","type":"general","endpoint":"https://financialmodelingprep.com/stable/company/profile/!!!?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","statusCode":404,"errorText":"[]"}

stderr | test/get-historical.spec.ts > getHistorical handler > Parameter validation > normalizes symbol to uppercase
{"timestamp":"2025-12-14T19:34:05.545Z","service":"stockly-api-test","level":"WARN","traceId":"test-trace-id","userId":null,"path":"/test","message":"Still no data after fetching from FMP API for AAPL","type":"general","dateRange":"2025-06-17 to 2025-12-14","possibleReasons":["FMP API returned empty data","FMP API returned data outside the requested date range","Date range is in the future or has no trading days","Database schema missing OHLC columns (check migration 009)"]}

stdout | test/get-historical.spec.ts > getHistorical handler > Parameter validation > normalizes symbol to uppercase
{"timestamp":"2025-12-14T19:34:05.545Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-06-17 to 2025-12-14","recordCount":0}

stdout | test/get-historical.spec.ts > getHistorical handler > Date range parameters (from/to) > accepts from and to parameters
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-31): 3 records found in database

stdout | test/get-historical.spec.ts > getHistorical handler > Date range parameters (from/to) > allows from and to to be the same date
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-01): 1 records found in database

stdout | test/get-historical.spec.ts > getHistorical handler > Date range parameters (from/to) > defaults to today when only 'to' is provided
[get-historical] Query result for AAPL (2024-08-03 to 2025-01-31): 0 records found in database
{"timestamp":"2025-12-14T19:34:05.563Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No historical data in database for AAPL","type":"general","dateRange":"2024-08-03 to 2025-01-31","action":"fetching from FMP API"}

stdout | test/api-comprehensive.spec.ts > API - Get Single Stock > GET /v1/api/get-stock returns stock data with all required fields
{"timestamp":"2025-12-14T19:34:05.565Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","statusCode":404,"latencyMs":420}

stderr | test/api-comprehensive.spec.ts > API - Get Single Stock > GET /v1/api/get-stock returns stock data with all required fields
{"timestamp":"2025-12-14T19:34:05.566Z","service":"stockly-api-test","level":"WARN","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API returned non-ok status","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","statusCode":404,"errorText":"[]"}

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Invalid Input Handling > should handle invalid symbol format
{"timestamp":"2025-12-14T19:34:05.570Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","statusCode":403,"latencyMs":110}

stderr | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Invalid Input Handling > should handle invalid symbol format
{"timestamp":"2025-12-14T19:34:05.570Z","service":"stockly-api-test","level":"WARN","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API returned non-ok status","type":"general","endpoint":"https://financialmodelingprep.com/api/v3/profile/!!!?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","statusCode":403,"errorText":"{\n  \"Error Message\": \"Legacy Endpoint : Due to Legacy endpoints being no longer supported - This endpoint is only available for legacy users who have valid subscriptions prior August 31, 2025. Please "}

stdout | test/api-comprehensive.spec.ts > API - Get Single Stock > GET /v1/api/get-stock returns stock data with all required fields
{"timestamp":"2025-12-14T19:34:05.676Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","statusCode":404,"latencyMs":110}

stderr | test/api-comprehensive.spec.ts > API - Get Single Stock > GET /v1/api/get-stock returns stock data with all required fields
{"timestamp":"2025-12-14T19:34:05.677Z","service":"stockly-api-test","level":"WARN","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API returned non-ok status","type":"general","endpoint":"https://financialmodelingprep.com/stable/company/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","statusCode":404,"errorText":"[]"}

stdout | test/api-schema-validation.spec.ts > API Schema Validation - Get Historical > getHistorical returns valid HistoricalPricesResponse schema
[fetchAndSaveHistoricalPrice] Received 241 1-hour OHLC records from FMP API
[fetchAndSaveHistoricalPrice] FMP API returned 241 records for AAPL
[fetchAndSaveHistoricalPrice] Sample record structure: {
  date: '2025-12-12 15:30:00',
  hasOpen: true,
  hasHigh: true,
  hasLow: true,
  hasClose: true,
  hasPrice: false,
  keys: [ 'date', 'open', 'low', 'high', 'close', 'volume' ]
}
Saved 19 daily candles (aggregated from 241 1-hour records) for AAPL with OHLC data

stderr | test/api-schema-validation.spec.ts > API Schema Validation - Get Historical > getHistorical returns valid HistoricalPricesResponse schema
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-11-17, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-11-17: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-11-18, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-11-18: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-11-19, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-11-19: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-11-20, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-11-20: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-11-21, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-11-21: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-11-24, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-11-24: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-11-25, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-11-25: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-11-26, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-11-26: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-11-28, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-11-28: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-12-01, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-12-01: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-12-02, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-12-02: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-12-03, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-12-03: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-12-04, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-12-04: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-12-05, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-12-05: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-12-08, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-12-08: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-12-09, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-12-09: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-12-10, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-12-10: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-12-11, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-12-11: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-12-12, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-12-12: env.stockly.prepare(...).bind(...).run is not a function

stdout | test/api-integration.spec.ts > API Integration - Get Historical > successfully fetches historical price data
[fetchAndSaveHistoricalPrice] Received 241 1-hour OHLC records from FMP API
[fetchAndSaveHistoricalPrice] FMP API returned 241 records for AAPL
[fetchAndSaveHistoricalPrice] Sample record structure: {
  date: '2025-12-12 15:30:00',
  hasOpen: true,
  hasHigh: true,
  hasLow: true,
  hasClose: true,
  hasPrice: false,
  keys: [ 'date', 'open', 'low', 'high', 'close', 'volume' ]
}
Saved 19 daily candles (aggregated from 241 1-hour records) for AAPL with OHLC data

stderr | test/api-integration.spec.ts > API Integration - Get Historical > successfully fetches historical price data
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-11-17, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-11-17: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-11-18, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-11-18: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-11-19, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-11-19: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-11-20, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-11-20: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-11-21, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-11-21: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-11-24, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-11-24: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-11-25, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-11-25: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-11-26, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-11-26: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-11-28, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-11-28: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-12-01, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-12-01: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-12-02, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-12-02: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-12-03, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-12-03: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-12-04, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-12-04: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-12-05, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-12-05: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-12-08, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-12-08: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-12-09, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-12-09: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-12-10, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-12-10: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-12-11, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-12-11: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Insert with OHLC failed for AAPL on 2025-12-12, trying fallback without OHLC: env.stockly.prepare(...).bind(...).run is not a function
[fetchAndSaveHistoricalPrice] Failed to insert historical record for AAPL on 2025-12-12: env.stockly.prepare(...).bind(...).run is not a function

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Invalid Input Handling > should handle invalid symbol format
{"timestamp":"2025-12-14T19:34:05.787Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Final description resolved","type":"general","hasDescription":false,"descriptionLength":0,"source":"none"}

stderr | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Invalid Input Handling > should handle invalid symbol format
{"timestamp":"2025-12-14T19:34:05.788Z","service":"stockly-api-test","level":"ERROR","traceId":"test-trace-id","userId":null,"path":"/test","message":"ERROR in getStock","type":"general","symbol":"!!!","error":{"name":"TypeError","message":"Cannot read properties of undefined (reading 'bind')","stack":"TypeError: Cannot read properties of undefined (reading 'bind')\n    at Module.getStock (/home/sngvahmed/workspace/stockly/api/src/api/get-stock.ts:309:7)\n    at /home/sngvahmed/workspace/stockly/api/test/api/edge-cases.spec.ts:42:24\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20"}}
{"timestamp":"2025-12-14T19:34:05.791Z","service":"stockly-api-test","level":"ERROR","traceId":"test-trace-id","userId":null,"path":"/test","message":"Failed to fetch from DB during provider failure","type":"general","error":{"name":"TypeError","message":"Cannot read properties of undefined (reading 'bind')","stack":"TypeError: Cannot read properties of undefined (reading 'bind')\n    at handleProviderFailure (/home/sngvahmed/workspace/stockly/api/src/api/get-stock.ts:373:7)\n    at Module.getStock (/home/sngvahmed/workspace/stockly/api/src/api/get-stock.ts:345:20)\n    at /home/sngvahmed/workspace/stockly/api/test/api/edge-cases.spec.ts:42:24\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20"}}

stdout | test/api-comprehensive.spec.ts > API - Get Single Stock > GET /v1/api/get-stock returns stock data with all required fields
{"timestamp":"2025-12-14T19:34:05.812Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","statusCode":403,"latencyMs":135}

stdout | test/api-comprehensive.spec.ts > API - Get Single Stock > GET /v1/api/get-stock returns stock data with all required fields
{"timestamp":"2025-12-14T19:34:05.813Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Final description resolved","type":"general","hasDescription":true,"descriptionLength":38,"source":"quote"}

stderr | test/api-comprehensive.spec.ts > API - Get Single Stock > GET /v1/api/get-stock returns stock data with all required fields
{"timestamp":"2025-12-14T19:34:05.812Z","service":"stockly-api-test","level":"WARN","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API returned non-ok status","type":"general","endpoint":"https://financialmodelingprep.com/api/v3/profile/AAPL?apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","statusCode":403,"errorText":"{\n  \"Error Message\": \"Legacy Endpoint : Due to Legacy endpoints being no longer supported - This endpoint is only available for legacy users who have valid subscriptions prior August 31, 2025. Please "}

stdout | test/api-comprehensive.spec.ts > API - Get Historical > GET /v1/api/get-historical returns historical data
[getHistoricalPricesByDateRange] Querying database for AAPL from 2025-06-17 to 2025-12-14

stdout | test/api-comprehensive.spec.ts > API - Get Historical > GET /v1/api/get-historical returns historical data
[getHistoricalPricesByDateRange] Found 2 records for AAPL in date range 2025-06-17 to 2025-12-14

stdout | test/api-comprehensive.spec.ts > API - Get Historical > GET /v1/api/get-historical returns historical data
[get-historical] Query result for AAPL (2025-06-17 to 2025-12-14): 2 records found in database
{"timestamp":"2025-12-14T19:34:05.837Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No historical data in database for AAPL","type":"general","dateRange":"2025-06-17 to 2025-12-14","action":"fetching from FMP API"}
[fetchAndSaveHistoricalPrice] Starting fetch for AAPL from FMP API
[fetchAndSaveHistoricalPrice] Fetching from: https://financialmodelingprep.com/stable/historical-chart/30min?symbol=AAPL&apikey=***&from=2025-06-17&to=2025-12-14

stderr | test/api-comprehensive.spec.ts > API - Get Historical > GET /v1/api/get-historical returns historical data
{"timestamp":"2025-12-14T19:34:05.837Z","service":"stockly-api-test","level":"WARN","traceId":"test-trace-id","userId":null,"path":"/test","message":"Found 2 records with missing OHLC data","type":"general","symbol":"AAPL","recordsWithMissingOHLC":2,"totalRecords":2}

stdout | test/api-comprehensive.spec.ts > API - Get Historical > GET /v1/api/get-historical returns historical data
[fetchAndSaveHistoricalPrice] Received 2 1-hour OHLC records from FMP API
[fetchAndSaveHistoricalPrice] FMP API returned 2 records for AAPL
[fetchAndSaveHistoricalPrice] Sample record structure: {
  date: undefined,
  hasOpen: false,
  hasHigh: false,
  hasLow: false,
  hasClose: false,
  hasPrice: false,
  keys: [ 'symbol', 'name', 'currency', 'stockExchange' ]
}
Saved 0 daily candles (aggregated from 2 1-hour records) for AAPL with OHLC data

stderr | test/api-comprehensive.spec.ts > API - Get Historical > GET /v1/api/get-historical returns historical data
[fetchAndSaveHistoricalPrice] Failed to parse date from timestamp undefined, skipping record
[fetchAndSaveHistoricalPrice] Failed to parse date from timestamp undefined, skipping record

stderr | test/get-historical.spec.ts > getHistorical handler > Date range parameters (from/to) > defaults to today when only 'to' is provided
{"timestamp":"2025-12-14T19:34:06.064Z","service":"stockly-api-test","level":"WARN","traceId":"test-trace-id","userId":null,"path":"/test","message":"Still no data after fetching from FMP API for AAPL","type":"general","dateRange":"2024-08-03 to 2025-01-31","possibleReasons":["FMP API returned empty data","FMP API returned data outside the requested date range","Date range is in the future or has no trading days","Database schema missing OHLC columns (check migration 009)"]}

stdout | test/get-historical.spec.ts > getHistorical handler > Date range parameters (from/to) > defaults to today when only 'to' is provided
{"timestamp":"2025-12-14T19:34:06.064Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2024-08-03 to 2025-01-31","recordCount":0}

stdout | test/get-historical.spec.ts > getHistorical handler > Date range parameters (from/to) > defaults to today when only 'from' is provided
[get-historical] Query result for AAPL (2025-01-01 to 2025-12-14): 0 records found in database
{"timestamp":"2025-12-14T19:34:06.068Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No historical data in database for AAPL","type":"general","dateRange":"2025-01-01 to 2025-12-14","action":"fetching from FMP API"}

stdout | test/api-schema-validation.spec.ts > API Schema Validation - Get Historical > getHistorical returns valid HistoricalPricesResponse schema
[getHistoricalPricesByDateRange] Querying database for AAPL from 2025-06-17 to 2025-12-14

stdout | test/api-schema-validation.spec.ts > API Schema Validation - Get Historical > getHistorical returns valid HistoricalPricesResponse schema
[getHistoricalPricesByDateRange] Found 2 records for AAPL in date range 2025-06-17 to 2025-12-14

stdout | test/api-schema-validation.spec.ts > API Schema Validation - Get Historical > getHistorical returns valid HistoricalPricesResponse schema
{"timestamp":"2025-12-14T19:34:06.186Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-06-17 to 2025-12-14","recordCount":2}
[get-historical] Successfully fetched 2 historical records for AAPL from FMP API

 ❯ test/api-schema-validation.spec.ts (16 tests | 4 failed) 1291ms
   ✓ API Schema Validation - Health Check > health endpoint returns valid HealthCheckResponse schema 21ms
   ✓ API Schema Validation - Get Stock > getStock returns valid StockQuoteResponse schema on success 20ms
   ✓ API Schema Validation - Get Stock > getStock returns valid ErrorResponse schema on error 18ms
   ✓ API Schema Validation - Get Stocks > getStocks returns valid StockQuotesResponse schema on success 18ms
   ✓ API Schema Validation - Get Stocks > getStocks returns valid ErrorResponse schema on error 15ms
   ✓ API Schema Validation - Search Stock > searchStock returns valid SearchStockResponse schema 13ms
   ✓ API Schema Validation - Get Historical > getHistorical returns valid HistoricalPricesResponse schema  1081ms
   ✓ API Schema Validation - Get Historical > getHistorical returns valid ErrorResponse schema on error 3ms
   × API Schema Validation - Alerts > listAlerts returns valid AlertsListResponse schema 6ms
     → expected 401 to be 200 // Object.is equality
   × API Schema Validation - Alerts > createAlert accepts valid CreateAlertRequest schema 1ms
     → expected 401 to be 201 // Object.is equality
   × API Schema Validation - Alerts > updateAlert accepts valid UpdateAlertRequest schema 2ms
     → expected 401 to be 200 // Object.is equality
   × API Schema Validation - Alerts > getAlert returns valid Alert schema 1ms
     → expected 401 to be 200 // Object.is equality
   ✓ API Schema Validation - Input Validation > rejects invalid CreateAlertRequest 1ms
   ✓ API Schema Validation - Input Validation > accepts valid CreateAlertRequest with optional fields 2ms
   ✓ API Schema Validation - Input Validation > rejects invalid UpdateAlertRequest 2ms
   ✓ API Schema Validation - Input Validation > accepts partial UpdateAlertRequest 2ms
stdout | test/api-integration.spec.ts > API Integration - Get Historical > successfully fetches historical price data
[getHistoricalPricesByDateRange] Querying database for AAPL from 2025-06-17 to 2025-12-14

stdout | test/api-integration.spec.ts > API Integration - Get Historical > successfully fetches historical price data
[getHistoricalPricesByDateRange] Found 3 records for AAPL in date range 2025-06-17 to 2025-12-14

stdout | test/api-integration.spec.ts > API Integration - Get Historical > successfully fetches historical price data
{"timestamp":"2025-12-14T19:34:06.237Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-06-17 to 2025-12-14","recordCount":3}
[get-historical] Successfully fetched 3 historical records for AAPL from FMP API

 ❯ test/api-integration.spec.ts (17 tests | 7 failed) 1336ms
   ✓ API Integration - Health Check > health endpoint returns OK status 21ms
   ✓ API Integration - Get Stock > successfully fetches and returns stock data with all required fields 20ms
   × API Integration - Get Stock > returns error when symbol is missing 9ms
     → Cannot read properties of undefined (reading 'get')
   × API Integration - Get Stock > uses cache when available 6ms
     → Cannot read properties of undefined (reading 'get')
   ✓ API Integration - Get Stocks > successfully fetches multiple stocks with all required fields 16ms
   ✓ API Integration - Get Stocks > returns error when symbols parameter is missing 12ms
   ✓ API Integration - Get Stocks > handles empty symbols list 13ms
   ✓ API Integration - Search Stock > successfully searches and returns matching stocks 13ms
   ✓ API Integration - Search Stock > returns empty array when query parameter is missing 8ms
   ✓ API Integration - Get Historical > successfully fetches historical price data  1101ms
   ✓ API Integration - Get Historical > returns error when symbol is missing 3ms
   ✓ API Integration - Get Historical > validates days parameter 2ms
   × API Integration - Alerts > successfully lists all alerts 4ms
     → expected 401 to be 200 // Object.is equality
   × API Integration - Alerts > successfully creates an alert 2ms
     → expected 401 to be 201 // Object.is equality
   × API Integration - Alerts > successfully updates an alert 1ms
     → expected 401 to be 200 // Object.is equality
   × API Integration - Alerts > successfully deletes an alert 1ms
     → expected 401 to be 200 // Object.is equality
   × API Integration - Alerts > returns 404 when alert not found 1ms
     → expected 401 to be 404 // Object.is equality
stderr | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Invalid Input Handling > should handle very long symbol list in getStocks
Failed to refresh quotes TypeError: env.stockly.prepare(...).bind(...).run is not a function
    at insertQuote (/home/sngvahmed/workspace/stockly/api/src/api/get-stocks.ts:246:6)
    at /home/sngvahmed/workspace/stockly/api/src/api/get-stocks.ts:311:17
    at Array.map (<anonymous>)
    at Module.getStocks (/home/sngvahmed/workspace/stockly/api/src/api/get-stocks.ts:308:19)
    at /home/sngvahmed/workspace/stockly/api/test/api/edge-cases.spec.ts:68:24
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20

stderr | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Invalid Input Handling > should handle SQL injection attempts in search
Failed to read search cache TypeError: Cannot read properties of undefined (reading 'bind')
    at getDbCachedResults (/home/sngvahmed/workspace/stockly/api/src/api/search-stock.ts:24:7)
    at Module.searchStock (/home/sngvahmed/workspace/stockly/api/src/api/search-stock.ts:129:26)
    at /home/sngvahmed/workspace/stockly/api/test/api/edge-cases.spec.ts:88:30
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:155:11
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:26
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1863:10)
    at runTest (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1574:12)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)

stdout | test/api-comprehensive.spec.ts > API - Get Historical > GET /v1/api/get-historical returns historical data
[getHistoricalPricesByDateRange] Querying database for AAPL from 2025-06-17 to 2025-12-14

stdout | test/api-comprehensive.spec.ts > API - Get Historical > GET /v1/api/get-historical returns historical data
[getHistoricalPricesByDateRange] Found 2 records for AAPL in date range 2025-06-17 to 2025-12-14

stdout | test/api-comprehensive.spec.ts > API - Get Historical > GET /v1/api/get-historical returns historical data
{"timestamp":"2025-12-14T19:34:06.340Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-06-17 to 2025-12-14","recordCount":2}
[get-historical] Successfully fetched 2 historical records for AAPL from FMP API

stdout | test/api-comprehensive.spec.ts > API - Alerts > GET /v1/api/alerts lists all alerts
{"timestamp":"2025-12-14T19:34:06.348Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Alerts request authenticated","type":"general","username":"testuser","isAdmin":false,"requestUsername":"testuser","method":"GET"}

stdout | test/api-comprehensive.spec.ts > API - Alerts > GET /v1/api/alerts lists all alerts
{"timestamp":"2025-12-14T19:34:06.348Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Fetched alerts from D1","type":"general","username":"testuser","alertCount":1,"alertIds":["alert-123"]}

stdout | test/api-comprehensive.spec.ts > API - Alerts > POST /v1/api/alerts creates a new alert
{"timestamp":"2025-12-14T19:34:06.351Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Alerts request authenticated","type":"general","username":"testuser","isAdmin":false,"requestUsername":"testuser","method":"POST"}

stdout | test/api-comprehensive.spec.ts > API - Alerts > POST /v1/api/alerts creates a new alert
{"timestamp":"2025-12-14T19:34:06.352Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Creating alert","type":"general","username":"testuser","symbol":"AAPL","direction":"above","threshold":200}

stdout | test/api-comprehensive.spec.ts > API - Alerts > POST /v1/api/alerts creates a new alert
{"timestamp":"2025-12-14T19:34:06.352Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Created alert successfully","type":"general","alertId":"alert-123","username":"testuser","alertUsername":"testuser","isAdmin":false}

stdout | test/api-comprehensive.spec.ts > API - Alerts > GET /v1/api/alerts/:id gets a specific alert
{"timestamp":"2025-12-14T19:34:06.354Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Alerts request authenticated","type":"general","username":"testuser","isAdmin":false,"requestUsername":"testuser","method":"GET"}

stdout | test/api-comprehensive.spec.ts > API - Alerts > PUT /v1/api/alerts/:id updates an alert
{"timestamp":"2025-12-14T19:34:06.356Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Alerts request authenticated","type":"general","username":"testuser","isAdmin":false,"requestUsername":"testuser","method":"PUT"}

stdout | test/api-comprehensive.spec.ts > API - Alerts > PUT /v1/api/alerts/:id updates an alert
{"timestamp":"2025-12-14T19:34:06.356Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Updated alert","type":"general","alertId":"alert-123","username":"testuser"}

stdout | test/api-comprehensive.spec.ts > API - Alerts > DELETE /v1/api/alerts/:id deletes an alert
{"timestamp":"2025-12-14T19:34:06.359Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Alerts request authenticated","type":"general","username":"testuser","isAdmin":false,"requestUsername":"testuser","method":"DELETE"}

stdout | test/api-comprehensive.spec.ts > API - Alerts > DELETE /v1/api/alerts/:id deletes an alert
{"timestamp":"2025-12-14T19:34:06.359Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Deleted alert","type":"general","alertId":"alert-123","username":"testuser"}

stdout | test/api-comprehensive.spec.ts > API - Push Token > POST /v1/api/push-token registers a new push token
✅ FCM token validation passed: length=30, format valid

stdout | test/api-comprehensive.spec.ts > API - Push Token > POST /v1/api/push-token registers a new push token
{"timestamp":"2025-12-14T19:34:06.364Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Registering new push token","type":"general","username":"testuser","deviceType":"ios","tokenPreview":"fcm-token-1234567890..."}

stdout | test/api-comprehensive.spec.ts > API - Push Token > POST /v1/api/push-token registers a new push token
{"timestamp":"2025-12-14T19:34:06.364Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Push token registered successfully","type":"general","username":"testuser","deviceType":"ios","deviceId":"fcm-token-1234567890..."}

stdout | test/api-comprehensive.spec.ts > API - Push Token > POST /v1/api/push-token updates existing push token
✅ FCM token validation passed: length=30, format valid

stdout | test/api-comprehensive.spec.ts > API - Push Token > POST /v1/api/push-token updates existing push token
{"timestamp":"2025-12-14T19:34:06.367Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Updating existing push token","type":"general","username":"testuser","deviceType":"ios"}

stdout | test/api-comprehensive.spec.ts > API - Push Token > POST /v1/api/push-token updates existing push token
{"timestamp":"2025-12-14T19:34:06.368Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":"user-123","path":"/test","message":"Push token updated successfully","type":"general","username":"testuser","deviceType":"ios"}

stderr | test/api-comprehensive.spec.ts > API - Devices > GET /v1/api/devices returns all devices
{"timestamp":"2025-12-14T19:34:06.407Z","service":"stockly-api-test","level":"WARN","traceId":"test-trace-id","userId":null,"path":"/test","message":"Found devices with null username","type":"general","count":1,"deviceIds":["fcm-token-123..."]}

stdout | test/api-comprehensive.spec.ts > API - Devices > DELETE /v1/api/devices deletes a device
{"timestamp":"2025-12-14T19:34:06.411Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Device deleted successfully","type":"general","deletedPushToken":"fcm-token-1234567890...","deletedUserId":"user-123","deletedBy":"testuser","isAdmin":true}

 ✓ test/api-comprehensive.spec.ts (35 tests) 1316ms
   ✓ API - Get Single Stock > GET /v1/api/get-stock returns stock data with all required fields  677ms
   ✓ API - Get Historical > GET /v1/api/get-historical returns historical data  507ms
stderr | test/get-historical.spec.ts > getHistorical handler > Date range parameters (from/to) > defaults to today when only 'from' is provided
{"timestamp":"2025-12-14T19:34:06.569Z","service":"stockly-api-test","level":"WARN","traceId":"test-trace-id","userId":null,"path":"/test","message":"Still no data after fetching from FMP API for AAPL","type":"general","dateRange":"2025-01-01 to 2025-12-14","possibleReasons":["FMP API returned empty data","FMP API returned data outside the requested date range","Date range is in the future or has no trading days","Database schema missing OHLC columns (check migration 009)"]}

stdout | test/get-historical.spec.ts > getHistorical handler > Date range parameters (from/to) > defaults to today when only 'from' is provided
{"timestamp":"2025-12-14T19:34:06.569Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-01-01 to 2025-12-14","recordCount":0}

stdout | test/get-historical.spec.ts > getHistorical handler > Days parameter (backward compatibility) > accepts days parameter
[get-historical] Query result for AAPL (2025-11-14 to 2025-12-14): 2 records found in database

stdout | test/get-historical.spec.ts > getHistorical handler > Days parameter (backward compatibility) > defaults to 180 days when no parameters provided
[get-historical] Query result for AAPL (2025-06-17 to 2025-12-14): 0 records found in database
{"timestamp":"2025-12-14T19:34:06.578Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No historical data in database for AAPL","type":"general","dateRange":"2025-06-17 to 2025-12-14","action":"fetching from FMP API"}

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Database Error Handling > should handle database connection errors gracefully
{"timestamp":"2025-12-14T19:34:06.764Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No cache for AAPL","type":"general","cacheStatus":"MISS"}

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Database Error Handling > should handle database connection errors gracefully
{"timestamp":"2025-12-14T19:34:06.858Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /quote","type":"api_call","apiProvider":"FMP","endpoint":"/quote","method":"GET","statusCode":200,"latencyMs":94}

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Database Error Handling > should handle database connection errors gracefully
{"timestamp":"2025-12-14T19:34:06.953Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"FMP API: GET /profile","type":"api_call","apiProvider":"FMP","endpoint":"/profile","method":"GET","statusCode":200,"latencyMs":94}

stderr | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Database Error Handling > should handle database connection errors gracefully
{"timestamp":"2025-12-14T19:34:06.954Z","service":"stockly-api-test","level":"ERROR","traceId":"test-trace-id","userId":null,"path":"/test","message":"ERROR in getStock","type":"general","symbol":"AAPL","error":{"name":"Error","message":"Database connection failed","stack":"Error: Database connection failed\n    at Object.<anonymous> (/home/sngvahmed/workspace/stockly/api/test/api/edge-cases.spec.ts:102:15)\n    at Object.mockCall (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/spy/dist/index.js:96:15)\n    at Object.spy [as prepare] (home/sngvahmed/workspace/stockly/api/node_modules/tinyspy/dist/index.js:47:80)\n    at Module.getStock (/home/sngvahmed/workspace/stockly/api/src/api/get-stock.ts:306:8)\n    at /home/sngvahmed/workspace/stockly/api/test/api/edge-cases.spec.ts:106:24\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20"}}
{"timestamp":"2025-12-14T19:34:06.954Z","service":"stockly-api-test","level":"ERROR","traceId":"test-trace-id","userId":null,"path":"/test","message":"Failed to fetch from DB during provider failure","type":"general","error":{"name":"Error","message":"Database connection failed","stack":"Error: Database connection failed\n    at Object.<anonymous> (/home/sngvahmed/workspace/stockly/api/test/api/edge-cases.spec.ts:102:15)\n    at Object.mockCall (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/spy/dist/index.js:96:15)\n    at Object.spy [as prepare] (home/sngvahmed/workspace/stockly/api/node_modules/tinyspy/dist/index.js:47:80)\n    at handleProviderFailure (/home/sngvahmed/workspace/stockly/api/src/api/get-stock.ts:367:8)\n    at Module.getStock (/home/sngvahmed/workspace/stockly/api/src/api/get-stock.ts:345:20)\n    at /home/sngvahmed/workspace/stockly/api/test/api/edge-cases.spec.ts:106:24\n    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20"}}

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Database Error Handling > should handle database connection errors gracefully
{"timestamp":"2025-12-14T19:34:06.953Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Profile API response","type":"general","endpoint":"https://financialmodelingprep.com/stable/profile?symbol=AAPL&apikey=z5xjUUlsab7zBKntL5QnMzWyPuq2iWsM","responseType":"array","responseLength":1}
{"timestamp":"2025-12-14T19:34:06.953Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Found description from profile","type":"general","descriptionLength":1665}
{"timestamp":"2025-12-14T19:34:06.953Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"Final description resolved","type":"general","hasDescription":true,"descriptionLength":1665,"source":"profile"}

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Database Error Handling > should handle database timeout errors
{"timestamp":"2025-12-14T19:34:06.957Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > External API Error Handling > should handle external API rate limiting
{"timestamp":"2025-12-14T19:34:06.962Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > External API Error Handling > should handle external API timeout
{"timestamp":"2025-12-14T19:34:06.965Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > External API Error Handling > should handle external API returning invalid JSON
{"timestamp":"2025-12-14T19:34:06.967Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}

stderr | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Boundary Conditions > should handle very long search query
Failed to read search cache TypeError: Cannot read properties of undefined (reading 'bind')
    at getDbCachedResults (/home/sngvahmed/workspace/stockly/api/src/api/search-stock.ts:24:7)
    at Module.searchStock (/home/sngvahmed/workspace/stockly/api/src/api/search-stock.ts:129:26)
    at /home/sngvahmed/workspace/stockly/api/test/api/edge-cases.spec.ts:291:30
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:155:11
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:26
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1863:10)
    at runTest (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1574:12)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)

stderr | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Boundary Conditions > should handle very long search query
Failed to parse /search-name response: Error: Invalid JSON
    at Object.json (/home/sngvahmed/workspace/stockly/api/test/api/edge-cases.spec.ts:185:17)
    at Module.searchStock (/home/sngvahmed/workspace/stockly/api/src/api/search-stock.ts:158:40)
    at /home/sngvahmed/workspace/stockly/api/test/api/edge-cases.spec.ts:291:24
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20

stderr | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Boundary Conditions > should handle very long search query
Failed to parse /search-symbol response: Error: Invalid JSON
    at Object.json (/home/sngvahmed/workspace/stockly/api/test/api/edge-cases.spec.ts:185:17)
    at Module.searchStock (/home/sngvahmed/workspace/stockly/api/src/api/search-stock.ts:170:44)
    at /home/sngvahmed/workspace/stockly/api/test/api/edge-cases.spec.ts:291:24
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20

stdout | test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Concurrent Request Handling > should handle multiple simultaneous requests for same symbol
{"timestamp":"2025-12-14T19:34:06.990Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}
{"timestamp":"2025-12-14T19:34:06.990Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}
{"timestamp":"2025-12-14T19:34:06.990Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}
{"timestamp":"2025-12-14T19:34:06.990Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}
{"timestamp":"2025-12-14T19:34:06.990Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}
{"timestamp":"2025-12-14T19:34:06.990Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}
{"timestamp":"2025-12-14T19:34:06.990Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}
{"timestamp":"2025-12-14T19:34:06.990Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}
{"timestamp":"2025-12-14T19:34:06.990Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}
{"timestamp":"2025-12-14T19:34:06.990Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"Cache hit for AAPL","type":"general","ageSeconds":0,"pollingIntervalSec":30,"cacheStatus":"HIT"}

 ❯ test/api/edge-cases.spec.ts (19 tests | 1 failed) 2296ms
   ✓ Edge Cases and Error Scenarios > Invalid Input Handling > should handle empty symbol in getStock 38ms
   ✓ Edge Cases and Error Scenarios > Invalid Input Handling > should handle invalid symbol format  1024ms
   ✓ Edge Cases and Error Scenarios > Invalid Input Handling > should handle empty symbols array in getStocks 3ms
   × Edge Cases and Error Scenarios > Invalid Input Handling > should handle very long symbol list in getStocks 512ms
     → expected [ 200, 400, 413 ] to include 500
   ✓ Edge Cases and Error Scenarios > Invalid Input Handling > should handle empty search query 2ms
   ✓ Edge Cases and Error Scenarios > Invalid Input Handling > should handle SQL injection attempts in search  443ms
   ✓ Edge Cases and Error Scenarios > Database Error Handling > should handle database connection errors gracefully 194ms
   ✓ Edge Cases and Error Scenarios > Database Error Handling > should handle database timeout errors 3ms
   ✓ Edge Cases and Error Scenarios > External API Error Handling > should handle external API rate limiting 3ms
   ✓ Edge Cases and Error Scenarios > External API Error Handling > should handle external API timeout 2ms
   ✓ Edge Cases and Error Scenarios > External API Error Handling > should handle external API returning invalid JSON 2ms
   ✓ Edge Cases and Error Scenarios > Authentication Edge Cases > should handle expired access token 2ms
   ✓ Edge Cases and Error Scenarios > Authentication Edge Cases > should handle malformed authorization header 1ms
   ✓ Edge Cases and Error Scenarios > Alert Edge Cases > should handle negative threshold values 2ms
   ✓ Edge Cases and Error Scenarios > Alert Edge Cases > should handle extremely large threshold values 1ms
   ✓ Edge Cases and Error Scenarios > Alert Edge Cases > should handle missing required fields in alert creation 2ms
   ✓ Edge Cases and Error Scenarios > Boundary Conditions > should handle maximum number of symbols in batch request 2ms
   ✓ Edge Cases and Error Scenarios > Boundary Conditions > should handle very long search query 4ms
   ✓ Edge Cases and Error Scenarios > Concurrent Request Handling > should handle multiple simultaneous requests for same symbol 4ms
stderr | test/get-stock-details.spec.ts > getStockDetails service > handles partial data failures gracefully
Failed to fetch historical for AAPL: Error: Endpoint failed
    at /home/sngvahmed/workspace/stockly/api/test/get-stock-details.spec.ts:139:31
    at mockCall (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/spy/dist/index.js:96:15)
    at spy (home/sngvahmed/workspace/stockly/api/node_modules/tinyspy/dist/index.js:47:80)
    at fetchWithRetry (/home/sngvahmed/workspace/stockly/api/src/services/get-stock-details.ts:61:25)
    at async Promise.allSettled (index 2)
    at getStockDetails (/home/sngvahmed/workspace/stockly/api/src/services/get-stock-details.ts:400:9)
    at /home/sngvahmed/workspace/stockly/api/test/get-stock-details.spec.ts:142:20
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
Failed to fetch news for AAPL: Error: Endpoint failed
    at /home/sngvahmed/workspace/stockly/api/test/get-stock-details.spec.ts:139:31
    at mockCall (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/spy/dist/index.js:96:15)
    at spy (home/sngvahmed/workspace/stockly/api/node_modules/tinyspy/dist/index.js:47:80)
    at fetchWithRetry (/home/sngvahmed/workspace/stockly/api/src/services/get-stock-details.ts:61:25)
    at async Promise.allSettled (index 5)
    at getStockDetails (/home/sngvahmed/workspace/stockly/api/src/services/get-stock-details.ts:400:9)
    at /home/sngvahmed/workspace/stockly/api/test/get-stock-details.spec.ts:142:20
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20

stdout | test/get-stock-details.spec.ts > getStockDetails service > returns error when all critical endpoints fail
Cache miss for stock details: AAPL, fetching...

stderr | test/get-historical.spec.ts > getHistorical handler > Days parameter (backward compatibility) > defaults to 180 days when no parameters provided
{"timestamp":"2025-12-14T19:34:07.079Z","service":"stockly-api-test","level":"WARN","traceId":"test-trace-id","userId":null,"path":"/test","message":"Still no data after fetching from FMP API for AAPL","type":"general","dateRange":"2025-06-17 to 2025-12-14","possibleReasons":["FMP API returned empty data","FMP API returned data outside the requested date range","Date range is in the future or has no trading days","Database schema missing OHLC columns (check migration 009)"]}

stdout | test/get-historical.spec.ts > getHistorical handler > Days parameter (backward compatibility) > defaults to 180 days when no parameters provided
{"timestamp":"2025-12-14T19:34:07.079Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-06-17 to 2025-12-14","recordCount":0}

stdout | test/get-historical.spec.ts > getHistorical handler > Parameter priority > prioritizes from/to parameters over days parameter
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-31): 1 records found in database

stdout | test/get-historical.spec.ts > getHistorical handler > Database query > queries database with correct date range
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-31): 2 records found in database

stdout | test/get-historical.spec.ts > getHistorical handler > Database query > returns data from database when available
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-31): 3 records found in database

stdout | test/get-historical.spec.ts > getHistorical handler > Database query > returns empty array when database has no data
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-31): 0 records found in database
{"timestamp":"2025-12-14T19:34:07.103Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No historical data in database for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","action":"fetching from FMP API"}

stderr | test/get-historical.spec.ts > getHistorical handler > Database query > returns empty array when database has no data
{"timestamp":"2025-12-14T19:34:07.605Z","service":"stockly-api-test","level":"WARN","traceId":"test-trace-id","userId":null,"path":"/test","message":"Still no data after fetching from FMP API for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","possibleReasons":["FMP API returned empty data","FMP API returned data outside the requested date range","Date range is in the future or has no trading days","Database schema missing OHLC columns (check migration 009)"]}

stdout | test/get-historical.spec.ts > getHistorical handler > Database query > returns empty array when database has no data
{"timestamp":"2025-12-14T19:34:07.605Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","recordCount":0}

stdout | test/get-historical.spec.ts > getHistorical handler > FMP API fallback > fetches from FMP API when database is empty and ctx is available
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-31): 0 records found in database
{"timestamp":"2025-12-14T19:34:07.611Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No historical data in database for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","action":"fetching from FMP API"}

stdout | test/get-historical.spec.ts > getHistorical handler > FMP API fallback > fetches from FMP API when database is empty and ctx is available
{"timestamp":"2025-12-14T19:34:08.113Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","recordCount":1}
[get-historical] Successfully fetched 1 historical records for AAPL from FMP API

stdout | test/get-historical.spec.ts > getHistorical handler > FMP API fallback > creates fallback ExecutionContext when ctx is not available and fetches from FMP API
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-31): 0 records found in database
{"timestamp":"2025-12-14T19:34:08.117Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No historical data in database for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","action":"fetching from FMP API"}

stdout | test/get-historical.spec.ts > getHistorical handler > FMP API fallback > creates fallback ExecutionContext when ctx is not available and fetches from FMP API
{"timestamp":"2025-12-14T19:34:08.617Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","recordCount":1}
[get-historical] Successfully fetched 1 historical records for AAPL from FMP API

stdout | test/get-historical.spec.ts > getHistorical handler > FMP API fallback > handles FMP API fetch errors gracefully
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-31): 0 records found in database
{"timestamp":"2025-12-14T19:34:08.622Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No historical data in database for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","action":"fetching from FMP API"}

stderr | test/get-historical.spec.ts > getHistorical handler > FMP API fallback > handles FMP API fetch errors gracefully
[get-historical] Error fetching historical data from FMP API for AAPL: FMP API error

stdout | test/get-historical.spec.ts > getHistorical handler > Response format > returns correct response format with from/to parameters
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-31): 1 records found in database

stdout | test/get-historical.spec.ts > getHistorical handler > Response format > returns correct response format with days parameter
[get-historical] Query result for AAPL (2025-11-14 to 2025-12-14): 1 records found in database

stdout | test/get-historical.spec.ts > getHistorical handler > Response format > includes all required fields in data items
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-31): 1 records found in database

stdout | test/get-historical.spec.ts > getHistorical handler > Missing OHLC data handling > re-fetches from FMP API when OHLC data is missing (null)
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-31): 1 records found in database
{"timestamp":"2025-12-14T19:34:08.643Z","service":"stockly-api-test","level":"INFO","traceId":"test-trace-id","userId":null,"path":"/test","message":"No historical data in database for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","action":"fetching from FMP API"}

stderr | test/get-historical.spec.ts > getHistorical handler > Missing OHLC data handling > re-fetches from FMP API when OHLC data is missing (null)
{"timestamp":"2025-12-14T19:34:08.643Z","service":"stockly-api-test","level":"WARN","traceId":"test-trace-id","userId":null,"path":"/test","message":"Found 1 records with missing OHLC data","type":"general","symbol":"AAPL","recordsWithMissingOHLC":1,"totalRecords":1}

stdout | test/get-historical.spec.ts > getHistorical handler > Missing OHLC data handling > re-fetches from FMP API when OHLC data is missing (null)
{"timestamp":"2025-12-14T19:34:09.143Z","service":"stockly-api-test","level":"DEBUG","traceId":"test-trace-id","userId":null,"path":"/test","message":"After FMP fetch, query result for AAPL","type":"general","dateRange":"2025-01-01 to 2025-01-31","recordCount":1}
[get-historical] Successfully fetched 1 historical records for AAPL from FMP API

stdout | test/get-historical.spec.ts > getHistorical handler > Missing OHLC data handling > does not re-fetch when OHLC data is present
[get-historical] Query result for AAPL (2025-01-01 to 2025-01-31): 1 records found in database

stderr | test/get-historical.spec.ts > getHistorical handler > Error handling > handles database query errors gracefully
ERROR in getHistorical for AAPL: Error: Database error
    at /home/sngvahmed/workspace/stockly/api/test/get-historical.spec.ts:816:67
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:155:11
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:26
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1863:10)
    at runTest (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1574:12)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)
    at runSuite (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)

 ✓ test/get-historical.spec.ts (28 tests) 4748ms
   ✓ getHistorical handler > Parameter validation > accepts symbol parameter  524ms
   ✓ getHistorical handler > Parameter validation > normalizes symbol to uppercase  511ms
   ✓ getHistorical handler > Date range parameters (from/to) > defaults to today when only 'to' is provided  505ms
   ✓ getHistorical handler > Date range parameters (from/to) > defaults to today when only 'from' is provided  505ms
   ✓ getHistorical handler > Days parameter (backward compatibility) > defaults to 180 days when no parameters provided  504ms
   ✓ getHistorical handler > Database query > returns empty array when database has no data  506ms
   ✓ getHistorical handler > FMP API fallback > fetches from FMP API when database is empty and ctx is available  505ms
   ✓ getHistorical handler > FMP API fallback > creates fallback ExecutionContext when ctx is not available and fetches from FMP API  505ms
   ✓ getHistorical handler > Missing OHLC data handling > re-fetches from FMP API when OHLC data is missing (null)  506ms
stderr | test/get-stock-details.spec.ts > getStockDetails service > returns error when all critical endpoints fail
Failed to fetch profile for AAPL: Error: All profile endpoints failed
    at fetchProfile (/home/sngvahmed/workspace/stockly/api/src/services/get-stock-details.ts:134:9)
    at async Promise.allSettled (index 0)
    at getStockDetails (/home/sngvahmed/workspace/stockly/api/src/services/get-stock-details.ts:400:9)
    at /home/sngvahmed/workspace/stockly/api/test/get-stock-details.spec.ts:162:20
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
Failed to fetch quote for AAPL: Error: All endpoints failed
    at /home/sngvahmed/workspace/stockly/api/test/get-stock-details.spec.ts:159:31
    at mockCall (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/spy/dist/index.js:96:15)
    at spy (home/sngvahmed/workspace/stockly/api/node_modules/tinyspy/dist/index.js:47:80)
    at fetchWithRetry (/home/sngvahmed/workspace/stockly/api/src/services/get-stock-details.ts:61:25)
    at async Promise.allSettled (index 1)
    at getStockDetails (/home/sngvahmed/workspace/stockly/api/src/services/get-stock-details.ts:400:9)
    at /home/sngvahmed/workspace/stockly/api/test/get-stock-details.spec.ts:162:20
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
Failed to fetch historical for AAPL: Error: All endpoints failed
    at /home/sngvahmed/workspace/stockly/api/test/get-stock-details.spec.ts:159:31
    at mockCall (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/spy/dist/index.js:96:15)
    at spy (home/sngvahmed/workspace/stockly/api/node_modules/tinyspy/dist/index.js:47:80)
    at fetchWithRetry (/home/sngvahmed/workspace/stockly/api/src/services/get-stock-details.ts:61:25)
    at async Promise.allSettled (index 2)
    at getStockDetails (/home/sngvahmed/workspace/stockly/api/src/services/get-stock-details.ts:400:9)
    at /home/sngvahmed/workspace/stockly/api/test/get-stock-details.spec.ts:162:20
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20
Failed to fetch news for AAPL: Error: All endpoints failed
    at /home/sngvahmed/workspace/stockly/api/test/get-stock-details.spec.ts:159:31
    at mockCall (home/sngvahmed/workspace/stockly/api/node_modules/@vitest/spy/dist/index.js:96:15)
    at spy (home/sngvahmed/workspace/stockly/api/node_modules/tinyspy/dist/index.js:47:80)
    at fetchWithRetry (/home/sngvahmed/workspace/stockly/api/src/services/get-stock-details.ts:61:25)
    at async Promise.allSettled (index 5)
    at getStockDetails (/home/sngvahmed/workspace/stockly/api/src/services/get-stock-details.ts:400:9)
    at /home/sngvahmed/workspace/stockly/api/test/get-stock-details.spec.ts:162:20
    at home/sngvahmed/workspace/stockly/api/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20

stdout | test/get-stock-details.spec.ts > getStockDetails service > normalizes chart data correctly by time periods
Cache miss for stock details: AAPL, fetching...

stdout | test/get-stock-details.spec.ts > getStockDetails service > handles rate limiting with retry
Cache miss for stock details: AAPL, fetching...

stderr | test/get-stock-details.spec.ts > getStockDetails service > handles rate limiting with retry
Rate limited, retrying in 1000ms...
Rate limited, retrying in 1000ms...

stdout | test/get-stock-details.spec.ts > getStockDetails service > normalizes financial data correctly
Cache miss for stock details: AAPL, fetching...

 ✓ test/get-stock-details.spec.ts (7 tests) 13189ms
   ✓ getStockDetails service > handles partial data failures gracefully  3046ms
   ✓ getStockDetails service > returns error when all critical endpoints fail  9010ms
   ✓ getStockDetails service > handles rate limiting with retry  1007ms

⎯⎯⎯⎯⎯⎯ Failed Suites 1 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  test/api/auth.spec.ts [ test/api/auth.spec.ts ]
Error: [vitest] There was an error when mocking a module. If you are using "vi.mock" factory, make sure there are no top level variables inside, since this call is hoisted to top of the file. Read more: https://vitest.dev/api/vi.html#vi-mock
 ❯ src/api/auth.ts:20:1
     18|   isReservedWord,
     19| } from "../auth/username-validation";
     20| import {
       | ^
     21|   authenticateRequest,
     22|   setHttpOnlyCookie,

Caused by: ReferenceError: username is not defined
 ❯ test/api/auth.spec.ts:290:11
 ❯ src/api/auth.ts:20:1

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/43]⎯


⎯⎯⎯⎯⎯⎯ Failed Tests 42 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  test/api-integration.spec.ts > API Integration - Get Stock > returns error when symbol is missing
TypeError: Cannot read properties of undefined (reading 'get')
 ❯ Module.getStock src/api/get-stock.ts:16:35
     14|   logger: Logger
     15| ): Promise<Response> {
     16|   const symbol = url.searchParams.get("symbol");
       |                                   ^
     17| 
     18|   if (!symbol) return json({ error: "symbol required" }, 400, request);
 ❯ test/api-integration.spec.ts:160:28

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[2/43]⎯

 FAIL  test/api-integration.spec.ts > API Integration - Get Stock > uses cache when available
TypeError: Cannot read properties of undefined (reading 'get')
 ❯ Module.getStock src/api/get-stock.ts:16:35
     14|   logger: Logger
     15| ): Promise<Response> {
     16|   const symbol = url.searchParams.get("symbol");
       |                                   ^
     17| 
     18|   if (!symbol) return json({ error: "symbol required" }, 400, request);
 ❯ test/api-integration.spec.ts:186:28

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[3/43]⎯

 FAIL  test/api-integration.spec.ts > API Integration - Alerts > successfully lists all alerts
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 ❯ test/api-integration.spec.ts:451:29
    449|     const response = await handleAlertsRequest(request, env, createMoc…
    450|     
    451|     expect(response.status).toBe(200);
       |                             ^
    452|     const data = await response.json();
    453|     expect(validateAlertsListResponse(data)).toBe(true);

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[4/43]⎯

 FAIL  test/api-integration.spec.ts > API Integration - Alerts > successfully creates an alert
AssertionError: expected 401 to be 201 // Object.is equality

- Expected
+ Received

- 201
+ 401

 ❯ test/api-integration.spec.ts:486:29
    484|     const response = await handleAlertsRequest(request, env, createMoc…
    485|     
    486|     expect(response.status).toBe(201);
       |                             ^
    487|     const data = await response.json();
    488|     expect(validateAlert(data)).toBe(true);

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[5/43]⎯

 FAIL  test/api-integration.spec.ts > API Integration - Alerts > successfully updates an alert
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 ❯ test/api-integration.spec.ts:521:29
    519|     const response = await handleAlertsRequest(request, env, createMoc…
    520|     
    521|     expect(response.status).toBe(200);
       |                             ^
    522|     const data = await response.json();
    523|     expect(validateAlert(data)).toBe(true);

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[6/43]⎯

 FAIL  test/api-integration.spec.ts > API Integration - Alerts > successfully deletes an alert
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 ❯ test/api-integration.spec.ts:536:29
    534|     const response = await handleAlertsRequest(request, env, createMoc…
    535|     
    536|     expect(response.status).toBe(200);
       |                             ^
    537|     const data = await response.json();
    538|     expect(data).toHaveProperty("success", true);

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[7/43]⎯

 FAIL  test/api-integration.spec.ts > API Integration - Alerts > returns 404 when alert not found
AssertionError: expected 401 to be 404 // Object.is equality

- Expected
+ Received

- 404
+ 401

 ❯ test/api-integration.spec.ts:548:29
    546|     const response = await handleAlertsRequest(request, env, createMoc…
    547|     
    548|     expect(response.status).toBe(404);
       |                             ^
    549|     const data = await response.json();
    550|     expect(validateErrorResponse(data)).toBe(true);

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[8/43]⎯

 FAIL  test/api-schema-validation.spec.ts > API Schema Validation - Alerts > listAlerts returns valid AlertsListResponse schema
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 ❯ test/api-schema-validation.spec.ts:337:29
    335|     const response = await handleAlertsRequest(request, env, createMoc…
    336|     
    337|     expect(response.status).toBe(200);
       |                             ^
    338|     const data = await response.json();
    339|     expect(validateAlertsListResponse(data)).toBe(true);

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[9/43]⎯

 FAIL  test/api-schema-validation.spec.ts > API Schema Validation - Alerts > createAlert accepts valid CreateAlertRequest schema
AssertionError: expected 401 to be 201 // Object.is equality

- Expected
+ Received

- 201
+ 401

 ❯ test/api-schema-validation.spec.ts:382:29
    380|     const response = await handleAlertsRequest(request, env, createMoc…
    381|     
    382|     expect(response.status).toBe(201);
       |                             ^
    383|     const data = await response.json();
    384|     expect(validateAlert(data)).toBe(true);

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[10/43]⎯

 FAIL  test/api-schema-validation.spec.ts > API Schema Validation - Alerts > updateAlert accepts valid UpdateAlertRequest schema
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 ❯ test/api-schema-validation.spec.ts:417:29
    415|     const response = await handleAlertsRequest(request, env, createMoc…
    416|     
    417|     expect(response.status).toBe(200);
       |                             ^
    418|     const data = await response.json();
    419|     expect(validateAlert(data)).toBe(true);

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[11/43]⎯

 FAIL  test/api-schema-validation.spec.ts > API Schema Validation - Alerts > getAlert returns valid Alert schema
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 ❯ test/api-schema-validation.spec.ts:442:29
    440|     const response = await handleAlertsRequest(request, env, createMoc…
    441|     
    442|     expect(response.status).toBe(200);
       |                             ^
    443|     const data = await response.json();
    444|     expect(validateAlert(data)).toBe(true);

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[12/43]⎯

 FAIL  test/devices.spec.ts > Devices API > getAllDevices > should return list of devices
AssertionError: expected "spy" to be called with arguments: [ StringContaining{…} ]

Received: 

  1st spy call:

  [
-   StringContaining "SELECT user_id, push_token, device_info",
+   "SELECT 
+                upt.user_id, 
+                upt.push_token, 
+                upt.device_info,
+                upt.device_type,
+                upt.created_at, 
+                upt.updated_at,
+                u.username
+              FROM user_push_tokens upt
+              LEFT JOIN users u ON upt.user_id = u.id
+              ORDER BY upt.updated_at DESC",
  ]

  2nd spy call:

  [
-   StringContaining "SELECT user_id, push_token, device_info",
+   "SELECT COUNT(*) as count FROM alerts WHERE target = ?",
  ]

  3rd spy call:

  [
-   StringContaining "SELECT user_id, push_token, device_info",
+   "SELECT COUNT(*) as count FROM alerts WHERE target = ?",
  ]

  4th spy call:

  [
-   StringContaining "SELECT user_id, push_token, device_info",
+   "SELECT COUNT(*) as count FROM alerts WHERE target = ? AND status = 'active'",
  ]

  5th spy call:

  [
-   StringContaining "SELECT user_id, push_token, device_info",
+   "SELECT COUNT(*) as count FROM alerts WHERE target = ? AND status = 'active'",
  ]


Number of calls: 5

 ❯ Proxy.methodWrapper home/sngvahmed/workspace/stockly/api/node_modules/.vite/vitest/da39a3ee5e6b4b0d3255bfef95601890afd80709/deps_ssr/vitest___@vitest_expect___chai.js:1601:25
 ❯ test/devices.spec.ts:99:30
     97|       const data = await response.json();
     98| 
     99|       expect(mockDb.prepare).toHaveBeenCalledWith(
       |                              ^
    100|         expect.stringContaining("SELECT user_id, push_token, device_in…
    101|       );

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[13/43]⎯

 FAIL  test/devices.spec.ts > Devices API > sendTestNotification > should send test notification successfully
TypeError: Cannot read properties of undefined (reading 'get')
 ❯ getAllowedOrigin src/util.ts:9:34
      7|  */
      8| function getAllowedOrigin(request: Request): string | null {
      9|   const origin = request.headers.get("Origin");
       |                                  ^
     10|   
     11|   if (!origin) {
 ❯ getCorsHeaders src/util.ts:39:18
 ❯ json src/util.ts:77:28
 ❯ Module.sendTestNotification src/api/devices.ts:410:12
 ❯ test/devices.spec.ts:182:30

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[14/43]⎯

 FAIL  test/devices.spec.ts > Devices API > sendTestNotification > should use default message when no custom message provided
TypeError: Cannot read properties of undefined (reading 'get')
 ❯ getAllowedOrigin src/util.ts:9:34
      7|  */
      8| function getAllowedOrigin(request: Request): string | null {
      9|   const origin = request.headers.get("Origin");
       |                                  ^
     10|   
     11|   if (!origin) {
 ❯ getCorsHeaders src/util.ts:39:18
 ❯ json src/util.ts:77:28
 ❯ Module.sendTestNotification src/api/devices.ts:410:12
 ❯ test/devices.spec.ts:232:30

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[15/43]⎯

 FAIL  test/devices.spec.ts > Devices API > sendTestNotification > should return 404 when device not found
TypeError: Cannot read properties of undefined (reading 'get')
 ❯ getAllowedOrigin src/util.ts:9:34
      7|  */
      8| function getAllowedOrigin(request: Request): string | null {
      9|   const origin = request.headers.get("Origin");
       |                                  ^
     10|   
     11|   if (!origin) {
 ❯ getCorsHeaders src/util.ts:39:18
 ❯ json src/util.ts:77:28
 ❯ Module.sendTestNotification src/api/devices.ts:410:12
 ❯ test/devices.spec.ts:250:30

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[16/43]⎯

 FAIL  test/devices.spec.ts > Devices API > sendTestNotification > should return 400 when userId is missing
AssertionError: expected 405 to be 400 // Object.is equality

- Expected
+ Received

- 400
+ 405

 ❯ test/devices.spec.ts:265:31
    263|       const data = await response.json();
    264| 
    265|       expect(response.status).toBe(400);
       |                               ^
    266|       expect(data.error).toBe("userId is required");
    267|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[17/43]⎯

 FAIL  test/devices.spec.ts > Devices API > sendTestNotification > should return 405 for non-POST methods
TypeError: Cannot read properties of undefined (reading 'get')
 ❯ getAllowedOrigin src/util.ts:9:34
      7|  */
      8| function getAllowedOrigin(request: Request): string | null {
      9|   const origin = request.headers.get("Origin");
       |                                  ^
     10|   
     11|   if (!origin) {
 ❯ getCorsHeaders src/util.ts:39:18
 ❯ json src/util.ts:77:28
 ❯ Module.sendTestNotification src/api/devices.ts:410:12
 ❯ test/devices.spec.ts:274:30

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[18/43]⎯

 FAIL  test/devices.spec.ts > Devices API > sendTestNotification > should handle FCM send failures
TypeError: Cannot read properties of undefined (reading 'get')
 ❯ getAllowedOrigin src/util.ts:9:34
      7|  */
      8| function getAllowedOrigin(request: Request): string | null {
      9|   const origin = request.headers.get("Origin");
       |                                  ^
     10|   
     11|   if (!origin) {
 ❯ getCorsHeaders src/util.ts:39:18
 ❯ json src/util.ts:77:28
 ❯ Module.sendTestNotification src/api/devices.ts:410:12
 ❯ test/devices.spec.ts:321:30

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[19/43]⎯

 FAIL  test/get-news.spec.ts > News API > getGeneralNews > should handle API errors gracefully
AssertionError: expected [ { title: 'Apple News', …(7) } ] to deeply equal []

- Expected
+ Received

- []
+ [
+   {
+     "image": "image.jpg",
+     "publishedDate": "2023-10-27 10:00:00",
+     "site": "Source",
+     "symbol": "AAPL",
+     "text": "News text",
+     "title": "Apple News",
+     "type": "news",
+     "url": "https://example.com",
+   },
+ ]

 ❯ test/get-news.spec.ts:68:31
     66| 
     67|             expect(response.status).toBe(200); // Should return empty …
     68|             expect(data.news).toEqual([]);
       |                               ^
     69|         });
     70|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[20/43]⎯

 FAIL  test/get-news.spec.ts > News API > getFavoriteNews > should return news for favorite symbols
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 ❯ test/get-news.spec.ts:108:37
    106|             const data = await response.json();
    107| 
    108|             expect(response.status).toBe(200);
       |                                     ^
    109|             expect(data).toHaveProperty('news');
    110|             expect(Array.isArray(data.news)).toBe(true);

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[21/43]⎯

 FAIL  test/get-news.spec.ts > News API > getFavoriteNews > should return empty list if no favorites
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 ❯ test/get-news.spec.ts:130:37
    128|             const data = await response.json();
    129| 
    130|             expect(response.status).toBe(200);
       |                                     ^
    131|             expect(data.news).toEqual([]);
    132|         });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[22/43]⎯

 FAIL  test/get-news.spec.ts > News API > News Archive > should toggle archived news
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 ❯ test/get-news.spec.ts:174:37
    172|             const data = await response.json();
    173| 
    174|             expect(response.status).toBe(200);
       |                                     ^
    175|             expect(data.bookmarked).toBe(true);
    176|         });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[23/43]⎯

 FAIL  test/get-news.spec.ts > News API > News Archive > should retrieve archived news
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 ❯ test/get-news.spec.ts:204:37
    202|             const data = await response.json();
    203| 
    204|             expect(response.status).toBe(200);
       |                                     ^
    205|             expect(data.news).toHaveLength(1);
    206|             expect(data.news[0].title).toBe('Saved Article');

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[24/43]⎯

 FAIL  test/get-news.spec.ts > News API > User Preferences > should update news favorite symbols
TypeError: (0 , updatePreferences) is not a function
 ❯ test/get-news.spec.ts:241:36
    239| 
    240|             const logger = createMockLogger();
    241|             const response = await updatePreferences(request, env, log…
       |                                    ^
    242|             const data = await response.json();
    243| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[25/43]⎯

 FAIL  test/api/admin.spec.ts > Admin API > getRecentNotifications > should return recent notifications
AssertionError: expected 400 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 400

 ❯ test/api/admin.spec.ts:81:31
     79|       const data = await response.json();
     80| 
     81|       expect(response.status).toBe(200);
       |                               ^
     82|       expect(data.notifications).toHaveLength(2);
     83|       expect(data.notifications[0]).toMatchObject({

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[26/43]⎯

 FAIL  test/api/admin.spec.ts > Admin API > getRecentNotifications > should return empty array when no notifications
AssertionError: expected 400 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 400

 ❯ test/api/admin.spec.ts:111:31
    109|       const data = await response.json();
    110| 
    111|       expect(response.status).toBe(200);
       |                               ^
    112|       expect(data.notifications).toEqual([]);
    113|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[27/43]⎯

 FAIL  test/api/admin.spec.ts > Admin API > getRecentNotifications > should handle database errors
AssertionError: expected 400 to be 500 // Object.is equality

- Expected
+ Received

- 500
+ 400

 ❯ test/api/admin.spec.ts:125:31
    123|       const data = await response.json();
    124| 
    125|       expect(response.status).toBe(500);
       |                               ^
    126|       expect(data.error).toBe("Failed to retrieve recent notifications…
    127|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[28/43]⎯

 FAIL  test/api/admin.spec.ts > Admin API > getRecentNotifications > should limit to 100 notifications
TypeError: Cannot read properties of undefined (reading 'get')
 ❯ authenticateRequest src/auth/middleware.ts:69:38
     67| ): Promise<AuthResult | null> {
     68|   // Try to get token from Authorization header first (mobile app)
     69|   const authHeader = request.headers.get("Authorization");
       |                                      ^
     70|   if (authHeader && authHeader.startsWith("Bearer ")) {
     71|     const token = authHeader.substring(7);
 ❯ authenticateRequestWithAdmin src/auth/middleware.ts:151:22
 ❯ Module.getRecentNotifications src/api/admin.ts:31:22
 ❯ test/api/admin.spec.ts:135:13

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[29/43]⎯

 FAIL  test/api/admin.spec.ts > Admin API > getRecentNotifications > should order by sent_at DESC
TypeError: Cannot read properties of undefined (reading 'get')
 ❯ authenticateRequest src/auth/middleware.ts:69:38
     67| ): Promise<AuthResult | null> {
     68|   // Try to get token from Authorization header first (mobile app)
     69|   const authHeader = request.headers.get("Authorization");
       |                                      ^
     70|   if (authHeader && authHeader.startsWith("Bearer ")) {
     71|     const token = authHeader.substring(7);
 ❯ authenticateRequestWithAdmin src/auth/middleware.ts:151:22
 ❯ Module.getRecentNotifications src/api/admin.ts:31:22
 ❯ test/api/admin.spec.ts:148:13

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[30/43]⎯

 FAIL  test/api/admin.spec.ts > Admin API > getFailedNotifications > should return only failed notifications
AssertionError: expected "spy" to be called with arguments: [ StringContaining{…} ]

Received: 

  1st spy call:

  [
-   StringContaining "WHERE status IN ('failed', 'error')",
+   "SELECT 
+            nl.id, 
+            nl.alert_id, 
+            nl.symbol, 
+            nl.threshold, 
+            nl.price, 
+            nl.direction, 
+            nl.push_token, 
+            nl.status, 
+            nl.error_message, 
+            nl.attempt_count, 
+            nl.sent_at,
+            nl.username
+          FROM notifications_log nl
+          WHERE nl.status IN ('failed', 'error')
+          ORDER BY nl.sent_at DESC
+          LIMIT 100",
  ]


Number of calls: 1

 ❯ Proxy.methodWrapper home/sngvahmed/workspace/stockly/api/node_modules/.vite/vitest/da39a3ee5e6b4b0d3255bfef95601890afd80709/deps_ssr/vitest___@vitest_expect___chai.js:1601:25
 ❯ test/api/admin.spec.ts:200:30
    198|       expect(data.notifications[0].status).toBe("failed");
    199|       expect(data.notifications[1].status).toBe("error");
    200|       expect(mockDb.prepare).toHaveBeenCalledWith(
       |                              ^
    201|         expect.stringContaining("WHERE status IN ('failed', 'error')")
    202|       );

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[31/43]⎯

 FAIL  test/api/admin.spec.ts > Admin API > retryNotification > should retry failed notification successfully
AssertionError: expected 400 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 400

 ❯ test/api/admin.spec.ts:283:31
    281|       const data = await response.json();
    282| 
    283|       expect(response.status).toBe(200);
       |                               ^
    284|       expect(data.success).toBe(true);
    285|       expect(sendFCMNotificationWithLogs).toHaveBeenCalledWith(

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[32/43]⎯

 FAIL  test/api/admin.spec.ts > Admin API > retryNotification > should return 404 when log not found
TypeError: Cannot read properties of undefined (reading 'get')
 ❯ authenticateRequest src/auth/middleware.ts:69:38
     67| ): Promise<AuthResult | null> {
     68|   // Try to get token from Authorization header first (mobile app)
     69|   const authHeader = request.headers.get("Authorization");
       |                                      ^
     70|   if (authHeader && authHeader.startsWith("Bearer ")) {
     71|     const token = authHeader.substring(7);
 ❯ authenticateRequestWithAdmin src/auth/middleware.ts:151:22
 ❯ Module.retryNotification src/api/admin.ts:287:22
 ❯ test/api/admin.spec.ts:302:30

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[33/43]⎯

 FAIL  test/api/admin.spec.ts > Admin API > retryNotification > should handle retry failure
AssertionError: expected 400 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 400

 ❯ test/api/admin.spec.ts:359:31
    357|       const data = await response.json();
    358| 
    359|       expect(response.status).toBe(200);
       |                               ^
    360|       expect(data.success).toBe(false);
    361|       expect(data.errorMessage).toContain("Token invalid");

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[34/43]⎯

 FAIL  test/api/admin.spec.ts > Admin API > retryNotification > should create new log entry with attempt count 1
AssertionError: expected "spy" to be called with arguments: [ StringContaining "retry", …(10) ]

Number of calls: 0

 ❯ Proxy.methodWrapper home/sngvahmed/workspace/stockly/api/node_modules/.vite/vitest/da39a3ee5e6b4b0d3255bfef95601890afd80709/deps_ssr/vitest___@vitest_expect___chai.js:1601:25
 ❯ test/api/admin.spec.ts:417:35
    415| 
    416|       // Should create new log entry with attempt_count = 1 (always st…
    417|       expect(mockInsertStmt.bind).toHaveBeenCalledWith(
       |                                   ^
    418|         expect.stringContaining("retry"),
    419|         mockLog.alert_id,

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[35/43]⎯

 FAIL  test/api/admin.spec.ts > Admin API > retryNotification > should handle database errors during retry
AssertionError: expected 400 to be 500 // Object.is equality

- Expected
+ Received

- 500
+ 400

 ❯ test/api/admin.spec.ts:474:31
    472|       const data = await response.json();
    473| 
    474|       expect(response.status).toBe(500);
       |                               ^
    475|       expect(data.error).toContain("Failed to retry notification");
    476|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[36/43]⎯

 FAIL  test/api/admin.spec.ts > Admin API > retryNotification > should handle FCM send errors
AssertionError: expected 400 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 400

 ❯ test/api/admin.spec.ts:524:31
    522|       // FCM errors are caught and logged, but function returns 200 wi…
    523|       // 500 is only returned for outer exceptions (like database erro…
    524|       expect(response.status).toBe(200);
       |                               ^
    525|       expect(data.success).toBe(false);
    526|       expect(data.errorMessage).toContain("FCM error");

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[37/43]⎯

 FAIL  test/api/edge-cases.spec.ts > Edge Cases and Error Scenarios > Invalid Input Handling > should handle very long symbol list in getStocks
AssertionError: expected [ 200, 400, 413 ] to include 500
 ❯ Proxy.methodWrapper home/sngvahmed/workspace/stockly/api/node_modules/.vite/vitest/da39a3ee5e6b4b0d3255bfef95601890afd80709/deps_ssr/vitest___@vitest_expect___chai.js:1601:25
 ❯ test/api/edge-cases.spec.ts:71:31
     69|       
     70|       // Should either handle it or reject with appropriate error
     71|       expect([200, 400, 413]).toContain(response.status);
       |                               ^
     72|     });
     73| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[38/43]⎯

 FAIL  test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > Parameter validation > validates interval format
AssertionError: expected 500 to be 400 // Object.is equality

- Expected
+ Received

- 400
+ 500

 ❯ test/api/get-historical-intraday.spec.ts:125:33
    123|           createMockLogger()
    124|         );
    125|         expect(response.status).toBe(400);
       |                                 ^
    126|         const data = await response.json();
    127|         expect(data.error).toContain("Invalid interval format");

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[39/43]⎯

 FAIL  test/api/get-historical-intraday.spec.ts > getHistoricalIntraday handler > OHLC aggregation > correctly calculates OHLC values during aggregation
ReferenceError: candle is not defined
 ❯ test/api/get-historical-intraday.spec.ts:441:16
    439|         expect(firstCandle.close).toBeDefined();
    440|         // Volume should be sum of all volumes (6300)
    441|         expect(candle.volume).toBe(6300);
       |                ^
    442|       }
    443|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[40/43]⎯

 FAIL  test/api/push-token.spec.ts > Push Token API > registerPushToken > should register new push token
AssertionError: expected 500 to be 201 // Object.is equality

- Expected
+ Received

- 201
+ 500

 ❯ test/api/push-token.spec.ts:91:31
     89| 
     90|       const response = await registerPushToken(request, mockEnv, mockL…
     91|       expect(response.status).toBe(201);
       |                               ^
     92|       const data = await response.json();
     93|       expect(data.success).toBe(true);

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[41/43]⎯

 FAIL  test/api/push-token.spec.ts > Push Token API > registerPushToken > should update existing push token
AssertionError: expected 500 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 500

 ❯ test/api/push-token.spec.ts:148:31
    146| 
    147|       const response = await registerPushToken(request, mockEnv, mockL…
    148|       expect(response.status).toBe(200);
       |                               ^
    149|       const data = await response.json();
    150|       expect(data.message).toContain("updated");

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[42/43]⎯

 FAIL  test/api/push-token.spec.ts > Push Token API > registerPushToken > should reassign token to new user if different user
AssertionError: expected 500 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 500

 ❯ test/api/push-token.spec.ts:205:31
    203| 
    204|       const response = await registerPushToken(request, mockEnv, mockL…
    205|       expect(response.status).toBe(200);
       |                               ^
    206|       const data = await response.json();
    207|       expect(data.message).toContain("reassigned");

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[43/43]⎯


 Test Files  9 failed | 36 passed (45)
      Tests  42 failed | 450 passed (492)
   Start at  20:33:54
   Duration  23.14s (transform 4.09s, setup 0ms, collect 50.24s, tests 45.02s, environment 6ms, prepare 59.94s)

JSON report written to /home/sngvahmed/workspace/stockly/api/test-results/results.json
JUNIT report written to /home/sngvahmed/workspace/stockly/api/test-results/junit.xml
[vpw:debug] Shutting down runtimes...
